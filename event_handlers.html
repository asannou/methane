<script>
    // 4. Core Logic / Event Handlers
    const Handlers = {
        /**
         * Initialize tab navigation functionality.
         */
        initTabNavigation: () => {
            const tabs = document.querySelectorAll('.tabs li');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    tabs.forEach(item => item.classList.remove('is-active'));
                    this.classList.add('is-active');

                    const targetId = this.dataset.tabContentId;
                    tabContents.forEach(content => {
                        if (content.id === targetId) {
                            content.classList.add('is-active-content');
                        } else {
                            content.classList.remove('is-active-content');
                        }
                    });
                });
            });

            // Initially activate the first tab
            if (tabs.length > 0) {
                tabs[0].click();
            }
        },

        /**
         * Common function to reset AI operation related UI.
         */
        resetAiOperationUI: () => {
            AppState.activeRequestId = null;
            UI.hideSpinnerInButton(UI.get('generatePolicyButton'));
            UI.hideSpinnerInButton(UI.get('acceptPolicyButton'));
            UI.hideSpinnerInButton(UI.get('regeneratePolicyButton'));
            UI.hideSpinnerInButton(UI.get('regenerateProposalButton'));
            UI.hideSpinnerInButton(UI.get('applyChangesNoDeployButton'));
            UI.hideSpinnerInButton(UI.get('applyAndDeployButton'));
            UI.hideSpinnerInButton(UI.get('fixApplyErrorsButton'));
            UI.hideSpinnerInButton(UI.get('fixErrorsButton'));

            UI.enable('prompt');
            UI.hide('cancelAiOperationButton');
            UI.hide('cancelFixErrorsButton');

            AppState.currentPolicyData = null;
            AppState.currentProposal = null;
            UI.setHtml('aiPolicy', '');
            UI.setText('proposalPurpose', '');
            UI.setHtml('proposedFilesDisplay', '');
            UI.setHtml('applyResultContent', '');
            UI.hide('htmlValidationWarnings');
            UI.setHtml('htmlValidationWarnings', '');

            UI.hide('policyContainer');
            UI.hide('proposalContainer');
            UI.hide('acceptPolicyButton');
            UI.hide('regenerateProposalButton');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('applyResultContainer');
            UI.hide('fixApplyErrorsButton');

            UI.show('generatePolicyButton');
            UI.hide('regeneratePolicyButton');

            UI.hide('policyEditor');
            UI.setText('togglePolicyEditButton', 'Edit Policy');
            AppState.isPolicyEditing = false;
        },

        /**
         * Handle submit for the agent form (Generate Policy).
         * @param {Event} e - The submit event.
         */
        handleAgentFormSubmit: (e) => {
            e.preventDefault();
            const submitterId = e.submitter.id;

            const scriptId = Utils.getEffectiveScriptId();
            const promptText = UI.get('prompt').value;

            if (!scriptId) {
                alert('Please select or enter a Script ID.');
                return;
            }
            if (!promptText.trim()) {
                alert('Prompt cannot be empty.');
                return;
            }

            Utils.saveScriptIdToLocalStorage(scriptId);

            if (submitterId === 'generatePolicyButton') {
                UI.showSpinnerInButton(UI.get('generatePolicyButton'), 'Generating Policy...');
                UI.hide('regeneratePolicyButton');
            } else {
                console.error("Unknown submitter for agent-form:", submitterId);
                return;
            }

            UI.disable('prompt');
            UI.show('cancelAiOperationButton');
            UI.hide('acceptPolicyButton');
            UI.hide('regenerateProposalButton');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('policyContainer');
            UI.hide('proposalContainer');
            UI.hide('applyResultContainer');
            UI.hide('fixApplyErrorsButton');
            UI.setHtml('proposedFilesDisplay', '');
            UI.setHtml('aiPolicy', '');
            UI.hide('htmlValidationWarnings');
            UI.setHtml('htmlValidationWarnings', '');
            UI.hide('versionResultContainer');
            UI.hide('policyEditor');
            UI.setText('togglePolicyEditButton', 'Edit Policy');
            AppState.isPolicyEditing = false;
            UI.setHtml('applyResultContent', '');

            const formData = { scriptId: scriptId, prompt: promptText };

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            console.log('Generating policy...');
            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for generateProposalPolicy.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('generatePolicyButton'));
                    UI.hide('cancelAiOperationButton');
                    UI.enable('prompt');

                    if (response.status === 'policy') {
                        AppState.currentPolicyData = response;
                        UI.setHtml('aiPolicy', marked.parse(response.policy));
                        UI.show('policyContainer');
                        UI.show('acceptPolicyButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    } else if (response.status === 'unachievable') { /* NEW CONDITION FOR UNACHIEVABLE */
                        AppState.currentPolicyData = null; /* Clear policy data as it's not usable */
                        UI.setHtml('aiPolicy', `<div class="notification is-warning is-light"><strong>AI Policy Generation Status: UNACHIEVABLE</strong><br>${Utils.escapeHtml(response.message)}</div>`);
                        UI.show('policyContainer');
                        /* Disable further action buttons */
                        UI.hide('acceptPolicyButton');
                        UI.hide('regenerateProposalButton');
                        UI.hide('regeneratePolicyButton'); /* Hide this as the previous policy was unachievable. User needs to generate a *new* policy (from generatePolicyButton) */
                        UI.show('generatePolicyButton'); /* Allow user to try again with a new prompt */
                        UI.appendNotification('applyResultContent', 'is-warning', 'AI Policy Generation Failed', response.message);
                        UI.show('applyResultContainer');
                    } else if (response.status === 'error') {
                        UI.setText('aiPolicy', 'Error: ' + response.message);
                        UI.show('policyContainer');
                        UI.enable('prompt');
                        UI.show('generatePolicyButton');
                        UI.hide('regeneratePolicyButton');
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for generateProposalPolicy.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('generatePolicyButton'));
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');
                    UI.setText('aiPolicy', 'Error generating policy: ' + error.message);
                    UI.show('policyContainer');
                    UI.show('generatePolicyButton');
                    UI.hide('regeneratePolicyButton');
                })
                .generateProposalPolicy(formData);
        },

        /**
         * Handle toggling the policy edit mode.
         */
        handleTogglePolicyEdit: () => {
            const aiPolicyDiv = UI.get('aiPolicy');
            const policyEditorTextarea = UI.get('policyEditor');
            const toggleButton = UI.get('togglePolicyEditButton');

            if (AppState.isPolicyEditing) {
                AppState.currentPolicyData.policy = policyEditorTextarea.value;
                UI.setHtml('aiPolicy', marked.parse(AppState.currentPolicyData.policy));
                UI.show('aiPolicy');
                UI.hide('policyEditor');
                UI.setText('togglePolicyEditButton', 'Finish Editing');
                UI.enable('prompt');
            } else {
                if (!AppState.currentPolicyData || !AppState.currentPolicyData.policy) {
                    alert('No policy to edit. Please generate a policy first.');
                    return;
                }
                UI.get('policyEditor').value = AppState.currentPolicyData.policy;
                UI.hide('aiPolicy');
                UI.show('policyEditor');
                UI.setText('togglePolicyEditButton', 'Finish Editing');
                UI.enable('prompt');
                UI.get('policyEditor').focus();
            }
            AppState.isPolicyEditing = !AppState.isPolicyEditing;
        },

        /**
         * Handle accepting the generated policy and generating proposed changes.
         */
        handleAcceptPolicy: () => {
            if (!AppState.currentPolicyData) {
                alert('No policy to accept. Please generate a policy first.');
                return;
            }

            UI.showSpinnerInButton(UI.get('acceptPolicyButton'), 'Proposing Changes...');
            UI.hide('regeneratePolicyButton');
            UI.hide('generatePolicyButton');
            UI.hide('regenerateProposalButton');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.show('cancelAiOperationButton');
            UI.disable('prompt');
            
            UI.hide('policyEditor');
            UI.setText('togglePolicyEditButton', 'Edit Policy');
            AppState.isPolicyEditing = false;
            UI.setHtml('applyResultContent', '');

            const formData = { scriptId: AppState.currentPolicyData.scriptId, prompt: AppState.currentPolicyData.userPrompt, policy: AppState.currentPolicyData.policy };

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            console.log('Generating code proposal...');
            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for processPrompt (after policy).');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('acceptPolicyButton'));
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');

                    if (response.status === 'proposal') {
                        AppState.currentProposal = response;
                        UI.setText('proposalPurpose', response.purpose || 'No description provided.');
                        
                        UI.setHtml('htmlValidationWarnings', '');
                        let hasHtmlErrors = false;

                        response.proposedFiles.forEach(file => {
                            if (file.type === 'HTML') {
                                const validationResult = Utils.validateHtml(file.source, file.name);
                                if (!validationResult.isValid) {
                                    hasHtmlErrors = true;
                                    const warningP = document.createElement('p');
                                    warningP.textContent = validationResult.message;
                                    UI.get('htmlValidationWarnings').appendChild(warningP);
                                }
                            }
                        });

                        if (hasHtmlErrors) {
                            UI.show('htmlValidationWarnings');
                        } else {
                            UI.hide('htmlValidationWarnings');
                        }

                        Utils.displayFileComparison(response.originalFiles, response.proposedFiles);
                        UI.show('proposalContainer');
                        UI.show('applyChangesNoDeployButton');
                        UI.show('applyAndDeployButton');
                        UI.show('regenerateProposalButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    } else if (response.status === 'error') {
                        UI.appendNotification('applyResultContent', 'is-danger', 'Failed to generate proposal.', response.message);
                        UI.show('applyResultContainer');
                        UI.show('proposalContainer');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    } else {
                        UI.appendNotification('applyResultContent', 'is-warning', 'Unexpected response status:', response);
                        UI.show('applyResultContainer');
                        UI.show('proposalContainer');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for processPrompt (after policy).');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('acceptPolicyButton'));
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');

                    UI.appendNotification('applyResultContent', 'is-danger', 'Error calling AI:', error.message);
                    UI.show('applyResultContainer');
                    UI.show('proposalContainer');
                    UI.show('regeneratePolicyButton');
                    UI.hide('generatePolicyButton');
                })
                .processPrompt(formData);
        },

        /**
         * Handle canceling any active AI operation.
         */
        handleCancelAiOperation: () => {
            Handlers.resetAiOperationUI();
            alert('AI operation canceled by user.');
        },

        /**
         * Handle regenerating the AI policy.
         */
        handleRegeneratePolicy: () => {
            const scriptId = Utils.getEffectiveScriptId();
            const promptText = UI.get('prompt').value;

            if (!scriptId) {
                alert('Please select or enter a Script ID.');
                return;
            }
            if (!promptText.trim()) {
                alert('Prompt cannot be empty.');
                return;
            }

            Utils.saveScriptIdToLocalStorage(scriptId);

            UI.showSpinnerInButton(UI.get('regeneratePolicyButton'), 'Regenerating Policy...');
            UI.hide('generatePolicyButton');
            UI.hide('acceptPolicyButton');
            
            UI.disable('prompt');
            UI.show('cancelAiOperationButton');

            UI.hide('policyContainer');
            UI.hide('proposalContainer');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('regenerateProposalButton');
            UI.hide('applyResultContainer');
            UI.hide('fixApplyErrorsButton');
            UI.setHtml('proposedFilesDisplay', '');
            UI.setHtml('aiPolicy', '');
            UI.setText('proposalPurpose', '');
            UI.hide('htmlValidationWarnings');
            UI.setHtml('htmlValidationWarnings', '');
            UI.hide('policyEditor');
            UI.setText('togglePolicyEditButton', 'Edit Policy');
            AppState.isPolicyEditing = false;
            UI.setHtml('applyResultContent', '');

            AppState.currentPolicyData = null;
            AppState.currentProposal = null;

            const formData = { scriptId: scriptId, prompt: promptText };

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            console.log('Regenerating policy...');
            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for regeneratePolicy.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('regeneratePolicyButton'));
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');

                    if (response.status === 'policy') {
                        AppState.currentPolicyData = response;
                        UI.setHtml('aiPolicy', marked.parse(response.policy));
                        UI.show('policyContainer');
                        UI.show('acceptPolicyButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    } else if (response.status === 'unachievable') { /* NEW CONDITION FOR UNACHIEVABLE IN REGENERATE */
                        AppState.currentPolicyData = null;
                        UI.setHtml('aiPolicy', `<div class="notification is-warning is-light"><strong>AI Policy Generation Status: UNACHIEVABLE</strong><br>${Utils.escapeHtml(response.message)}</div>`);
                        UI.show('policyContainer');
                        UI.hide('acceptPolicyButton');
                        UI.hide('regenerateProposalButton');
                        UI.hide('regeneratePolicyButton'); /* User should use "Generate Policy" for a new attempt */
                        UI.show('generatePolicyButton');
                        UI.appendNotification('applyResultContent', 'is-warning', 'AI Policy Generation Failed', response.message);
                        UI.show('applyResultContainer');
                    } else if (response.status === 'error') {
                        UI.setText('aiPolicy', 'Error: ' + response.message);
                        UI.show('policyContainer');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for regeneratePolicy.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('regeneratePolicyButton'));
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');

                    UI.setText('aiPolicy', 'Error regenerating policy: ' + error.message);
                    UI.show('policyContainer');
                    UI.show('regeneratePolicyButton');
                    UI.hide('generatePolicyButton');
                })
                .generateProposalPolicy(formData);
        },

        /**
         * Handle applying proposed changes to the script.
         * @param {boolean} autoDeploy - Whether to automatically deploy after applying changes.
         * @param {HTMLElement} clickedButton - The button element that was clicked.
         */
        handleApplyChanges: (autoDeploy, clickedButton) => {
            if (!AppState.currentProposal) {
                UI.appendNotification('applyResultContent', 'is-danger', 'No proposal to apply.');
                UI.show('applyResultContainer');
                return;
            }

            Utils.saveScriptIdToLocalStorage(AppState.currentProposal.scriptId);

            UI.showSpinnerInButton(clickedButton, autoDeploy ? 'Applying & Deploying...' : 'Applying Changes...');
            
            // Disable other related buttons
            if (clickedButton.id === 'applyChangesNoDeployButton') {
                UI.disable('applyAndDeployButton');
            } else {
                UI.disable('applyChangesNoDeployButton');
            }
            UI.disable('regenerateProposalButton');
            UI.disable('fixApplyErrorsButton');

            UI.hide('fixApplyErrorsButton');
            UI.setHtml('applyResultContent', `
                <div class="notification is-info is-light">
                <p>Applying changes...</p>
                ${autoDeploy ? '<p>Auto-deploying...</p>' : ''}
                </div>
            `);
            UI.show('applyResultContainer');

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(clickedButton);
                    UI.enable('applyChangesNoDeployButton');
                    UI.enable('applyAndDeployButton');
                    UI.enable('regenerateProposalButton');
                    UI.enable('fixApplyErrorsButton');
                    UI.setHtml('applyResultContent', '');

                    if (response.status === 'success') {
                        UI.appendNotification('applyResultContent', 'is-success', Utils.escapeHtml(response.message));

                        if (autoDeploy) {
                            const deployMessageContainer = document.createElement('article');
                            deployMessageContainer.className = 'message mt-3';

                            let headerText = 'Auto-deploy Result';
                            let messageBodyContent = '';
                            let messageClass = '';

                            if (response.deploymentStatus === 'success') {
                                messageClass = 'is-success';
                                headerText += ' (Success)';
                                messageBodyContent += `
                                    <ul>
                                    <li><strong>Status:</strong> Success</li>
                                    <li><strong>Message:</strong> ${Utils.escapeHtml(response.deploymentMessage)}</li>
                                `;
                                if (response.deploymentId) {
                                    messageBodyContent += `<li><strong>Deployment ID:</strong> ${Utils.escapeHtml(response.deploymentId)}</li>`;
                                }
                                if (response.webappUrl && response.webappUrl !== 'null') {
                                    messageBodyContent += `<li><strong>Web App URL:</strong> <a href="${Utils.escapeHtml(response.webappUrl)}" target="_blank">${Utils.escapeHtml(response.webappUrl)}</a></li>`;
                                } else if (response.webappUrl === null) {
                                    messageBodyContent += `<li><strong>Web App URL:</strong> Not found in deployment response.</li>`;
                                }
                                messageBodyContent += `</ul>`;
                            } else if (response.deploymentStatus === 'error') {
                                messageClass = 'is-danger';
                                headerText += ' (Error)';
                                messageBodyContent += `
                                    <ul>
                                    <li><strong>Status:</strong> Error</li>
                                    <li><strong>Message:</strong> ${Utils.escapeHtml(response.deploymentMessage)}</li>
                                `;
                                if (response.deploymentId) {
                                    messageBodyContent += `<li><strong>Deployment ID:</strong> ${Utils.escapeHtml(response.deploymentId)}</li>`;
                                }
                                messageBodyContent += `</ul>`;
                            } else {
                                messageClass = 'is-warning';
                                headerText += ' (Unknown Status)';
                                messageBodyContent += `
                                    <ul>
                                    <li><strong>Status:</strong> Unknown</li>
                                    <li><strong>Message:</strong> ${Utils.escapeHtml(response.deploymentMessage)}</li>
                                    </ul>
                                `;
                            }
                            
                            deployMessageContainer.classList.add(messageClass);
                            deployMessageContainer.innerHTML = `
                                <div class="message-header">
                                <p>${headerText}</p>
                                </div>
                                <div class="message-body">
                                ${messageBodyContent}
                                </div>
                            `;
                            UI.get('applyResultContent').appendChild(deployMessageContainer);
                        }

                        AppState.currentProposal = null;
                        UI.hide('applyChangesNoDeployButton');
                        UI.hide('applyAndDeployButton');
                        UI.hide('regenerateProposalButton');
                        UI.setHtml('proposedFilesDisplay', '<p>Changes applied successfully. You can propose new changes or check logs.</p>');
                        UI.hide('htmlValidationWarnings');
                        UI.setHtml('htmlValidationWarnings', '');
                        UI.hide('fixApplyErrorsButton');
                    } else {
                        UI.appendNotification('applyResultContent', 'is-danger', `Failed to Apply Changes: ${Utils.escapeHtml(response.message)}`, response.apiErrorDetails || response.fullErrorText);
                        UI.show('fixApplyErrorsButton');
                    }
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(clickedButton);
                    UI.enable('applyChangesNoDeployButton');
                    UI.enable('applyAndDeployButton');
                    UI.enable('regenerateProposalButton');
                    UI.enable('fixApplyErrorsButton');
                    UI.appendNotification('applyResultContent', 'is-danger', 'Error applying changes (Uncaught):', error.message);
                    UI.show('fixApplyErrorsButton');
                })
                .applyProposedChanges(AppState.currentProposal.scriptId, AppState.currentProposal.proposedFiles, autoDeploy, AppState.currentProposal.purpose);
        },

        /**
         * Handle regenerating the AI proposal.
         */
        handleRegenerateProposal: () => {
            if (!AppState.currentPolicyData || !AppState.currentPolicyData.scriptId || !AppState.currentPolicyData.userPrompt || !AppState.currentPolicyData.policy) {
                alert('Cannot regenerate proposal. Policy data is missing.');
                return;
            }

            const scriptId = AppState.currentPolicyData.scriptId;
            const promptText = AppState.currentPolicyData.userPrompt;
            const policyText = AppState.currentPolicyData.policy;

            UI.showSpinnerInButton(UI.get('regenerateProposalButton'), 'Regenerating Proposal...');
            UI.disable('applyChangesNoDeployButton');
            UI.disable('applyAndDeployButton');
            UI.disable('prompt');
            UI.show('cancelAiOperationButton');

            UI.hide('proposalContainer');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('applyResultContainer');
            UI.hide('fixApplyErrorsButton');
            UI.setHtml('proposedFilesDisplay', '');
            UI.setText('proposalPurpose', '');
            UI.setHtml('applyResultContent', '');
            UI.hide('htmlValidationWarnings');
            UI.setHtml('htmlValidationWarnings', '');

            AppState.currentProposal = null;

            const formData = { scriptId: scriptId, prompt: promptText, policy: policyText };

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            console.log('Regenerating AI proposed changes...');
            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for regenerateProposal.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('regenerateProposalButton'));
                    UI.enable('applyChangesNoDeployButton');
                    UI.enable('applyAndDeployButton');
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');

                    if (response.status === 'proposal') {
                        AppState.currentProposal = response;
                        UI.setText('proposalPurpose', response.purpose || 'No description provided.');
                        
                        UI.setHtml('htmlValidationWarnings', '');
                        let hasHtmlErrors = false;

                        response.proposedFiles.forEach(file => {
                            if (file.type === 'HTML') {
                                const validationResult = Utils.validateHtml(file.source, file.name);
                                if (!validationResult.isValid) {
                                    hasHtmlErrors = true;
                                    const warningP = document.createElement('p');
                                    warningP.textContent = validationResult.message;
                                    UI.get('htmlValidationWarnings').appendChild(warningP);
                                }
                            }
                        });

                        if (hasHtmlErrors) {
                            UI.show('htmlValidationWarnings');
                        } else {
                            UI.hide('htmlValidationWarnings');
                        }

                        Utils.displayFileComparison(response.originalFiles, response.proposedFiles);
                        UI.show('proposalContainer');
                        UI.show('applyChangesNoDeployButton');
                        UI.show('applyAndDeployButton');
                        UI.show('regenerateProposalButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    } else if (response.status === 'error') {
                        UI.appendNotification('applyResultContent', 'is-danger', 'Failed to regenerate proposal.', response.message);
                        UI.show('applyResultContainer');
                        UI.show('proposalContainer');
                        UI.show('regenerateProposalButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    } else {
                        UI.appendNotification('applyResultContent', 'is-warning', 'Unexpected response status:', response);
                        UI.show('applyResultContainer');
                        UI.show('proposalContainer');
                        UI.show('regenerateProposalButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for regenerateProposal.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('regenerateProposalButton'));
                    UI.enable('applyChangesNoDeployButton');
                    UI.enable('applyAndDeployButton');
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');

                    UI.appendNotification('applyResultContent', 'is-danger', 'Error regenerating proposal:', error.message);
                    UI.show('applyResultContainer');
                    UI.show('proposalContainer');
                    UI.show('regenerateProposalButton');
                    UI.show('regeneratePolicyButton');
                    UI.hide('generatePolicyButton');
                })
                .processPrompt(formData);
        },

        /**
         * Handle fixing apply errors using AI.
         */
        handleFixApplyErrors: () => {
            const scriptId = Utils.getEffectiveScriptId();
            if (!scriptId) {
                UI.appendNotification('applyResultContent', 'is-danger', 'Script ID is required to fix errors.');
                UI.show('applyResultContainer');
                return;
            }

            UI.showSpinnerInButton(UI.get('fixApplyErrorsButton'), 'Fixing Errors...');
            UI.hide('generatePolicyButton');
            UI.hide('regeneratePolicyButton');
            UI.disable('prompt');
            UI.show('cancelFixErrorsButton');
            UI.hide('regenerateProposalButton');
            UI.hide('proposalContainer');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('applyResultContainer');
            UI.setHtml('applyResultContent', '');
            UI.setHtml('proposedFilesDisplay', '');
            UI.hide('htmlValidationWarnings');
            UI.setHtml('htmlValidationWarnings', '');

            Utils.saveScriptIdToLocalStorage(scriptId);

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for fixErrorsFromLogs.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('fixApplyErrorsButton'));
                    UI.enable('prompt');
                    UI.hide('cancelFixErrorsButton');

                    if (response.status === 'proposal') {
                        AppState.currentProposal = response;
                        UI.setText('proposalPurpose', response.purpose || 'No description provided.');
                        
                        UI.setHtml('htmlValidationWarnings', '');
                        let hasHtmlErrors = false;

                        response.proposedFiles.forEach(file => {
                            if (file.type === 'HTML') {
                                const validationResult = Utils.validateHtml(file.source, file.name);
                                if (!validationResult.isValid) {
                                    hasHtmlErrors = true;
                                    const warningP = document.createElement('p');
                                    warningP.textContent = validationResult.message;
                                    UI.get('htmlValidationWarnings').appendChild(warningP);
                                }
                            }
                        });

                        if (hasHtmlErrors) {
                            UI.show('htmlValidationWarnings');
                        }

                        Utils.displayFileComparison(response.originalFiles, response.proposedFiles);
                        UI.show('proposalContainer');
                        UI.show('applyChangesNoDeployButton');
                        UI.show('applyAndDeployButton');
                        UI.show('regenerateProposalButton');
                        UI.hide('fixApplyErrorsButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    } else if (response.status === 'error') {
                        UI.appendNotification('applyResultContent', 'is-danger', 'Failed to get error fix proposal.', response.message);
                        UI.show('applyResultContainer');
                        UI.show('proposalContainer');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    } else {
                        UI.appendNotification('applyResultContent', 'is-warning', 'Unexpected response status:', response);
                        UI.show('applyResultContainer');
                        UI.show('proposalContainer');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for fixErrorsFromLogs.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('fixApplyErrorsButton'));
                    UI.enable('prompt');
                    UI.hide('cancelFixErrorsButton');

                    UI.appendNotification('applyResultContent', 'is-danger', 'Error calling AI for fix:', error.message);
                    UI.show('applyResultContainer');
                    UI.show('proposalContainer');
                    UI.show('regeneratePolicyButton');
                    UI.hide('generatePolicyButton');
                })
                .fixErrorsFromLogs(scriptId);
        },

        /**
         * Handle submit for the fix errors form.
         * @param {Event} e - The submit event.
         */
        handleFixErrorsFormSubmit: (e) => {
            e.preventDefault();

            const scriptId = Utils.getEffectiveScriptId();
            if (!scriptId) {
                UI.appendNotification('applyResultContent', 'is-danger', 'Script ID is required to fix errors.');
                UI.show('applyResultContainer');
                return;
            }

            UI.showSpinnerInButton(UI.get('fixErrorsButton'), 'Fixing Errors...');
            UI.hide('generatePolicyButton');
            UI.hide('regeneratePolicyButton');
            UI.disable('prompt');
            UI.show('cancelFixErrorsButton');
            UI.hide('regenerateProposalButton');
            UI.hide('proposalContainer');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('applyResultContainer');
            UI.hide('fixApplyErrorsButton');
            UI.setHtml('proposedFilesDisplay', '');
            UI.setText('proposalPurpose', '');
            UI.setHtml('applyResultContent', '');
            UI.hide('htmlValidationWarnings');
            UI.setHtml('htmlValidationWarnings', '');

            Utils.saveScriptIdToLocalStorage(scriptId);

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for fixErrorsFromLogs (via form submit).');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('fixErrorsButton'));
                    UI.enable('prompt');
                    UI.hide('cancelFixErrorsButton');

                    if (response.status === 'proposal') {
                        AppState.currentProposal = response;
                        UI.setText('proposalPurpose', response.purpose || 'No description provided.');
                        
                        UI.setHtml('htmlValidationWarnings', '');
                        let hasHtmlErrors = false;

                        response.proposedFiles.forEach(file => {
                            if (file.type === 'HTML') {
                                const validationResult = Utils.validateHtml(file.source, file.name);
                                if (!validationResult.isValid) {
                                    hasHtmlErrors = true;
                                    const warningP = document.createElement('p');
                                    warningP.textContent = validationResult.message;
                                    UI.get('htmlValidationWarnings').appendChild(warningP);
                                }
                            }
                        });

                        if (hasHtmlErrors) {
                            UI.show('htmlValidationWarnings');
                        }

                        Utils.displayFileComparison(response.originalFiles, response.proposedFiles);
                        UI.show('proposalContainer');
                        UI.show('applyChangesNoDeployButton');
                        UI.show('applyAndDeployButton');
                        UI.show('regenerateProposalButton');
                        UI.hide('fixApplyErrorsButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    } else if (response.status === 'error') {
                        UI.appendNotification('applyResultContent', 'is-danger', 'Failed to get error fix proposal.', response.message);
                        UI.show('applyResultContainer');
                        UI.show('proposalContainer');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    } else {
                        UI.appendNotification('applyResultContent', 'is-warning', 'Unexpected response status:', response);
                        UI.show('applyResultContainer');
                        UI.show('proposalContainer');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for fixErrorsFromLogs (via form submit).');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('fixErrorsButton'));
                    UI.enable('prompt');
                    UI.hide('cancelFixErrorsButton');

                    UI.appendNotification('applyResultContent', 'is-danger', 'Error calling AI for fix:', error.message);
                    UI.show('applyResultContainer');
                    UI.show('proposalContainer');
                    UI.show('regeneratePolicyButton');
                    UI.hide('generatePolicyButton');
                })
                .fixErrorsFromLogs(scriptId);
        },

        /**
         * Handle saving the GCP Project ID.
         */
        handleSaveGcpProjectId: () => {
            const gcpProjectId = UI.get('gcpProjectId').value.trim();
            const saveButton = UI.get('saveGcpProjectIdButton');

            UI.show('gcpSaveResultContainer');
            UI.setText('gcpSaveResult', 'Saving...');
            UI.showSpinnerInButton(saveButton, 'Saving...');

            if (!gcpProjectId) {
                UI.setText('gcpSaveResult', 'Error: GCP Project ID cannot be empty.');
                UI.show('gcpSaveResultContainer');
                UI.hideSpinnerInButton(saveButton);
                return;
            }

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.setText('gcpSaveResult', response.message);
                    UI.hideSpinnerInButton(saveButton);
                    if (response.status === 'success') {
                        Utils.saveGcpProjectIdToLocalStorage(gcpProjectId);
                    }
                })
                .withFailureHandler(function(error) {
                    UI.setText('gcpSaveResult', 'Error saving GCP Project ID: ' + error.message);
                    UI.hideSpinnerInButton(saveButton);
                })
                .setGcpProjectId(gcpProjectId);
        },

        /**
         * Handle submit for the log retrieval form.
         * @param {Event} e - The submit event.
         */
        handleLogFormSubmit: (e) => {
            e.preventDefault();
            const submitButton = UI.get('getLogsButton');

            UI.showSpinnerInButton(submitButton, 'Getting Logs...');
            UI.hide('logResultContainer');
            UI.setText('logResult', '');

            const scriptId = Utils.getEffectiveScriptId();
            Utils.saveScriptIdToLocalStorage(scriptId);

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(submitButton);
                    UI.setText('logResult', response);
                    UI.show('logResultContainer');
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(submitButton);
                    UI.setText('logResult', 'Error: ' + error.message);
                    UI.show('logResultContainer');
                })
                .getScriptLogs(scriptId);
        },

        /**
         * Handle submit for the deploy form.
         * @param {Event} e - The submit event.
         */
        handleDeployFormSubmit: (e) => {
            e.preventDefault();
            const submitButton = UI.get('deployButton');

            UI.showSpinnerInButton(submitButton, 'Deploying...');
            UI.hide('deployResultContainer');
            UI.setText('deployResult', '');

            const scriptId = Utils.getEffectiveScriptId();
            const description = UI.get('deploymentDescription').value;
            Utils.saveScriptIdToLocalStorage(scriptId);

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(submitButton);
                    UI.show('deployResultContainer');
                    if (response.status === 'success') {
                        let webappUrlHtml = `Web App URL: ${response.webappUrl}`;
                        if (response.webappUrl && response.webappUrl !== 'null') {
                            webappUrlHtml = `Web App URL: <a href="${response.webappUrl}" target="_blank">${response.webappUrl}</a>`;
                        } else if (response.webappUrl === null) {
                            webappUrlHtml = `Web App URL: Not found in deployment response.`;
                        }
                        UI.setHtml('deployResult', `${response.message}<br>Deployment ID: ${response.deploymentId}<br>${webappUrlHtml}`);
                    } else {
                        UI.setText('deployResult', `Error: ${response.message}`);
                    }
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(submitButton);
                    UI.show('deployResultContainer');
                    UI.setText('deployResult', `Error deploying script: ${error.message}`);
                })
                .deployScript(scriptId, description);
        },

        /**
         * Handle submit for the add library form.
         * @param {Event} e - The submit event.
         */
        handleAddLibraryFormSubmit: (e) => {
            e.preventDefault();
            const submitButton = UI.get('addLibraryButton');

            UI.showSpinnerInButton(submitButton, 'Adding Library...');
            UI.hide('addLibraryResultContainer');
            UI.setText('addLibraryResult', '');

            const targetScriptId = Utils.getEffectiveScriptId();
            const libraryScriptId = UI.get('libraryScriptId').value.trim();
            const libraryVersion = UI.get('libraryVersion').value.trim();

            if (!targetScriptId) {
                UI.setText('addLibraryResult', 'Error: Please select or enter a Target Script ID.');
                UI.show('addLibraryResultContainer');
                UI.hideSpinnerInButton(submitButton);
                return;
            }
            if (!libraryScriptId) {
                UI.setText('addLibraryResult', 'Error: Library Script ID cannot be empty.');
                UI.show('addLibraryResultContainer');
                UI.hideSpinnerInButton(submitButton);
                return;
            }

            Utils.saveScriptIdToLocalStorage(targetScriptId);

            const effectiveVersion = libraryVersion.trim() === '' ? 'HEAD' : libraryVersion.trim();

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(submitButton);
                    UI.show('addLibraryResultContainer');
                    if (response.status === 'success') {
                        UI.setText('addLibraryResult', response.message);
                        UI.clearValue('libraryScriptId');
                        UI.clearValue('libraryVersion');
                    }
                    else {
                        UI.setText('addLibraryResult', `Error: ${response.message}`);
                    }
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(submitButton);
                    UI.show('addLibraryResultContainer');
                    UI.setText('addLibraryResult', `Error adding library: ${error.message}`);
                })
                .addLibraryToProject(targetScriptId, libraryScriptId, effectiveVersion);
        },

        /**
         * Handle getting script versions.
         */
        handleGetVersions: () => {
            const scriptId = Utils.getEffectiveScriptId();
            const versionsSelect = UI.get('versionSelect');
            const getVersionsButton = UI.get('getVersionsButton');
            
            UI.setHtml('versionSelect', '<option value="">-- Loading versions --</option>');
            UI.disable('versionSelect');
            UI.showSpinnerInButton(getVersionsButton, 'Getting Versions...');
            UI.disable('revertVersionButton');
            UI.disable('openWebAppButton');
            UI.setText('openWebAppMessage', '');
            UI.hide('versionResultContainer');

            if (!scriptId) {
                UI.setHtml('versionSelect', '<option value="">-- Select a Script ID first --</option>');
                UI.setText('versionResult', 'Error: Please select or enter a Script ID to get versions.');
                UI.show('versionResultContainer');
                UI.enable('versionSelect');
                UI.hideSpinnerInButton(getVersionsButton);
                return;
            }

            Utils.saveScriptIdToLocalStorage(scriptId);

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(getVersionsButton);
                    UI.enable('versionSelect');

                    if (response.status === 'success') {
                        UI.setHtml('versionSelect', '<option value="">-- Select a version --</option>');
                        if (response.versions && response.versions.length > 0) {
                            response.versions.forEach(version => {
                                const option = document.createElement('option');
                                option.value = version.versionNumber;
                                option.textContent = `Version ${version.versionNumber} (Created: ${new Date(version.createTime).toLocaleString()}) - ${version.description}`;
                                if (version.webappUrl !== null) {
                                    option.dataset.webappUrl = version.webappUrl;
                                } else {
                                    option.dataset.webappUrl = 'null';
                                }
                                versionsSelect.appendChild(option);
                            });
                            UI.setText('versionResult', `Versions found: ${response.versions.length} items`);
                        } else {
                            UI.setHtml('versionSelect', '<option value="">-- No versions found --</option>');
                            UI.setText('versionResult', response.message);
                        }
                        versionsSelect.dispatchEvent(new Event('change'));
                    }
                    else {
                        UI.setHtml('versionSelect', '<option value="">-- Error loading versions --</option>');
                        UI.setText('versionResult', `Error: ${response.message}`);
                        UI.disable('openWebAppButton');
                        UI.disable('revertVersionButton');
                        UI.setText('openWebAppMessage', '');
                    }
                    UI.show('versionResultContainer');
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(getVersionsButton);
                    UI.enable('versionSelect');
                    UI.disable('revertVersionButton');
                    UI.disable('openWebAppButton');
                    UI.setText('openWebAppMessage', '');
                    UI.setHtml('versionSelect', '<option value="">-- Error loading versions --</option>');
                    UI.setText('versionResult', `Error getting versions: ${error.message}`);
                    UI.show('versionResultContainer');
                })
                .listScriptVersions(scriptId);
        },

        /**
         * Handle change event for the version select dropdown.
         */
        handleVersionSelectChange: () => {
            const versionsSelect = UI.get('versionSelect');
            const selectedOption = versionsSelect.options[versionsSelect.selectedIndex];

            // Enable/disable revert button based on selection
            UI.get('revertVersionButton').disabled = !selectedOption.value;

            // Enable/disable open web app button based on webappUrl in dataset
            const webappUrl = selectedOption.dataset.webappUrl;

            if (selectedOption.value && webappUrl && webappUrl !== 'null') {
                UI.enable('openWebAppButton');
                UI.setText('openWebAppMessage', '');
            } else if (selectedOption.value && (webappUrl === 'null' || !webappUrl)) {
                UI.disable('openWebAppButton');
                UI.setText('openWebAppMessage', 'No web app URL for this version.');
            } else {
                UI.disable('openWebAppButton');
                UI.setText('openWebAppMessage', '');
            }
        },

        /**
         * Handle opening the web app URL for the selected version.
         */
        handleOpenWebApp: () => {
            const versionsSelect = UI.get('versionSelect');
            const selectedOption = versionsSelect.options[versionsSelect.selectedIndex];
            const webappUrl = selectedOption.dataset.webappUrl;

            if (webappUrl && webappUrl !== 'null') {
                window.open(webappUrl, '_blank');
            } else {
                alert('No web app URL found for the selected version, or URL is invalid.');
            }
        },

        /**
         * Handle reverting to a specific script version.
         */
        handleRevertVersion: () => {
            const scriptId = Utils.getEffectiveScriptId();
            const versionSelect = UI.get('versionSelect');
            const selectedVersion = versionSelect.value;
            const revertButton = UI.get('revertVersionButton');
            const getVersionsButton = UI.get('getVersionsButton');
            
            if (!scriptId) {
                UI.setText('versionResult', 'Error: Please select or enter a Script ID.');
                UI.show('versionResultContainer');
                return;
            }
            if (!selectedVersion) {
                UI.setText('versionResult', 'Error: Please select a version to revert to.');
                UI.show('versionResultContainer');
                return;
            }

            if (!confirm(`Reverting script ID ${scriptId} to version ${selectedVersion}. This cannot be undone. Do you wish to continue?`)) {
                return;
            }

            UI.showSpinnerInButton(revertButton, 'Reverting...');
            UI.disable('getVersionsButton');
            UI.disable('versionSelect');
            UI.disable('openWebAppButton');
            UI.setText('openWebAppMessage', '');
            UI.show('versionResultContainer');
            UI.setText('versionResult', `Reverting script to version ${selectedVersion}...`);

            Utils.saveScriptIdToLocalStorage(scriptId);

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(revertButton);
                    UI.enable('getVersionsButton');
                    UI.enable('versionSelect');

                    if (response.status === 'success') {
                        UI.setText('versionResult', response.message);
                        UI.setHtml('versionSelect', '<option value="">-- Select a version --</option>');
                        UI.disable('revertVersionButton');
                        UI.disable('openWebAppButton');
                        UI.setText('openWebAppMessage', '');
                    } else {
                        UI.setText('versionResult', `Error: ${response.message}`);
                        UI.disable('openWebAppButton');
                        UI.setText('openWebAppMessage', '');
                    }
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(revertButton);
                    UI.enable('getVersionsButton');
                    UI.enable('versionSelect');
                    UI.disable('openWebAppButton');
                    UI.setText('openWebAppMessage', '');
                    UI.setText('versionResult', `Error reverting to version: ${error.message}`);
                })
                .revertToVersion(scriptId, parseInt(selectedVersion));
        },

        /**
         * Handle getting the list of files for the target script.
         */
        handleGetFilesList: () => {
            const scriptId = Utils.getEffectiveScriptId();
            const filesListDisplay = UI.get('filesListDisplay');
            const getFilesListButton = UI.get('getFilesListButton');

            UI.show('filesListContainer');
            UI.setHtml('filesListDisplay', '');
            UI.showSpinnerInButton(getFilesListButton, 'Getting Files...');

            if (!scriptId) {
                UI.setHtml('filesListDisplay', '<p class="has-text-danger">Error: Please select or enter a Script ID.</p>');
                UI.hideSpinnerInButton(getFilesListButton);
                return;
            }

            Utils.saveScriptIdToLocalStorage(scriptId);

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(getFilesListButton);

                    if (response.status === 'success') {
                        if (response.files && response.files.length > 0) {
                            UI.setHtml('filesListDisplay', '');
                            response.files.forEach(file => {
                                const fileItem = document.createElement('div');
                                fileItem.className = 'file-item';

                                let typeClass = '';
                                let typeText = '';

                                switch (file.type) {
                                    case 'SERVER_JS':
                                        typeClass = 'is-server-js';
                                        typeText = 'JS';
                                        break;
                                    case 'JSON':
                                        typeClass = 'is-json';
                                        typeText = 'JSON';
                                        break;
                                    case 'HTML':
                                        typeClass = 'is-html';
                                        typeText = 'HTML';
                                        break;
                                    default:
                                        typeClass = 'is-unknown';
                                        typeText = 'UNKNOWN';
                                }
                                
                                fileItem.classList.add(typeClass);

                                fileItem.innerHTML = `
                                    <div class="file-type-badge">${typeText}</div>
                                    <div class="file-name">${Utils.escapeHtml(file.name)}.${Utils.getFileExtension(file.type)}</div>
                                `;

                                filesListDisplay.appendChild(fileItem);
                            });
                        } else {
                            UI.setHtml('filesListDisplay', '<p>No files found in this script.</p>');
                        }
                    } else {
                        UI.setHtml('filesListDisplay', `<p class="has-text-danger">Error retrieving files: ${Utils.escapeHtml(response.message)}</p>`);
                        if (response.apiErrorDetails) {
                            UI.setHtml('filesListDisplay', UI.get('filesListDisplay').innerHTML + `<pre class="has-text-danger-dark is-size-7 mt-2">${Utils.escapeHtml(JSON.stringify(response.apiErrorDetails, null, 2))}</pre>`);
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(getFilesListButton);
                    UI.setHtml('filesListDisplay', `<p class="has-text-danger">Error calling server function: ${Utils.escapeHtml(error.message)}</p>`);
                })
                .listTargetScriptFiles(scriptId);
        }
    };
</script>