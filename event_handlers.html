<script>
    // 4. Core Logic / Event Handlers
    const Handlers = {
        /**
         * Initialize tab navigation functionality.
         */
        initTabNavigation: () => {
            const tabs = document.querySelectorAll('.tabs li');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    tabs.forEach(item => item.classList.remove('is-active'));
                    this.classList.add('is-active');

                    const targetId = this.dataset.tabContentId;
                    tabContents.forEach(content => {
                        if (content.id === targetId) {
                            content.classList.add('is-active-content');
                        } else {
                            content.classList.remove('is-active-content');
                        }
                    });
                });
            });

            // Initially activate the first tab
            if (tabs.length > 0) {
                tabs[0].click();
            }
        },

        /**
         * Handle reverting to a specific script version and deploying it.
         */
        handleRevertAndDeploy: () => {
            const scriptId = Utils.getEffectiveScriptId();
            const versionSelect = UI.get('versionSelect');
            const selectedVersion = versionSelect.value;
            const revertAndDeployButton = UI.get('revertAndDeployButton');
            const revertButton = UI.get('revertVersionButton'); // Also disable revert
            const getVersionsButton = UI.get('getVersionsButton');
            
            if (!scriptId) {
                UI.setText('version-result', 'Error: Please select or enter a Script ID.');
                UI.show('version-result-container');
                return;
            }
            if (!selectedVersion) {
                UI.setText('version-result', 'Error: Please select a version to revert and deploy.');
                UI.show('version-result-container');
                return;
            }

            if (!confirm(`Reverting script ID ${scriptId} to version ${selectedVersion} and deploying it as a new web app. This cannot be undone. Do you wish to continue?`)) {
                return;
            }

            UI.showSpinnerInButton(revertAndDeployButton, 'Reverting & Deploying...');
            UI.disable('getVersionsButton');
            UI.disable('versionSelect');
            UI.disable('openWebAppButton');
            UI.disable('revertVersionButton');
            UI.setText('openWebAppMessage', '');
            UI.show('version-result-container');
            UI.setText('version-result', `Reverting script to version ${selectedVersion} and initiating deployment...`);

            Utils.saveScriptIdToLocalStorage(scriptId);

            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.status === 'success') {
                        UI.setText('version-result', response.message + ' Attempting to deploy...');
                        // If revert is successful, proceed with deployment
                        google.script.run
                            .withSuccessHandler(function(deployResponse) {
                                UI.hideSpinnerInButton(revertAndDeployButton);
                                UI.enable('getVersionsButton');
                                UI.enable('versionSelect');
                                UI.enable('revertVersionButton');

                                if (deployResponse.status === 'success') {
                                    let webappUrlHtml = `Web App URL: ${deployResponse.webappUrl}`;
                                    if (deployResponse.webappUrl && deployResponse.webappUrl !== 'null') {
                                        webappUrlHtml = `Web App URL: <a href="${deployResponse.webappUrl}" target="_blank">${deployResponse.webappUrl}</a>`;
                                    } else if (deployResponse.webappUrl === null) {
                                        webappUrlHtml = `Web App URL: Not found in deployment response.`;
                                    }
                                    UI.setHtml('version-result', `Revert to Version ${selectedVersion} SUCCESS.<br>${deployResponse.message}<br>Deployment ID: ${deployResponse.deploymentId}<br>${webappUrlHtml}`);
                                } else {
                                    UI.setHtml('version-result', `Revert to Version ${selectedVersion} SUCCESS.<br>Deployment FAILED: ${deployResponse.message}`);
                                }
                            })
                            .withFailureHandler(function(deployError) {
                                UI.hideSpinnerInButton(revertAndDeployButton);
                                UI.enable('getVersionsButton');
                                UI.enable('versionSelect');
                                UI.enable('revertVersionButton');

                                UI.setText('version-result', `Revert to Version ${selectedVersion} SUCCESS.<br>Deployment failed with error: ${deployError.message}`);
                            })
                            .deployScript(scriptId, `Reverted to version ${selectedVersion} and deployed via methane UI.`);

                    } else {
                        UI.hideSpinnerInButton(revertAndDeployButton);
                        UI.enable('getVersionsButton');
                        UI.enable('versionSelect');
                        UI.enable('revertVersionButton');

                        UI.setText('version-result', `Error during reversion: ${response.message}`);
                        UI.disable('openWebAppButton');
                        UI.setText('openWebAppMessage', '');
                    }
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(revertAndDeployButton);
                    UI.enable('getVersionsButton');
                    UI.enable('versionSelect');
                    UI.enable('revertVersionButton');

                    UI.setText('version-result', `Error reverting and deploying: ${error.message}`);
                    UI.disable('openWebAppButton');
                    UI.setText('openWebAppMessage', '');; 
                });
            },

        /**
         * Switches to a specified tab and scrolls to a target element within that tab.
         * @param {string} tabContentId - The data-tab-content-id of the tab to switch to (e.g., 'ai-operations-tab').
         * @param {string} targetElementId - The ID of the element to scroll to within the activated tab.
         */
        _switchToTabAndScroll: (tabContentId, targetElementId) => {
            const targetTab = document.querySelector(`.tabs li[data-tab-content-id="${tabContentId}"]`);
            if (targetTab) {
                targetTab.click(); // Activate the tab

                // Small delay to ensure tab content is visible before scrolling
                setTimeout(() => {
                    const targetElement = UI.get(targetElementId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100); // 100ms delay should be sufficient
            }
        },

        /**
         * Common function to reset AI operation related UI.
         */
        resetAiOperationUI: () => {
            AppState.activeRequestId = null;
            UI.hideSpinnerInButton(UI.get('generatePolicyButton'));
            UI.hideSpinnerInButton(UI.get('acceptPolicyButton'));
            UI.hideSpinnerInButton(UI.get('regeneratePolicyButton'));
            UI.hideSpinnerInButton(UI.get('regenerateProposalButton'));
            UI.hideSpinnerInButton(UI.get('applyChangesNoDeployButton'));
            UI.hideSpinnerInButton(UI.get('applyAndDeployButton'));
            UI.hideSpinnerInButton(UI.get('fixApplyErrorsButton'));
            UI.hideSpinnerInButton(UI.get('fixErrorsButton'));
            UI.hideSpinnerInButton(UI.get('proposeBrowserErrorLoggingButton'));
            UI.hideSpinnerInButton(UI.get('getOAuthScopesButton'));
            UI.hideSpinnerInButton(UI.get('revertAndDeployButton'));

            UI.enable('prompt');
            UI.hide('cancelAiOperationButton');
            UI.hide('cancelFixErrorsButton');

            AppState.currentPolicyData = null;
            AppState.currentProposal = null;
            UI.setHtml('ai-policy', '');
            UI.setText('proposal-purpose', '');
            UI.setHtml('proposed-files-display', '');
            UI.setHtml('apply-result-content', '');
            UI.hide('html-validation-warnings');
            UI.setHtml('html-validation-warnings', '');
            UI.hide('propose-browser-error-logging-result-container');
            UI.setHtml('propose-browser-error-logging-result', '');
            UI.hide('oauth-scopes-result-container');
            UI.setHtml('oauth-scopes-result', '');
            UI.setHtml('log-result', ''); // Clear structured log display


            UI.hide('policy-container');
            UI.hide('proposal-container');
            UI.hide('acceptPolicyButton');
            UI.hide('regenerateProposalButton');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('apply-result-container');
            UI.hide('fixApplyErrorsButton');

            UI.show('generatePolicyButton');
            UI.hide('regeneratePolicyButton');

            UI.hide('policyEditor');
            UI.setText('togglePolicyEditButton', 'Edit Policy');
            AppState.isPolicyEditing = false;
        },

        /**
         * Handle submit for the agent form (Generate Policy).
         * @param {Event} e - The submit event.
         */
        handleAgentFormSubmit: (e) => {
            e.preventDefault();
            const submitterId = e.submitter.id;

            const scriptId = Utils.getEffectiveScriptId();
            const promptText = UI.get('prompt').value;

            if (!scriptId) {
                alert('Please select or enter a Script ID.');
                return;
            }
            if (!promptText.trim()) {
                alert('Prompt cannot be empty.');
                return;
            }

            Utils.saveScriptIdToLocalStorage(scriptId);

            if (submitterId === 'generatePolicyButton') {
                UI.showSpinnerInButton(UI.get('generatePolicyButton'), 'Generating Policy...');
                UI.hide('regeneratePolicyButton');
            } else {
                console.error("Unknown submitter for agent-form:", submitterId);
                return;
            }

            UI.disable('prompt');
            UI.show('cancelAiOperationButton');
            UI.hide('acceptPolicyButton');
            UI.hide('regenerateProposalButton');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('policy-container');
            UI.hide('proposal-container');
            UI.hide('apply-result-container');
            UI.hide('fixApplyErrorsButton');
            UI.setHtml('proposed-files-display', '');
            UI.setHtml('ai-policy', '');
            UI.hide('html-validation-warnings');
            UI.setHtml('html-validation-warnings', '');
            UI.hide('version-result-container');
            UI.hide('policyEditor');
            UI.setText('togglePolicyEditButton', 'Edit Policy');
            AppState.isPolicyEditing = false;
            UI.setHtml('apply-result-content', '');
            UI.hide('propose-browser-error-logging-result-container');
            UI.setHtml('propose-browser-error-logging-result', '');


            const formData = { scriptId: scriptId, prompt: promptText };

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            console.log('Generating policy...');
            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for generateProposalPolicy.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('generatePolicyButton'));
                    UI.hide('cancelAiOperationButton');

                    if (response.status === 'policy') {
                        AppState.currentPolicyData = response;
                        UI.setHtml('ai-policy', marked.parse(response.policy));
                        UI.show('policy-container');
                        Handlers._switchToTabAndScroll('ai-operations-tab', 'policy-container'); // Add this line
                        UI.show('acceptPolicyButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                        UI.enable('prompt');
                    } else if (response.status === 'error') {
                        UI.setText('ai-policy', 'Error: ' + response.message);
                        UI.show('policy-container');
                        UI.enable('prompt');
                        UI.show('generatePolicyButton');
                        UI.hide('regeneratePolicyButton');
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for generateProposalPolicy.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('generatePolicyButton'));
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');
                    UI.setText('ai-policy', 'Error generating policy: ' + error.message);
                    UI.show('policy-container');
                    UI.show('generatePolicyButton');
                    UI.hide('regeneratePolicyButton');
                })
                .generateProposalPolicy(formData);
        },

        /**
         * Handle toggling the policy edit mode.
         */
        handleTogglePolicyEdit: () => {
            const aiPolicyDiv = UI.get('ai-policy');
            const policyEditorTextarea = UI.get('policyEditor');
            const toggleButton = UI.get('togglePolicyEditButton');

            if (AppState.isPolicyEditing) {
                AppState.currentPolicyData.policy = policyEditorTextarea.value;
                UI.setHtml('ai-policy', marked.parse(AppState.currentPolicyData.policy));
                UI.show('ai-policy');
                UI.hide('policyEditor');
                UI.setText('togglePolicyEditButton', 'Edit Policy');
                UI.enable('prompt');
            } else {
                if (!AppState.currentPolicyData || !AppState.currentPolicyData.policy) {
                    alert('No policy to edit. Please generate a policy first.');
                    return;
                }
                UI.get('policyEditor').value = AppState.currentPolicyData.policy;
                UI.hide('ai-policy');
                UI.show('policyEditor');
                UI.setText('togglePolicyEditButton', 'Finish Editing');
                UI.enable('prompt');
                UI.get('policyEditor').focus();
            }
            AppState.isPolicyEditing = !AppState.isPolicyEditing;
        },

        /**
         * Handle accepting the generated policy and generating proposed changes.
         */
        handleAcceptPolicy: () => {
            if (!AppState.currentPolicyData) {
                alert('No policy to accept. Please generate a policy first.');
                return;
            }

            UI.showSpinnerInButton(UI.get('acceptPolicyButton'), 'Proposing Changes...');
            UI.hide('regeneratePolicyButton');
            UI.hide('generatePolicyButton');
            UI.hide('regenerateProposalButton');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.show('cancelAiOperationButton');
            UI.disable('prompt');
            
            UI.hide('policyEditor');
            UI.setText('togglePolicyEditButton', 'Edit Policy');
            AppState.isPolicyEditing = false;
            UI.setHtml('apply-result-content', '');
            UI.hide('propose-browser-error-logging-result-container');
            UI.setHtml('propose-browser-error-logging-result', '');


            const formData = { scriptId: AppState.currentPolicyData.scriptId, prompt: AppState.currentPolicyData.userPrompt, policy: AppState.currentPolicyData.policy };

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            console.log('Generating code proposal...');
            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for processPrompt (after policy).');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('acceptPolicyButton'));
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');

                    if (response.status === 'proposal') {
                        AppState.currentProposal = response;
                        UI.setText('proposal-purpose', response.purpose || 'No description provided.');
                        
                        UI.setHtml('html-validation-warnings', '');
                        let hasHtmlErrors = false;

                        response.proposedFiles.forEach(file => {
                            if (file.type === 'HTML') {
                                const validationResult = Utils.validateHtml(file.source, file.name);
                                if (!validationResult.isValid) {
                                    hasHtmlErrors = true;
                                    const warningP = document.createElement('p');
                                    warningP.textContent = validationResult.message;
                                    UI.get('html-validation-warnings').appendChild(warningP);
                                }
                            }
                        });

                        if (hasHtmlErrors) {
                            UI.show('html-validation-warnings');
                        }

                        const hasChanges = Utils.displayFileComparison(response.originalFiles, response.proposedFiles, response.deletedFileNames);
                        UI.show('proposal-container');
                        Handlers._switchToTabAndScroll('ai-operations-tab', 'proposal-container'); // Add this line
                        UI.show('regenerateProposalButton');
                        if (hasChanges) {
                            UI.show('applyChangesNoDeployButton');
                            UI.show('applyAndDeployButton');
                        }
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    } else if (response.status === 'error') {
                        UI.appendNotification('apply-result-content', 'is-danger', 'Failed to generate proposal.', response.message);
                        UI.show('apply-result-container');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    } else {
                        UI.appendNotification('apply-result-content', 'is-warning', 'Unexpected response status:', response);
                        UI.show('apply-result-container');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for processPrompt (after policy).');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('acceptPolicyButton'));
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');

                    UI.appendNotification('apply-result-content', 'is-danger', 'Error calling AI:', error.message);
                    UI.show('apply-result-container');
                    UI.show('regeneratePolicyButton');
                    UI.hide('generatePolicyButton');
                })
                .processPrompt(formData);
        },

        /**
         * Handle canceling any active AI operation.
         */
        handleCancelAiOperation: () => {
            Handlers.resetAiOperationUI();
            alert('AI operation canceled by user.');
        },

        /**
         * Handle regenerating the AI policy.
         */
        handleRegeneratePolicy: () => {
            const scriptId = Utils.getEffectiveScriptId();
            const promptText = UI.get('prompt').value;

            if (!scriptId) {
                alert('Please select or enter a Script ID.');
                return;
            }
            if (!promptText.trim()) {
                alert('Prompt cannot be empty.');
                return;
            }

            Utils.saveScriptIdToLocalStorage(scriptId);

            UI.showSpinnerInButton(UI.get('regeneratePolicyButton'), 'Regenerating Policy...');
            UI.hide('generatePolicyButton');
            UI.hide('acceptPolicyButton');
            
            UI.disable('prompt');
            UI.show('cancelAiOperationButton');

            UI.hide('policy-container');
            UI.hide('proposal-container');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('regenerateProposalButton');
            UI.hide('apply-result-container');
            UI.hide('fixApplyErrorsButton');
            UI.setHtml('proposed-files-display', '');
            UI.setHtml('ai-policy', '');
            UI.setText('proposal-purpose', '');
            UI.hide('html-validation-warnings');
            UI.setHtml('html-validation-warnings', '');
            UI.hide('policyEditor');
            UI.setText('togglePolicyEditButton', 'Edit Policy');
            AppState.isPolicyEditing = false;
            UI.setHtml('apply-result-content', '');
            UI.hide('propose-browser-error-logging-result-container');
            UI.setHtml('propose-browser-error-logging-result', '');


            AppState.currentPolicyData = null;
            AppState.currentProposal = null;

            const formData = { scriptId: scriptId, prompt: promptText };

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            console.log('Regenerating policy...');
            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for regeneratePolicy.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('regeneratePolicyButton'));
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');

                    if (response.status === 'policy') {
                        AppState.currentPolicyData = response;
                        UI.setHtml('ai-policy', marked.parse(response.policy));
                        UI.show('policy-container');
                        Handlers._switchToTabAndScroll('ai-operations-tab', 'policy-container'); // Add this line
                        UI.show('acceptPolicyButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    }
                    else if (response.status === 'error') {
                        UI.setText('ai-policy', 'Error: ' + response.message);
                        UI.show('policy-container');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for regeneratePolicy.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('regeneratePolicyButton'));
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');

                    UI.setText('ai-policy', 'Error regenerating policy: ' + error.message);
                    UI.show('policy-container');
                    UI.show('regeneratePolicyButton');
                    UI.hide('generatePolicyButton');
                })
                .generateProposalPolicy(formData);
        },

        /**
         * Handle applying proposed changes to the script.
         * @param {boolean} autoDeploy - Whether to automatically deploy after applying changes.
         * @param {HTMLElement} clickedButton - The button element that was clicked.
         */
        handleApplyChanges: (autoDeploy, clickedButton) => {
            if (!AppState.currentProposal) {
                UI.appendNotification('apply-result-content', 'is-danger', 'No proposal to apply.');
                UI.show('apply-result-container');
                return;
            }

            Utils.saveScriptIdToLocalStorage(AppState.currentProposal.scriptId);

            UI.showSpinnerInButton(clickedButton, autoDeploy ? 'Applying & Deploying...' : 'Applying Changes...');
            
            // Disable other related buttons
            if (clickedButton.id === 'applyChangesNoDeployButton') {
                UI.disable('applyAndDeployButton');
            } else {
                UI.disable('applyChangesNoDeployButton');
            }
            UI.disable('regenerateProposalButton');
            UI.disable('fixApplyErrorsButton');
            UI.disable('proposeBrowserErrorLoggingButton');

            UI.hide('fixApplyErrorsButton');
            UI.setHtml('apply-result-content', `
                <div class="notification is-info is-light">
                <p>Applying changes...</p>
                ${autoDeploy ? '<p>Auto-deploying...</p>' : ''}
                </div>
            `);
            UI.show('apply-result-container');

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(clickedButton);
                    UI.enable('applyChangesNoDeployButton');
                    UI.enable('applyAndDeployButton');
                    UI.enable('regenerateProposalButton');
                    UI.enable('fixApplyErrorsButton');
                    UI.enable('proposeBrowserErrorLoggingButton');
                    UI.setHtml('apply-result-content', '');

                    if (response.status === 'success') {
                        UI.appendNotification('apply-result-content', 'is-success', Utils.escapeHtml(response.message));

                        if (autoDeploy) {
                            const deployMessageContainer = document.createElement('article');
                            deployMessageContainer.className = 'message mt-3';

                            let headerText = 'Auto-deploy Result';
                            let messageBodyContent = '';
                            let messageClass = '';

                            if (response.deploymentStatus === 'success') {
                                messageClass = 'is-success';
                                headerText += ' (Success)';
                                messageBodyContent += `
                                    <ul>
                                    <li><strong>Status:</strong> Success</li>
                                    <li><strong>Message:</strong> ${Utils.escapeHtml(response.deploymentMessage)}</li>
                                `;
                                if (response.deploymentId) {
                                    messageBodyContent += `<li><strong>Deployment ID:</strong> ${Utils.escapeHtml(response.deploymentId)}</li>`;
                                }
                                if (response.webappUrl && response.webappUrl !== 'null') {
                                    messageBodyContent += `<li><strong>Web App URL:</strong> <a href="${Utils.escapeHtml(response.webappUrl)}" target="_blank">${Utils.escapeHtml(response.webappUrl)}</a></li>`;
                                } else if (response.webappUrl === null) {
                                    webappUrlHtml = `Web App URL: Not found in deployment response.`;
                                }
                                messageBodyContent += `</ul>`;
                            } else if (response.deploymentStatus === 'error') {
                                messageClass = 'is-danger';
                                headerText += ' (Error)';
                                messageBodyContent += `
                                    <ul>
                                    <li><strong>Status:</strong> Error</li>
                                    <li><strong>Message:</strong> ${Utils.escapeHtml(response.deploymentMessage)}</li>
                                `;
                                if (response.deploymentId) {
                                    messageBodyContent += `<li><strong>Deployment ID:</strong> ${Utils.escapeHtml(response.deploymentId)}</li>`;
                                }
                                messageBodyContent += `</ul>`;
                            } else {
                                messageClass = 'is-warning';
                                headerText += ' (Unknown Status)';
                                messageBodyContent += `
                                    <ul>
                                    <li><strong>Status:</strong> Unknown</li>
                                    <li><strong>Message:</strong> ${Utils.escapeHtml(response.deploymentMessage)}</li>
                                    </ul>
                                `;
                            }
                            
                            deployMessageContainer.classList.add(messageClass);
                            deployMessageContainer.innerHTML = `
                                <div class="message-header">
                                <p>${headerText}</p>
                                </div>
                                <div class="message-body">
                                ${messageBodyContent}
                                </div>
                            `;
                            UI.get('apply-result-content').appendChild(deployMessageContainer);
                        }

                        AppState.currentProposal = null;
                        UI.hide('applyChangesNoDeployButton');
                        UI.hide('applyAndDeployButton');
                        UI.hide('regenerateProposalButton');
                        UI.setHtml('proposed-files-display', '<p>Changes applied successfully. You can propose new changes or check logs.</p>');
                        UI.hide('html-validation-warnings');
                        UI.setHtml('html-validation-warnings', '');
                        UI.hide('fixApplyErrorsButton');
                    }
                    else {
                        UI.appendNotification('apply-result-content', 'is-danger', `Failed to Apply Changes: ${Utils.escapeHtml(response.message)}`, response.apiErrorDetails || response.fullErrorText);
                        UI.show('fixApplyErrorsButton');
                    }
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(clickedButton);
                    UI.enable('applyChangesNoDeployButton');
                    UI.enable('applyAndDeployButton');
                    UI.enable('regenerateProposalButton');
                    UI.enable('fixApplyErrorsButton');
                    UI.enable('proposeBrowserErrorLoggingButton');
                    UI.appendNotification('apply-result-content', 'is-danger', 'Error applying changes (Uncaught):', error.message);
                    UI.show('fixApplyErrorsButton');
                })
                .applyProposedChanges(AppState.currentProposal.scriptId, AppState.currentProposal.proposedFiles, AppState.currentProposal.deletedFileNames, autoDeploy, AppState.currentProposal.purpose);
        },

        /**
         * Handle regenerating the AI proposal.
         */
        handleRegenerateProposal: () => {
            if (!AppState.currentPolicyData || !AppState.currentPolicyData.scriptId || !AppState.currentPolicyData.userPrompt || !AppState.currentPolicyData.policy) {
                alert('Cannot regenerate proposal. Policy data is missing.');
                return;
            }

            const scriptId = AppState.currentPolicyData.scriptId;
            const promptText = AppState.currentPolicyData.userPrompt;
            const policyText = AppState.currentPolicyData.policy;

            UI.showSpinnerInButton(UI.get('regenerateProposalButton'), 'Regenerating Proposal...');
            UI.disable('applyChangesNoDeployButton');
            UI.disable('applyAndDeployButton');
            UI.disable('prompt');
            UI.show('cancelAiOperationButton');
            UI.disable('proposeBrowserErrorLoggingButton');


            UI.hide('proposal-container');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('apply-result-container');
            UI.hide('fixApplyErrorsButton');
            UI.setHtml('proposed-files-display', '');
            UI.setText('proposal-purpose', '');
            UI.setHtml('apply-result-content', '');
            UI.hide('html-validation-warnings');
            UI.setHtml('html-validation-warnings', '');
            UI.hide('propose-browser-error-logging-result-container');
            UI.setHtml('propose-browser-error-logging-result', '');


            AppState.currentProposal = null;

            const formData = { scriptId: scriptId, prompt: promptText, policy: policyText };

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            console.log('Regenerating AI proposed changes...');
            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for regenerateProposal.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('regenerateProposalButton'));
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');
                    UI.enable('proposeBrowserErrorLoggingButton');


                    if (response.status === 'proposal') {
                        AppState.currentProposal = response;
                        UI.setText('proposal-purpose', response.purpose || 'No description provided.');
                        
                        UI.setHtml('html-validation-warnings', '');
                        let hasHtmlErrors = false;

                        response.proposedFiles.forEach(file => {
                            if (file.type === 'HTML') {
                                const validationResult = Utils.validateHtml(file.source, file.name);
                                if (!validationResult.isValid) {
                                    hasHtmlErrors = true;
                                    const warningP = document.createElement('p');
                                    warningP.textContent = validationResult.message;
                                    UI.get('html-validation-warnings').appendChild(warningP);
                                }
                            }
                        });

                        if (hasHtmlErrors) {
                            UI.show('html-validation-warnings');
                        }

                        const hasChanges = Utils.displayFileComparison(response.originalFiles, response.proposedFiles, response.deletedFileNames);
                        UI.show('proposal-container');
                        Handlers._switchToTabAndScroll('ai-operations-tab', 'proposal-container'); // Add this line
                        UI.show('regenerateProposalButton');
                        if (hasChanges) {
                            UI.show('applyChangesNoDeployButton');
                            UI.show('applyAndDeployButton');
                        }
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    }
                    else if (response.status === 'error') {
                        UI.appendNotification('apply-result-content', 'is-danger', 'Failed to regenerate proposal.', response.message);
                        UI.show('apply-result-container');
                        UI.show('regenerateProposalButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for regenerateProposal.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('regenerateProposalButton'));
                    UI.enable('applyChangesNoDeployButton');
                    UI.enable('applyAndDeployButton');
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');
                    UI.enable('proposeBrowserErrorLoggingButton');

                    UI.appendNotification('apply-result-content', 'is-danger', 'Error regenerating proposal:', error.message);
                    UI.show('apply-result-container');
                    UI.show('regenerateProposalButton');
                    UI.show('regeneratePolicyButton');
                    UI.hide('generatePolicyButton');
                })
                .processPrompt(formData);
        },

        /**
         * Handle fixing apply errors using AI.
         */
        handleFixApplyErrors: () => {
            const scriptId = Utils.getEffectiveScriptId();
            if (!scriptId) {
                UI.appendNotification('apply-result-content', 'is-danger', 'Script ID is required to fix errors.');
                UI.show('apply-result-container');
                return;
            }

            UI.showSpinnerInButton(UI.get('fixApplyErrorsButton'), 'Fixing Errors...');
            UI.hide('generatePolicyButton');
            UI.hide('regeneratePolicyButton');
            UI.disable('prompt');
            UI.show('cancelFixErrorsButton');
            UI.hide('regenerateProposalButton');
            UI.hide('proposal-container');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('apply-result-container');
            UI.setHtml('apply-result-content', '');
            UI.setHtml('proposed-files-display', '');
            UI.hide('html-validation-warnings');
            UI.setHtml('html-validation-warnings', '');
            UI.disable('proposeBrowserErrorLoggingButton');


            Utils.saveScriptIdToLocalStorage(scriptId);

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for fixErrorsFromLogs.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('fixApplyErrorsButton'));
                    UI.enable('prompt');
                    UI.hide('cancelFixErrorsButton');
                    UI.enable('proposeBrowserErrorLoggingButton');


                    if (response.status === 'proposal') {
                        AppState.currentProposal = response;
                        UI.setText('proposal-purpose', response.purpose || 'No description provided.');
                        
                        UI.setHtml('html-validation-warnings', '');
                        let hasHtmlErrors = false;

                        response.proposedFiles.forEach(file => {
                            if (file.type === 'HTML') {
                                const validationResult = Utils.validateHtml(file.source, file.name);
                                if (!validationResult.isValid) {
                                    hasHtmlErrors = true;
                                    const warningP = document.createElement('p');
                                    warningP.textContent = validationResult.message;
                                    UI.get('html-validation-warnings').appendChild(warningP);
                                }
                            }
                        });

                        if (hasHtmlErrors) {
                            UI.show('html-validation-warnings');
                        }

                        const hasChanges = Utils.displayFileComparison(response.originalFiles, response.proposedFiles, response.deletedFileNames);
                        UI.show('proposal-container');
                        Handlers._switchToTabAndScroll('ai-operations-tab', 'proposal-container'); // Add this line
                        UI.show('regenerateProposalButton');
                        if (hasChanges) {
                            UI.show('applyChangesNoDeployButton');
                            UI.show('applyAndDeployButton');
                        }
                        UI.hide('fixApplyErrorsButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    }
                    else if (response.status === 'error') {
                        UI.appendNotification('apply-result-content', 'is-danger', 'Failed to get error fix proposal.', response.message);
                        UI.show('apply-result-container');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for fixErrorsFromLogs.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('fixApplyErrorsButton'));
                    UI.enable('prompt');
                    UI.hide('cancelFixErrorsButton');
                    UI.enable('proposeBrowserErrorLoggingButton');

                    UI.appendNotification('apply-result-content', 'is-danger', 'Error calling AI for fix:', error.message);
                    UI.show('apply-result-container');
                    UI.show('regeneratePolicyButton');
                    UI.hide('generatePolicyButton');
                })
                .fixErrorsFromLogs(scriptId);
        },

        /**
         * Handle submit for the fix errors form.
         * @param {Event} e - The submit event.
         */
        handleFixErrorsFormSubmit: (e) => {
            e.preventDefault();

            const scriptId = Utils.getEffectiveScriptId();
            if (!scriptId) {
                UI.appendNotification('apply-result-content', 'is-danger', 'Script ID is required to fix errors.');
                UI.show('apply-result-container');
                return;
            }

            UI.showSpinnerInButton(UI.get('fixErrorsButton'), 'Fixing Errors...');
            UI.hide('generatePolicyButton');
            UI.hide('regeneratePolicyButton');
            UI.disable('prompt');
            UI.show('cancelFixErrorsButton');
            UI.hide('regenerateProposalButton');
            UI.hide('proposal-container');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('apply-result-container');
            UI.hide('fixApplyErrorsButton');
            UI.setHtml('proposed-files-display', '');
            UI.setText('proposal-purpose', '');
            UI.setHtml('apply-result-content', '');
            UI.hide('html-validation-warnings');
            UI.setHtml('html-validation-warnings', '');
            UI.disable('proposeBrowserErrorLoggingButton');


            Utils.saveScriptIdToLocalStorage(scriptId);

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for fixErrorsFromLogs (via form submit).');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('fixErrorsButton'));
                    UI.enable('prompt');
                    UI.hide('cancelFixErrorsButton');
                    UI.enable('proposeBrowserErrorLoggingButton');


                    if (response.status === 'proposal') {
                        AppState.currentProposal = response;
                        UI.setText('proposal-purpose', response.purpose || 'No description provided.');
                        
                        UI.setHtml('html-validation-warnings', '');
                        let hasHtmlErrors = false;

                        response.proposedFiles.forEach(file => {
                            if (file.type === 'HTML') {
                                const validationResult = Utils.validateHtml(file.source, file.name);
                                if (!validationResult.isValid) {
                                    hasHtmlErrors = true;
                                    const warningP = document.createElement('p');
                                    warningP.textContent = validationResult.message;
                                    UI.get('html-validation-warnings').appendChild(warningP);
                                }
                            }
                        });

                        if (hasHtmlErrors) {
                            UI.show('html-validation-warnings');
                        }

                        const hasChanges = Utils.displayFileComparison(response.originalFiles, response.proposedFiles, response.deletedFileNames);
                        UI.show('proposal-container');
                        Handlers._switchToTabAndScroll('ai-operations-tab', 'proposal-container'); // Add this line
                        UI.show('regenerateProposalButton');
                        if (hasChanges) {
                            UI.show('applyChangesNoDeployButton');
                            UI.show('applyAndDeployButton');
                        }
                        UI.hide('fixErrorsButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    }
                    else if (response.status === 'error') {
                        UI.appendNotification('apply-result-content', 'is-danger', 'Failed to get error fix proposal.', response.message);
                        UI.show('apply-result-container');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for fixErrorsFromLogs (via form submit).');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('fixErrorsButton'));
                    UI.enable('prompt');
                    UI.hide('cancelFixErrorsButton');
                    UI.enable('proposeBrowserErrorLoggingButton');

                    UI.appendNotification('apply-result-content', 'is-danger', 'Error calling AI for fix:', error.message);
                    UI.show('apply-result-container');
                    UI.show('regeneratePolicyButton');
                    UI.hide('generatePolicyButton');
                })
                .fixErrorsFromLogs(scriptId);
        },

        /**
         * Handle proposing browser error logging changes for the target script.
         */
        handleProposeBrowserErrorLogging: () => {
            const scriptId = Utils.getEffectiveScriptId();
            if (!scriptId) {
                alert('Please select or enter a Script ID for the target script.');
                return;
            }

            UI.showSpinnerInButton(UI.get('proposeBrowserErrorLoggingButton'), 'Proposing...');
            UI.disable('prompt');
            UI.hide('generatePolicyButton');
            UI.hide('regeneratePolicyButton');
            UI.hide('acceptPolicyButton');
            UI.hide('regenerateProposalButton');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('fixApplyErrorsButton');
            UI.hide('policy-container');
            UI.hide('apply-result-container');
            UI.setHtml('apply-result-content', '');
            UI.hide('html-validation-warnings');
            UI.setHtml('html-validation-warnings', '');
            
            // Clear previous proposal display
            UI.setHtml('proposed-files-display', '');
            UI.setText('proposal-purpose', '');
            UI.hide('proposal-container');
            
            UI.show('propose-browser-error-logging-result-container');
            UI.setText('propose-browser-error-logging-result', 'Generating proposal for browser error logging...');

            Utils.saveScriptIdToLocalStorage(scriptId);

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for proposeBrowserErrorLoggingChanges.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('proposeBrowserErrorLoggingButton'));
                    UI.enable('prompt');
                    UI.show('generatePolicyButton'); // Restore AI operation buttons
                    UI.hide('propose-browser-error-logging-result-container'); // Hide temporary result

                    if (response.status === 'proposal') {
                        AppState.currentProposal = response;
                        // Switch to AI Operations tab and display the proposal
                        // const aiOperationsTab = document.querySelector('.tabs li[data-tab-content-id="ai-operations-tab"]');
                        // if (aiOperationsTab) aiOperationsTab.click();
                        Handlers._switchToTabAndScroll('ai-operations-tab', 'proposal-container'); // Use the new helper

                        UI.setText('proposal-purpose', response.purpose || 'No description provided.');
                        
                        UI.setHtml('html-validation-warnings', '');
                        let hasHtmlErrors = false;

                        response.proposedFiles.forEach(file => {
                            if (file.type === 'HTML') {
                                const validationResult = Utils.validateHtml(file.source, file.name);
                                if (!validationResult.isValid) {
                                    hasHtmlErrors = true;
                                    const warningP = document.createElement('p');
                                    warningP.textContent = validationResult.message;
                                    UI.get('html-validation-warnings').appendChild(warningP);
                                }
                            }
                        });

                        if (hasHtmlErrors) {
                            UI.show('html-validation-warnings');
                        }

                        const hasChanges = Utils.displayFileComparison(response.originalFiles, response.proposedFiles, response.deletedFileNames);
                        UI.show('proposal-container');
                        UI.show('regenerateProposalButton');
                        UI.hide('fixApplyErrorsButton');
                        if (hasChanges) { // Only show apply buttons if there are changes
                            UI.show('applyChangesNoDeployButton');
                            UI.show('applyAndDeployButton');
                        } else {
                            UI.hide('applyChangesNoDeployButton');
                            UI.hide('applyAndDeployButton');
                        }
                        // Ensure Policy related buttons are hidden/shown correctly if this flow bypasses policy generation
                        UI.hide('policy-container');
                        UI.hide('acceptPolicyButton');
                        UI.hide('regeneratePolicyButton'); // Regenerate proposal handles its own button
                        UI.hide('generatePolicyButton'); // Start over button
                    } else if (response.status === 'error') {
                        UI.appendNotification('apply-result-content', 'is-danger', 'Failed to generate proposal.', response.message);
                        UI.show('apply-result-container');
                        UI.show('generatePolicyButton'); // Restore original AI button
                    }
                    else {
                        UI.appendNotification('apply-result-content', 'is-warning', 'Unexpected response status:', response);
                        UI.show('apply-result-container');
                        UI.show('generatePolicyButton'); // Restore original AI button
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for proposeBrowserErrorLoggingChanges.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('proposeBrowserErrorLoggingButton'));
                    UI.enable('prompt');
                    UI.show('generatePolicyButton'); // Restore AI operation buttons

                    UI.appendNotification('propose-browser-error-logging-result', 'is-danger', 'Error generating browser error logging proposal:', error.message);
                    UI.show('propose-browser-error-logging-result-container');
                })
                .proposeBrowserErrorLoggingChanges(scriptId);
        },
        // ... (rest of the handlers remain unchanged)
        /**
         * Handle saving the GCP Project ID.
         */
        handleSaveGcpProjectId: () => {
            const gcpProjectId = UI.get('gcpProjectId').value.trim();
            const saveButton = UI.get('saveGcpProjectIdButton');

            UI.show('gcp-save-result-container');
            UI.setText('gcp-save-result', 'Saving...');
            UI.showSpinnerInButton(saveButton, 'Saving...');

            if (!gcpProjectId) {
                UI.setText('gcp-save-result', 'Error: GCP Project ID cannot be empty.');
                UI.show('gcp-save-result-container');
                UI.hideSpinnerInButton(saveButton);
                return;
            }

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.setText('gcp-save-result', response.message);
                    UI.hideSpinnerInButton(saveButton);
                    if (response.status === 'success') {
                        Utils.saveGcpProjectIdToLocalStorage(gcpProjectId);
                    }
                })
                .withFailureHandler(function(error) {
                    UI.setText('gcp-save-result', 'Error saving GCP Project ID: ' + error.message);
                    UI.hideSpinnerInButton(saveButton);
                })
                .setGcpProjectId(gcpProjectId);
        },

        /**
         * Handle submit for the log retrieval form.
         * @param {Event} e - The submit event.
         */
        handleLogFormSubmit: (e) => {
            e.preventDefault();
            const submitButton = UI.get('getLogsButton');

            UI.showSpinnerInButton(submitButton, 'Getting Logs...');
            UI.hide('log-result-container');
            UI.setHtml('log-result', ''); // Use setHtml to clear for structured logs

            const scriptId = Utils.getEffectiveScriptId();
            Utils.saveScriptIdToLocalStorage(scriptId);

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(submitButton);
                    UI.displayLogs(response); // Use the new UI.displayLogs function
                    UI.show('log-result-container');
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(submitButton);
                    UI.setHtml('log-result', `<p class="has-text-danger">Error: ${Utils.escapeHtml(error.message)}</p>`); // Use setHtml for error messages
                    UI.show('log-result-container');
                })
                .getScriptLogs(scriptId);
        },

        /**
         * Handle submit for the deploy form.
         * @param {Event} e - The submit event.
         */
        handleDeployFormSubmit: (e) => {
            e.preventDefault();
            const submitButton = UI.get('deployButton');

            UI.showSpinnerInButton(submitButton, 'Deploying...');
            UI.hide('deploy-result-container');
            UI.setHtml('deploy-result-content', '');

            const scriptId = Utils.getEffectiveScriptId();
            const description = UI.get('deploymentDescription').value;
            Utils.saveScriptIdToLocalStorage(scriptId);

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(submitButton);
                    UI.show('deploy-result-container');
                    if (response.status === 'success') {
                        let webappUrlHtml = `Web App URL: ${response.webappUrl}`;
                        if (response.webappUrl && response.webappUrl !== 'null') {
                            webappUrlHtml = `Web App URL: <a href="${response.webappUrl}" target="_blank">${response.webappUrl}</a>`;
                        } else if (response.webappUrl === null) {
                            webappUrlHtml = `Web App URL: Not found in deployment response.`;
                        }
                        UI.setHtml('deploy-result-content', `
                            <div class="notification is-success is-light">
                                <p>${Utils.escapeHtml(response.message)}</p>
                                <p><strong>Deployment ID:</strong> ${Utils.escapeHtml(response.deploymentId)}</p>
                                <p>${webappUrlHtml}</p>
                            </div>
                        `);
                        if (response.versionWarning) {
                            UI.appendNotification('deploy-result-content', 'is-warning', 'Version Warning', response.versionWarning);
                        }
                    } else {
                        UI.appendNotification('deploy-result-content', 'is-danger', 'Deployment Error', response.message);
                    }
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(submitButton);
                    UI.show('deploy-result-container');
                    UI.appendNotification('deploy-result-content', 'is-danger', 'Error deploying script', error.message);
                })
                .deployScript(scriptId, description);
        },

        /**
         * Handle submit for the add library form.
         * @param {Event} e - The submit event.
         */
        handleAddLibraryFormSubmit: (e) => {
            e.preventDefault();
            const submitButton = UI.get('addLibraryButton');

            UI.showSpinnerInButton(submitButton, 'Adding Library...');
            UI.hide('add-library-result-container');
            UI.setText('add-library-result', '');

            const targetScriptId = Utils.getEffectiveScriptId();
            const libraryScriptId = UI.get('libraryScriptId').value.trim();
            const libraryVersion = UI.get('libraryVersion').value.trim();

            if (!targetScriptId) {
                UI.setText('add-library-result', 'Error: Please select or enter a Target Script ID.');
                UI.show('add-library-result-container');
                UI.hideSpinnerInButton(submitButton);
                return;
            }
            if (!libraryScriptId) {
                UI.setText('add-library-result', 'Error: Library Script ID cannot be empty.');
                UI.show('add-library-result-container');
                UI.hideSpinnerInButton(submitButton);
                return;
            }

            Utils.saveScriptIdToLocalStorage(targetScriptId);

            const effectiveVersion = libraryVersion.trim() === '' ? 'HEAD' : libraryVersion.trim();

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(submitButton);
                    UI.show('add-library-result-container');
                    if (response.status === 'success') {
                        UI.setText('add-library-result', response.message);
                        UI.clearValue('libraryScriptId');
                        UI.clearValue('libraryVersion');
                    }
                    else {
                        UI.setText('add-library-result', `Error: ${response.message}`);
                    }
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(submitButton);
                    UI.show('add-library-result-container');
                    UI.setText('add-library-result', `Error adding library: ${error.message}`);
                })
                .addLibraryToProject(targetScriptId, libraryScriptId, effectiveVersion);
        },

        /**
         * Handle getting script versions.
         */
        handleGetVersions: () => {
            const scriptId = Utils.getEffectiveScriptId();
            const versionsSelect = UI.get('versionSelect');
            const getVersionsButton = UI.get('getVersionsButton');
            
            UI.setHtml('versionSelect', '<option value="">-- Loading versions --</option>');
            UI.disable('versionSelect');
            UI.showSpinnerInButton(getVersionsButton, 'Getting Versions...');
            UI.disable('revertVersionButton');
            UI.disable('openWebAppButton');
            UI.setText('openWebAppMessage', '');
            UI.hide('version-result-container');

            if (!scriptId) {
                UI.setHtml('versionSelect', '<option value="">-- Select a Script ID first --</option>');
                UI.setText('version-result', 'Error: Please select or enter a Script ID to get versions.');
                UI.show('version-result-container');
                UI.enable('versionSelect');
                UI.hideSpinnerInButton(getVersionsButton);
                return;
            }

            Utils.saveScriptIdToLocalStorage(scriptId);

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(getVersionsButton);
                    UI.enable('versionSelect');

                    if (response.status === 'success') {
                        UI.setHtml('versionSelect', '<option value="">-- Select a version --</option>');
                        if (response.versions && response.versions.length > 0) {
                            response.versions.forEach(version => {
                                const option = document.createElement('option');
                                option.value = version.versionNumber;
                                option.textContent = `Version ${version.versionNumber} (Created: ${new Date(version.createTime).toLocaleString()}) - ${version.description}`;
                                option.dataset.webappUrl = version.webappUrl || '';
                                versionsSelect.appendChild(option);
                            });
                            UI.setText('version-result', `Versions found: ${response.versions.length} items`);
                        } else {
                            UI.setHtml('versionSelect', '<option value="">-- No versions found --</option>');
                            UI.setText('version-result', response.message);
                        }
                        versionsSelect.dispatchEvent(new Event('change'));
                    }
                    else {
                        UI.setHtml('versionSelect', '<option value="">-- Error loading versions --</option>');
                        UI.setText('version-result', `Error: ${response.message}`);
                        UI.disable('openWebAppButton');
                        UI.disable('revertVersionButton');
                        UI.setText('openWebAppMessage', '');
                    }
                    UI.show('version-result-container');
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(getVersionsButton);
                    UI.enable('versionSelect');
                    UI.disable('revertVersionButton');
                    UI.disable('openWebAppButton');
                    UI.setText('openWebAppMessage', '');
                    UI.setHtml('versionSelect', '<option value="">-- Error loading versions --</option>');
                    UI.setText('version-result', `Error getting versions: ${error.message}`);
                    UI.show('version-result-container');
                })
                .listScriptVersions(scriptId);
        },

        /**
         * Handle change event for the version select dropdown.
         */
        handleVersionSelectChange: () => {
            const versionsSelect = UI.get('versionSelect');
            const selectedOption = versionsSelect.options[versionsSelect.selectedIndex];

            // Enable/disable revert and revert+deploy buttons based on selection
            const isVersionSelected = !!selectedOption.value;
            UI.get('revertVersionButton').disabled = !isVersionSelected;
            UI.get('revertAndDeployButton').disabled = !isVersionSelected;

            // Enable/disable open web app button based on webappUrl in dataset
            const webappUrl = selectedOption.dataset.webappUrl;

            if (selectedOption.value && webappUrl) {
                UI.enable('openWebAppButton');
                UI.setText('openWebAppMessage', '');
            } else if (selectedOption.value && !webappUrl) {
                UI.disable('openWebAppButton');
            } else {
                UI.disable('openWebAppButton');
                UI.setText('openWebAppMessage', '');
            }
        },

        /**
         * Handle opening the web app URL for the selected version.
         */
        handleOpenWebApp: () => {
            const versionsSelect = UI.get('versionSelect');
            const selectedOption = versionsSelect.options[versionsSelect.selectedIndex];
            const webappUrl = selectedOption.dataset.webappUrl;

            if (webappUrl && webappUrl !== 'null') {
                window.open(webappUrl, '_blank');
            } else {
                alert('No web app URL found for the selected version, or URL is invalid.');
            }
        },

        /**
         * Handle reverting to a specific script version.
         */
        handleRevertVersion: () => {
            const scriptId = Utils.getEffectiveScriptId();
            const versionSelect = UI.get('versionSelect');
            const selectedVersion = versionSelect.value;
            const revertButton = UI.get('revertVersionButton');
            const getVersionsButton = UI.get('getVersionsButton');
            
            if (!scriptId) {
                UI.setText('version-result', 'Error: Please select or enter a Script ID.');
                UI.show('version-result-container');
                return;
            }
            if (!selectedVersion) {
                UI.setText('version-result', 'Error: Please select a version to revert to.');
                UI.show('version-result-container');
                return;
            }

            if (!confirm(`Reverting script ID ${scriptId} to version ${selectedVersion}. This cannot be undone. Do you wish to continue?`)) {
                return;
            }

            UI.showSpinnerInButton(revertButton, 'Reverting...');
            UI.disable('getVersionsButton');
            UI.disable('versionSelect');
            UI.disable('openWebAppButton');
            UI.setText('openWebAppMessage', '');
            UI.show('version-result-container');
            UI.setText('version-result', `Reverting script to version ${selectedVersion}...`);

            Utils.saveScriptIdToLocalStorage(scriptId);

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(revertButton);
                    UI.enable('getVersionsButton');
                    UI.enable('versionSelect');

                    if (response.status === 'success') {
                        UI.setText('version-result', response.message);
                        UI.setHtml('versionSelect', '<option value="">-- Select a version --</option>');
                        UI.disable('revertVersionButton');
                        UI.disable('openWebAppButton');
                        UI.setText('openWebAppMessage', '');
                    }
                    else {
                        UI.setText('version-result', `Error: ${response.message}`);
                        UI.disable('openWebAppButton');
                        UI.setText('openWebAppMessage', '');
                    }
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(revertButton);
                    UI.enable('getVersionsButton');
                    UI.enable('versionSelect');
                    UI.disable('openWebAppButton');
                    UI.setText('openWebAppMessage', '');
                    UI.setText('version-result', `Error reverting to version: ${error.message}`);
                })
                .revertToVersion(scriptId, parseInt(selectedVersion));
        },

        /**
         * Handle getting the list of files for the target script.
         */
        handleGetFilesList: (event) => { /* Added event parameter */
            const scriptId = Utils.getEffectiveScriptId();
            const filesListDisplay = UI.get('filesListDisplay');
            const getFilesListButton = UI.get('getFilesListButton');

            UI.show('filesListContainer');

            // Determine if the call is from the explicit button click or an automatic change event
            const isManualButtonClick = event && event.type === 'click' && event.currentTarget.id === 'getFilesListButton';

            if (isManualButtonClick) {
                UI.showSpinnerInButton(getFilesListButton, 'Getting Files...');
                UI.setHtml(filesListDisplay, ''); // Clear previous results immediately for manual trigger
            } else {
                // For automatic trigger (e.g., dropdown change), show spinner directly in the display area
                UI.setHtml(filesListDisplay, `<p><span class="spinner" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 8px;"></span>Loading files...</p>`);
            }

            if (!scriptId) {
                if (isManualButtonClick) {
                    UI.hideSpinnerInButton(getFilesListButton);
                }
                UI.setHtml(filesListDisplay, '<p class="has-text-danger">Error: Please select or enter a Script ID.</p>');
                return;
            }

            Utils.saveScriptIdToLocalStorage(scriptId);

            google.script.run
                .withSuccessHandler(function(response) {
                    if (isManualButtonClick) {
                        UI.hideSpinnerInButton(getFilesListButton);
                    }
                    UI.setHtml(filesListDisplay, ''); // Clear loading message

                    if (response.status === 'success') {
                        if (response.files && response.files.length > 0) {
                            UI.setHtml('filesListDisplay', '');
                            response.files.forEach(file => {
                                const fileItem = document.createElement('div');
                                fileItem.className = 'file-item';

                                let typeClass = '';
                                let typeText = '';

                                switch (file.type) {
                                    case 'SERVER_JS':
                                        typeClass = 'is-server-js';
                                        typeText = 'JS';
                                        break;
                                    case 'JSON':
                                        typeClass = 'is-json';
                                        typeText = 'JSON';
                                        break;
                                    case 'HTML':
                                        typeClass = 'is-html';
                                        typeText = 'HTML';
                                        break;
                                    default:
                                        typeClass = 'is-unknown';
                                        typeText = 'UNKNOWN';
                                }
                                
                                fileItem.classList.add(typeClass);

                                fileItem.innerHTML = `
                                    <div class="file-type-badge">${typeText}</div>
                                    <div class="file-name">${Utils.escapeHtml(file.name)}.${Utils.getFileExtension(file.type)}</div>
                                `;

                                filesListDisplay.appendChild(fileItem);
                            });
                        } else {
                            UI.setHtml(filesListDisplay, '<p>No files found in this script.</p>');
                        }
                    }
                    else {
                        UI.setHtml(filesListDisplay, `<p class="has-text-danger">Error retrieving files: ${Utils.escapeHtml(response.message)}</p>`);
                        if (response.apiErrorDetails) {
                            UI.setHtml('filesListDisplay', UI.get('filesListDisplay').innerHTML + `<pre class="has-text-danger-dark is-size-7 mt-2">${Utils.escapeHtml(JSON.stringify(response.apiErrorDetails, null, 2))}</pre>`);
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    if (isManualButtonClick) {
                        UI.hideSpinnerInButton(getFilesListButton);
                    }
                    UI.setHtml(filesListDisplay, `<p class="has-text-danger">Error calling server function: ${Utils.escapeHtml(error.message)}</p>`);
                })
                .listTargetScriptFiles(scriptId);
        },
        /**
         * Handle getting OAuth scopes for the target script.
         */
        handleGetOAuthScopes: () => {
            const scriptId = Utils.getEffectiveScriptId();
            const getScopesButton = UI.get('getOAuthScopesButton');
            const resultContainer = UI.get('oauth-scopes-result-container');
            const resultDisplay = UI.get('oauth-scopes-result');

            UI.showSpinnerInButton(getScopesButton, 'Getting Scopes...');
            UI.show(resultContainer);
            UI.setHtml(resultDisplay, '<p><span class="spinner" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 8px;"></span>OAuth...</p>'); // Initial loading message

            if (!scriptId) {
                UI.hideSpinnerInButton(getScopesButton);
                UI.setHtml(resultDisplay, ''); // Clear loading message
                UI.appendNotification(resultDisplay, 'is-danger', ': ID');
                return;
            }

            Utils.saveScriptIdToLocalStorage(scriptId);

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(getScopesButton);
                    if (response.status === 'success') {
                        UI.displayOAuthScopes(response.scopes, resultDisplay); // Call the new function
                    } else {
                        UI.setHtml(resultDisplay, ''); // Clear loading message before appending error
                        UI.appendNotification(resultDisplay, 'is-danger', `OAuth: ${response.message}`, response.apiErrorDetails);
                    }
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(getScopesButton);
                    UI.setHtml(resultDisplay, ''); // Clear loading message
                    UI.appendNotification(resultDisplay, 'is-danger', `: ${Utils.escapeHtml(error.message)}`);
                })
                .getProjectOAuthScopes(scriptId);
        },
        /**
         * Handle theme toggle.
         */
        handleThemeToggle: () => {
            const themeToggle = UI.get('themeToggle');
            if (themeToggle.checked) {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
            } else {
                document.documentElement.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
            }
        },

        /**
         * Handle downloading a file from a URL and adding/updating it to the project.
         */
        handleDownloadAndAddFile: () => {
            const scriptId = Utils.getEffectiveScriptId();
            const fileUrl = UI.get('fileUrl').value.trim();
            const newFileName = UI.get('newFileName').value.trim();
            const newFileType = UI.get('newFileType').value;
            const downloadButton = UI.get('downloadAndAddFileButton');
            const resultContainer = UI.get('download-result-container');
            const resultDisplay = UI.get('download-result');

            UI.showSpinnerInButton(downloadButton, 'Downloading...');
            UI.show(resultContainer);
            UI.setText(resultDisplay, ''); // Clear previous result

            if (!scriptId) {
                UI.hideSpinnerInButton(downloadButton);
                UI.appendNotification(resultDisplay, 'is-danger', 'Error: Please select or enter a Script ID.');
                return;
            }
            if (!fileUrl) {
                UI.hideSpinnerInButton(downloadButton);
                UI.appendNotification(resultDisplay, 'is-danger', 'Error: File URL cannot be empty.');
                return;
            }
            if (!newFileName) {
                UI.hideSpinnerInButton(downloadButton);
                UI.appendNotification(resultDisplay, 'is-danger', 'Error: Target File Name cannot be empty.');
                return;
            }
            // Basic URL validation
            try {
                new URL(fileUrl);
            } catch (e) {
                UI.hideSpinnerInButton(downloadButton);
                UI.appendNotification(resultDisplay, 'is-danger', 'Error: Invalid File URL format.');
                return;
            }

            UI.appendNotification(resultDisplay, 'is-info', 'Attempting to download and add/update file...', `URL: ${fileUrl}\nFile Name: ${newFileName}\nFile Type: ${newFileType}`);

            Utils.saveScriptIdToLocalStorage(scriptId);

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(downloadButton);
                    if (response.status === 'success') {
                        UI.appendNotification(resultDisplay, 'is-success', response.message);
                        // Clear input fields on success
                        UI.clearValue('fileUrl');
                        UI.clearValue('newFileName');
                        UI.get('newFileType').value = 'SERVER_JS'; // Reset to default
                    } else {
                        UI.appendNotification(resultDisplay, 'is-danger', `Failed to download and add/update file: ${response.message}`, response.apiErrorDetails || response.fullErrorText);
                    }
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(downloadButton);
                    UI.appendNotification(resultDisplay, 'is-danger', `Error calling server function: ${error.message}`);
                })
                .downloadAndAddFile(scriptId, fileUrl, newFileName, newFileType);
        }
    };
</script>
