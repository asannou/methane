<script>
    // 4. Core Logic / Event Handlers
    const Handlers = {
        /**
         * Initialize tab navigation functionality.
         */
        initTabNavigation: () => {
            const tabs = document.querySelectorAll('.tabs li');
            const tabContents = document.querySelectorAll('.tab-content');

            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    tabs.forEach(item => item.classList.remove('is-active'));
                    this.classList.add('is-active');

                    const targetId = this.dataset.tabContentId;
                    tabContents.forEach(content => {
                        if (content.id === targetId) {
                            content.classList.add('is-active-content');
                        } else {
                            content.classList.remove('is-active-content');
                        }
                    });
                });
            });

            // Initially activate the first tab
            if (tabs.length > 0) {
                tabs[0].click();
            }
        },

        /**
         * Switches to a specified tab and scrolls to a target element within that tab.
         * @param {string} tabContentId - The data-tab-content-id of the tab to switch to (e.g., 'ai-operations-tab').
         * @param {string} targetElementId - The ID of the element to scroll to within the activated tab.
         */
        _switchToTabAndScroll: (tabContentId, targetElementId) => {
            const targetTab = document.querySelector(`.tabs li[data-tab-content-id="${tabContentId}"]`);
            if (targetTab) {
                targetTab.click(); // Activate the tab

                // Small delay to ensure tab content is visible before scrolling
                setTimeout(() => {
                    const targetElement = UI.get(targetElementId);
                    if (targetElement) {
                        targetElement.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                }, 100); // 100ms delay should be sufficient
            }
        },

        /**
         * Common function to reset AI operation related UI.
         */
        resetAiOperationUI: () => {
            AppState.activeRequestId = null;
            UI.hideSpinnerInButton(UI.get('generatePolicyButton'));
            UI.hideSpinnerInButton(UI.get('acceptPolicyButton'));
            UI.hideSpinnerInButton(UI.get('regeneratePolicyButton'));
            UI.hideSpinnerInButton(UI.get('regenerateProposalButton'));
            UI.hideSpinnerInButton(UI.get('applyChangesNoDeployButton'));
            UI.hideSpinnerInButton(UI.get('applyAndDeployButton'));
            UI.hideSpinnerInButton(UI.get('fixApplyErrorsButton'));
            UI.hideSpinnerInButton(UI.get('fixErrorsButton'));
            UI.hideSpinnerInButton(UI.get('proposeBrowserErrorLoggingButton'));

            UI.enable('prompt');
            UI.hide('cancelAiOperationButton');
            UI.hide('cancelFixErrorsButton');

            AppState.currentPolicyData = null;
            AppState.currentProposal = null;
            UI.setHtml('ai-policy', '');
            UI.setText('proposal-purpose', '');
            UI.setHtml('proposed-files-display', '');
            UI.setHtml('apply-result-content', '');
            UI.hide('html-validation-warnings');
            UI.setHtml('html-validation-warnings', '');
            UI.hide('propose-browser-error-logging-result-container');
            UI.setHtml('propose-browser-error-logging-result', '');
            UI.setHtml('log-result', ''); // Clear structured log display


            UI.hide('policy-container');
            UI.hide('proposal-container');
            UI.hide('acceptPolicyButton');
            UI.hide('regenerateProposalButton');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('apply-result-container');
            UI.hide('fixApplyErrorsButton');

            UI.show('generatePolicyButton');
            UI.hide('regeneratePolicyButton');

            UI.hide('policyEditor');
            UI.setText('togglePolicyEditButton', 'Edit Policy');
            AppState.isPolicyEditing = false;

            // Clear summary details if a script is no longer selected or for a new selection
            const scriptId = Utils.getEffectiveScriptId();
            if (!scriptId) {
                UI.setHtml(UI.get('editorUrlDisplay'), 'Apps Script Editor URL: (Script ID needed)');
                UI.setHtml(UI.get('summaryFilesDisplay'), '<p class="has-text-grey">No script selected.</p>');
                UI.setHtml(UI.get('summaryOAuthScopesDisplay'), '<p class="has-text-grey">No script selected.</p>');
                UI.setHtml(UI.get('summaryVersionsDisplay'), '<p class="has-text-grey">No script selected.</p>');
                UI.disable(UI.get('summaryOpenWebAppButton'));
                UI.disable(UI.get('summaryRevertVersionButton'));
                UI.setText(UI.get('summaryOpenWebAppMessage'), '');
                UI.setHtml(UI.get('summaryVersionSelect'), '<option value="">-- Select a Script ID first --</option>');
                UI.hide(UI.get('scriptDetailsSummaryContainer'));
            } else {
                // If a script is selected, just trigger a refresh of summary details
                Handlers.loadScriptDetailsSummary();
            }
        },

        /**
         * Handle submit for the agent form (Generate Policy).
         * @param {Event} e - The submit event.
         */
        handleAgentFormSubmit: (e) => {
            e.preventDefault();
            const submitterId = e.submitter.id;

            const scriptId = Utils.getEffectiveScriptId();
            const promptText = UI.get('prompt').value;

            if (!scriptId) {
                alert('Please select or enter a Script ID.');
                return;
            }
            if (!promptText.trim()) {
                alert('Prompt cannot be empty.');
                return;
            }

            Utils.saveScriptIdToLocalStorage(scriptId);

            if (submitterId === 'generatePolicyButton') {
                UI.showSpinnerInButton(UI.get('generatePolicyButton'), 'Generating Policy...');
                UI.hide('regeneratePolicyButton');
            } else {
                console.error("Unknown submitter for agent-form:", submitterId);
                return;
            }

            UI.disable('prompt');
            UI.show('cancelAiOperationButton');
            UI.hide('acceptPolicyButton');
            UI.hide('regenerateProposalButton');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('policy-container');
            UI.hide('proposal-container');
            UI.hide('apply-result-container');
            UI.hide('fixApplyErrorsButton');
            UI.setHtml('proposed-files-display', '');
            UI.setHtml('ai-policy', '');
            UI.hide('html-validation-warnings');
            UI.setHtml('html-validation-warnings', '');
            UI.hide('policyEditor');
            UI.setText('togglePolicyEditButton', 'Edit Policy');
            AppState.isPolicyEditing = false;
            UI.setHtml('apply-result-content', '');
            UI.hide('propose-browser-error-logging-result-container');
            UI.setHtml('propose-browser-error-logging-result', '');


            const formData = { scriptId: scriptId, prompt: promptText };

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            console.log('Generating policy...');
            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for generateProposalPolicy.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('generatePolicyButton'));
                    UI.hide('cancelAiOperationButton');

                    if (response.status === 'policy') {
                        AppState.currentPolicyData = response;
                        UI.setHtml('ai-policy', marked.parse(response.policy));
                        UI.show('policy-container');
                        Handlers._switchToTabAndScroll('ai-operations-tab', 'policy-container'); // Add this line
                        UI.show('acceptPolicyButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                        UI.enable('prompt');
                    } else if (response.status === 'error') {
                        UI.setText('ai-policy', 'Error: ' + response.message);
                        UI.show('policy-container');
                        UI.enable('prompt');
                        UI.show('generatePolicyButton');
                        UI.hide('regeneratePolicyButton');
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for generateProposalPolicy.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('generatePolicyButton'));
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');
                    UI.setText('ai-policy', 'Error generating policy: ' + error.message);
                    UI.show('policy-container');
                    UI.show('generatePolicyButton');
                    UI.hide('regeneratePolicyButton');
                })
                .generateProposalPolicy(formData);
        },

        /**
         * Handle toggling the policy edit mode.
         */
        handleTogglePolicyEdit: () => {
            const aiPolicyDiv = UI.get('ai-policy');
            const policyEditorTextarea = UI.get('policyEditor');
            const toggleButton = UI.get('togglePolicyEditButton');

            if (AppState.isPolicyEditing) {
                AppState.currentPolicyData.policy = policyEditorTextarea.value;
                UI.setHtml('ai-policy', marked.parse(AppState.currentPolicyData.policy));
                UI.show('ai-policy');
                UI.hide('policyEditor');
                UI.setText('togglePolicyEditButton', 'Edit Policy');
                UI.enable('prompt');
            } else {
                if (!AppState.currentPolicyData || !AppState.currentPolicyData.policy) {
                    alert('No policy to edit. Please generate a policy first.');
                    return;
                }
                UI.get('policyEditor').value = AppState.currentPolicyData.policy;
                UI.hide('ai-policy');
                UI.show('policyEditor');
                UI.setText('togglePolicyEditButton', 'Finish Editing');
                UI.enable('prompt');
                UI.get('policyEditor').focus();
            }
            AppState.isPolicyEditing = !AppState.isPolicyEditing;
        },

        /**
         * Handle accepting the generated policy and generating proposed changes.
         */
        handleAcceptPolicy: () => {
            if (!AppState.currentPolicyData) {
                alert('No policy to accept. Please generate a policy first.');
                return;
            }

            UI.showSpinnerInButton(UI.get('acceptPolicyButton'), 'Proposing Changes...');
            UI.hide('regeneratePolicyButton');
            UI.hide('generatePolicyButton');
            UI.hide('regenerateProposalButton');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.show('cancelAiOperationButton');
            UI.disable('prompt');
            
            UI.hide('policyEditor');
            UI.setText('togglePolicyEditButton', 'Edit Policy');
            AppState.isPolicyEditing = false;
            UI.setHtml('apply-result-content', '');
            UI.hide('propose-browser-error-logging-result-container');
            UI.setHtml('propose-browser-error-logging-result', '');


            const formData = { scriptId: AppState.currentPolicyData.scriptId, prompt: AppState.currentPolicyData.userPrompt, policy: AppState.currentPolicyData.policy };

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            console.log('Generating code proposal...');
            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for processPrompt (after policy).');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('acceptPolicyButton'));
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');

                    if (response.status === 'proposal') {
                        AppState.currentProposal = response;
                        UI.setText('proposal-purpose', response.purpose || 'No description provided.');
                        
                        UI.setHtml('html-validation-warnings', '');
                        let hasHtmlErrors = false;

                        response.proposedFiles.forEach(file => {
                            if (file.type === 'HTML') {
                                const validationResult = Utils.validateHtml(file.source, file.name);
                                if (!validationResult.isValid) {
                                    hasHtmlErrors = true;
                                    const warningP = document.createElement('p');
                                    warningP.textContent = validationResult.message;
                                    UI.get('html-validation-warnings').appendChild(warningP);
                                }
                            }
                        });

                        if (hasHtmlErrors) {
                            UI.show('html-validation-warnings');
                        }

                        Utils.displayFileComparison(response.originalFiles, response.proposedFiles, response.deletedFileNames);
                        UI.show('proposal-container');
                        Handlers._switchToTabAndScroll('ai-operations-tab', 'proposal-container'); // Add this line
                        UI.show('applyChangesNoDeployButton');
                        UI.show('applyAndDeployButton');
                        UI.show('regenerateProposalButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    } else if (response.status === 'error') {
                        UI.appendNotification('apply-result-content', 'is-danger', 'Failed to generate proposal.', response.message);
                        UI.show('apply-result-container');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    } else {
                        UI.appendNotification('apply-result-content', 'is-warning', 'Unexpected response status:', response);
                        UI.show('apply-result-container');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for processPrompt (after policy).');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('acceptPolicyButton'));
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');

                    UI.appendNotification('apply-result-content', 'is-danger', 'Error calling AI:', error.message);
                    UI.show('apply-result-container');
                    UI.show('regeneratePolicyButton');
                    UI.hide('generatePolicyButton');
                })
                .processPrompt(formData);
        },

        /**
         * Handle canceling any active AI operation.
         */
        handleCancelAiOperation: () => {
            Handlers.resetAiOperationUI();
            alert('AI operation canceled by user.');
        },

        /**
         * Handle regenerating the AI policy.
         */
        handleRegeneratePolicy: () => {
            const scriptId = Utils.getEffectiveScriptId();
            const promptText = UI.get('prompt').value;

            if (!scriptId) {
                alert('Please select or enter a Script ID.');
                return;
            }
            if (!promptText.trim()) {
                alert('Prompt cannot be empty.');
                return;
            }

            Utils.saveScriptIdToLocalStorage(scriptId);

            UI.showSpinnerInButton(UI.get('regeneratePolicyButton'), 'Regenerating Policy...');
            UI.hide('generatePolicyButton');
            UI.hide('acceptPolicyButton');
            
            UI.disable('prompt');
            UI.show('cancelAiOperationButton');

            UI.hide('policy-container');
            UI.hide('proposal-container');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('regenerateProposalButton');
            UI.hide('apply-result-container');
            UI.hide('fixApplyErrorsButton');
            UI.setHtml('proposed-files-display', '');
            UI.setHtml('ai-policy', '');
            UI.setText('proposal-purpose', '');
            UI.hide('html-validation-warnings');
            UI.setHtml('html-validation-warnings', '');
            UI.hide('policyEditor');
            UI.setText('togglePolicyEditButton', 'Edit Policy');
            AppState.isPolicyEditing = false;
            UI.setHtml('apply-result-content', '');
            UI.hide('propose-browser-error-logging-result-container');
            UI.setHtml('propose-browser-error-logging-result', '');


            AppState.currentPolicyData = null;
            AppState.currentProposal = null;

            const formData = { scriptId: scriptId, prompt: promptText };

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            console.log('Regenerating policy...');
            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for regeneratePolicy.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('regeneratePolicyButton'));
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');

                    if (response.status === 'policy') {
                        AppState.currentPolicyData = response;
                        UI.setHtml('ai-policy', marked.parse(response.policy));
                        UI.show('policy-container');
                        Handlers._switchToTabAndScroll('ai-operations-tab', 'policy-container'); // Add this line
                        UI.show('acceptPolicyButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    } else if (response.status === 'error') {
                        UI.setText('ai-policy', 'Error: ' + response.message);
                        UI.show('policy-container');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for regeneratePolicy.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('regeneratePolicyButton'));
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');

                    UI.setText('ai-policy', 'Error regenerating policy: ' + error.message);
                    UI.show('policy-container');
                    UI.show('regeneratePolicyButton');
                    UI.hide('generatePolicyButton');
                })
                .generateProposalPolicy(formData);
        },

        /**
         * Handle applying proposed changes to the script.
         * @param {boolean} autoDeploy - Whether to automatically deploy after applying changes.
         * @param {HTMLElement} clickedButton - The button element that was clicked.
         */
        handleApplyChanges: (autoDeploy, clickedButton) => {
            if (!AppState.currentProposal) {
                UI.appendNotification('apply-result-content', 'is-danger', 'No proposal to apply.');
                UI.show('apply-result-container');
                return;
            }

            Utils.saveScriptIdToLocalStorage(AppState.currentProposal.scriptId);

            UI.showSpinnerInButton(clickedButton, autoDeploy ? 'Applying & Deploying...' : 'Applying Changes...');
            
            // Disable other related buttons
            if (clickedButton.id === 'applyChangesNoDeployButton') {
                UI.disable('applyAndDeployButton');
            } else {
                UI.disable('applyChangesNoDeployButton');
            }
            UI.disable('regenerateProposalButton');
            UI.disable('fixApplyErrorsButton');
            UI.disable('proposeBrowserErrorLoggingButton');

            UI.hide('fixApplyErrorsButton');
            UI.setHtml('apply-result-content', `
                <div class="notification is-info is-light">
                <p>Applying changes...</p>
                ${autoDeploy ? '<p>Auto-deploying...</p>' : ''}
                </div>
            `);
            UI.show('apply-result-container');

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(clickedButton);
                    UI.enable('applyChangesNoDeployButton');
                    UI.enable('applyAndDeployButton');
                    UI.enable('regenerateProposalButton');
                    UI.enable('fixApplyErrorsButton');
                    UI.enable('proposeBrowserErrorLoggingButton');
                    UI.setHtml('apply-result-content', '');

                    if (response.status === 'success') {
                        UI.appendNotification('apply-result-content', 'is-success', Utils.escapeHtml(response.message));

                        if (autoDeploy) {
                            const deployMessageContainer = document.createElement('article');
                            deployMessageContainer.className = 'message mt-3';

                            let headerText = 'Auto-deploy Result';
                            let messageBodyContent = '';
                            let messageClass = '';

                            if (response.deploymentStatus === 'success') {
                                messageClass = 'is-success';
                                headerText += ' (Success)';
                                messageBodyContent += `
                                    <ul>
                                    <li><strong>Status:</strong> Success</li>
                                    <li><strong>Message:</strong> ${Utils.escapeHtml(response.deploymentMessage)}</li>
                                `;
                                if (response.deploymentId) {
                                    messageBodyContent += `<li><strong>Deployment ID:</strong> ${Utils.escapeHtml(response.deploymentId)}</li>`;
                                }
                                if (response.webappUrl && response.webappUrl !== 'null') {
                                    messageBodyContent += `<li><strong>Web App URL:</strong> <a href="${Utils.escapeHtml(response.webappUrl)}" target="_blank">${Utils.escapeHtml(response.webappUrl)}</a></li>`;
                                } else if (response.webappUrl === null) {
                                    messageBodyContent += `<li><strong>Web App URL:</strong> Not found in deployment response.</li>`;
                                }
                                messageBodyContent += `</ul>`;
                            } else if (response.deploymentStatus === 'error') {
                                messageClass = 'is-danger';
                                headerText += ' (Error)';
                                messageBodyContent += `
                                    <ul>
                                    <li><strong>Status:</strong> Error</li>
                                    <li><strong>Message:</strong> ${Utils.escapeHtml(response.deploymentMessage)}</li>
                                `;
                                if (response.deploymentId) {
                                    messageBodyContent += `<li><strong>Deployment ID:</strong> ${Utils.escapeHtml(response.deploymentId)}</li>`;
                                }
                                messageBodyContent += `</ul>`;
                            } else {
                                messageClass = 'is-warning';
                                headerText += ' (Unknown Status)';
                                messageBodyContent += `
                                    <ul>
                                    <li><strong>Status:</strong> Unknown</li>
                                    <li><strong>Message:</strong> ${Utils.escapeHtml(response.deploymentMessage)}</li>
                                    </ul>
                                `;
                            }
                            
                            deployMessageContainer.classList.add(messageClass);
                            deployMessageContainer.innerHTML = `
                                <div class="message-header">
                                <p>${headerText}</p>
                                </div>
                                <div class="message-body">
                                ${messageBodyContent}
                                </div>
                            `;
                            UI.get('apply-result-content').appendChild(deployMessageContainer);
                        }

                        AppState.currentProposal = null;
                        UI.hide('applyChangesNoDeployButton');
                        UI.hide('applyAndDeployButton');
                        UI.hide('regenerateProposalButton');
                        UI.setHtml('proposed-files-display', '<p>Changes applied successfully. You can propose new changes or check logs.</p>');
                        UI.hide('html-validation-warnings');
                        UI.setHtml('html-validation-warnings', '');
                        UI.hide('fixApplyErrorsButton');
                    } else {
                        UI.appendNotification('apply-result-content', 'is-danger', `Failed to Apply Changes: ${Utils.escapeHtml(response.message)}`, response.apiErrorDetails || response.fullErrorText);
                        UI.show('fixApplyErrorsButton');
                    }
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(clickedButton);
                    UI.enable('applyChangesNoDeployButton');
                    UI.enable('applyAndDeployButton');
                    UI.enable('regenerateProposalButton');
                    UI.enable('fixApplyErrorsButton');
                    UI.enable('proposeBrowserErrorLoggingButton');
                    UI.appendNotification('apply-result-content', 'is-danger', 'Error applying changes (Uncaught):', error.message);
                    UI.show('fixApplyErrorsButton');
                })
                .applyProposedChanges(AppState.currentProposal.scriptId, AppState.currentProposal.proposedFiles, AppState.currentProposal.deletedFileNames, autoDeploy, AppState.currentProposal.purpose);
        },

        /**
         * Handle canceling any active AI operation.
         */
        handleCancelAiOperation: () => {
            Handlers.resetAiOperationUI();
            alert('AI operation canceled by user.');
        },

        /**
         * Handle regenerating the AI policy.
         */
        handleRegeneratePolicy: () => {
            const scriptId = Utils.getEffectiveScriptId();
            const promptText = UI.get('prompt').value;

            if (!scriptId) {
                alert('Please select or enter a Script ID.');
                return;
            }
            if (!promptText.trim()) {
                alert('Prompt cannot be empty.');
                return;
            }

            Utils.saveScriptIdToLocalStorage(scriptId);

            UI.showSpinnerInButton(UI.get('regeneratePolicyButton'), 'Regenerating Policy...');
            UI.hide('generatePolicyButton');
            UI.hide('acceptPolicyButton');
            
            UI.disable('prompt');
            UI.show('cancelAiOperationButton');

            UI.hide('policy-container');
            UI.hide('proposal-container');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('regenerateProposalButton');
            UI.hide('apply-result-container');
            UI.hide('fixApplyErrorsButton');
            UI.setHtml('proposed-files-display', '');
            UI.setHtml('ai-policy', '');
            UI.setText('proposal-purpose', '');
            UI.hide('html-validation-warnings');
            UI.setHtml('html-validation-warnings', '');
            UI.hide('policyEditor');
            UI.setText('togglePolicyEditButton', 'Edit Policy');
            AppState.isPolicyEditing = false;
            UI.setHtml('apply-result-content', '');
            UI.hide('propose-browser-error-logging-result-container');
            UI.setHtml('propose-browser-error-logging-result', '');


            AppState.currentPolicyData = null;
            AppState.currentProposal = null;

            const formData = { scriptId: scriptId, prompt: promptText };

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            console.log('Regenerating policy...');
            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for regeneratePolicy.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('regeneratePolicyButton'));
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');

                    if (response.status === 'policy') {
                        AppState.currentPolicyData = response;
                        UI.setHtml('ai-policy', marked.parse(response.policy));
                        UI.show('policy-container');
                        Handlers._switchToTabAndScroll('ai-operations-tab', 'policy-container'); // Add this line
                        UI.show('acceptPolicyButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    } else if (response.status === 'error') {
                        UI.setText('ai-policy', 'Error: ' + response.message);
                        UI.show('policy-container');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for regeneratePolicy.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('regeneratePolicyButton'));
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');

                    UI.setText('ai-policy', 'Error regenerating policy: ' + error.message);
                    UI.show('policy-container');
                    UI.show('regeneratePolicyButton');
                    UI.hide('generatePolicyButton');
                })
                .generateProposalPolicy(formData);
        },

        /**
         * Handle applying proposed changes to the script.
         * @param {boolean} autoDeploy - Whether to automatically deploy after applying changes.
         * @param {HTMLElement} clickedButton - The button element that was clicked.
         */
        handleApplyChanges: (autoDeploy, clickedButton) => {
            if (!AppState.currentProposal) {
                UI.appendNotification('apply-result-content', 'is-danger', 'No proposal to apply.');
                UI.show('apply-result-container');
                return;
            }

            Utils.saveScriptIdToLocalStorage(AppState.currentProposal.scriptId);

            UI.showSpinnerInButton(clickedButton, autoDeploy ? 'Applying & Deploying...' : 'Applying Changes...');
            
            // Disable other related buttons
            if (clickedButton.id === 'applyChangesNoDeployButton') {
                UI.disable('applyAndDeployButton');
            } else {
                UI.disable('applyChangesNoDeployButton');
            }
            UI.disable('regenerateProposalButton');
            UI.disable('fixApplyErrorsButton');
            UI.disable('proposeBrowserErrorLoggingButton');

            UI.hide('fixApplyErrorsButton');
            UI.setHtml('apply-result-content', `
                <div class="notification is-info is-light">
                <p>Applying changes...</p>
                ${autoDeploy ? '<p>Auto-deploying...</p>' : ''}
                </div>
            `);
            UI.show('apply-result-container');

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(clickedButton);
                    UI.enable('applyChangesNoDeployButton');
                    UI.enable('applyAndDeployButton');
                    UI.enable('regenerateProposalButton');
                    UI.enable('fixApplyErrorsButton');
                    UI.enable('proposeBrowserErrorLoggingButton');
                    UI.setHtml('apply-result-content', '');

                    if (response.status === 'success') {
                        UI.appendNotification('apply-result-content', 'is-success', Utils.escapeHtml(response.message));

                        if (autoDeploy) {
                            const deployMessageContainer = document.createElement('article');
                            deployMessageContainer.className = 'message mt-3';

                            let headerText = 'Auto-deploy Result';
                            let messageBodyContent = '';
                            let messageClass = '';

                            if (response.deploymentStatus === 'success') {
                                messageClass = 'is-success';
                                headerText += ' (Success)';
                                messageBodyContent += `
                                    <ul>
                                    <li><strong>Status:</strong> Success</li>
                                    <li><strong>Message:</strong> ${Utils.escapeHtml(response.deploymentMessage)}</li>
                                `;
                                if (response.deploymentId) {
                                    messageBodyContent += `<li><strong>Deployment ID:</strong> ${Utils.escapeHtml(response.deploymentId)}</li>`;
                                }
                                if (response.webappUrl && response.webappUrl !== 'null') {
                                    messageBodyContent += `<li><strong>Web App URL:</strong> <a href="${Utils.escapeHtml(response.webappUrl)}" target="_blank">${Utils.escapeHtml(response.webappUrl)}</a></li>`;
                                } else if (response.webappUrl === null) {
                                    messageBodyContent += `<li><strong>Web App URL:</strong> Not found in deployment response.</li>`;
                                }
                                messageBodyContent += `</ul>`;
                            } else if (response.deploymentStatus === 'error') {
                                messageClass = 'is-danger';
                                headerText += ' (Error)';
                                messageBodyContent += `
                                    <ul>
                                    <li><strong>Status:</strong> Error</li>
                                    <li><strong>Message:</strong> ${Utils.escapeHtml(response.deploymentMessage)}</li>
                                `;
                                if (response.deploymentId) {
                                    messageBodyContent += `<li><strong>Deployment ID:</strong> ${Utils.escapeHtml(response.deploymentId)}</li>`;
                                }
                                messageBodyContent += `</ul>`;
                            } else {
                                messageClass = 'is-warning';
                                headerText += ' (Unknown Status)';
                                messageBodyContent += `
                                    <ul>
                                    <li><strong>Status:</strong> Unknown</li>
                                    <li><strong>Message:</strong> ${Utils.escapeHtml(response.deploymentMessage)}</li>
                                    </ul>
                                `;
                            }
                            
                            deployMessageContainer.classList.add(messageClass);
                            deployMessageContainer.innerHTML = `
                                <div class="message-header">
                                <p>${headerText}</p>
                                </div>
                                <div class="message-body">
                                ${messageBodyContent}
                                </div>
                            `;
                            UI.get('apply-result-content').appendChild(deployMessageContainer);
                        }

                        AppState.currentProposal = null;
                        UI.hide('applyChangesNoDeployButton');
                        UI.hide('applyAndDeployButton');
                        UI.hide('regenerateProposalButton');
                        UI.setHtml('proposed-files-display', '<p>Changes applied successfully. You can propose new changes or check logs.</p>');
                        UI.hide('html-validation-warnings');
                        UI.setHtml('html-validation-warnings', '');
                        UI.hide('fixApplyErrorsButton');
                    } else {
                        UI.appendNotification('apply-result-content', 'is-danger', `Failed to Apply Changes: ${Utils.escapeHtml(response.message)}`, response.apiErrorDetails || response.fullErrorText);
                        UI.show('fixApplyErrorsButton');
                    }
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(clickedButton);
                    UI.enable('applyChangesNoDeployButton');
                    UI.enable('applyAndDeployButton');
                    UI.enable('regenerateProposalButton');
                    UI.enable('fixApplyErrorsButton');
                    UI.enable('proposeBrowserErrorLoggingButton');
                    UI.appendNotification('apply-result-content', 'is-danger', 'Error applying changes (Uncaught):', error.message);
                    UI.show('fixApplyErrorsButton');
                })
                .applyProposedChanges(AppState.currentProposal.scriptId, AppState.currentProposal.proposedFiles, AppState.currentProposal.deletedFileNames, autoDeploy, AppState.currentProposal.purpose);
        },

        /**
         * Handle regenerating the AI proposal.
         */
        handleRegenerateProposal: () => {
            if (!AppState.currentPolicyData || !AppState.currentPolicyData.scriptId || !AppState.currentPolicyData.userPrompt || !AppState.currentPolicyData.policy) {
                alert('Cannot regenerate proposal. Policy data is missing.');
                return;
            }

            const scriptId = AppState.currentPolicyData.scriptId;
            const promptText = AppState.currentPolicyData.userPrompt;
            const policyText = AppState.currentPolicyData.policy;

            UI.showSpinnerInButton(UI.get('regenerateProposalButton'), 'Regenerating Proposal...');
            UI.disable('applyChangesNoDeployButton');
            UI.disable('applyAndDeployButton');
            UI.disable('prompt');
            UI.show('cancelAiOperationButton');
            UI.disable('proposeBrowserErrorLoggingButton');


            UI.hide('proposal-container');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('apply-result-container');
            UI.hide('fixApplyErrorsButton');
            UI.setHtml('proposed-files-display', '');
            UI.setText('proposal-purpose', '');
            UI.setHtml('apply-result-content', '');
            UI.hide('html-validation-warnings');
            UI.setHtml('html-validation-warnings', '');
            UI.hide('propose-browser-error-logging-result-container');
            UI.setHtml('propose-browser-error-logging-result', '');


            AppState.currentProposal = null;

            const formData = { scriptId: scriptId, prompt: promptText, policy: policyText };

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            console.log('Regenerating AI proposed changes...');
            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for regenerateProposal.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('regenerateProposalButton'));
                    UI.enable('applyChangesNoDeployButton');
                    UI.enable('applyAndDeployButton');
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');
                    UI.enable('proposeBrowserErrorLoggingButton');


                    if (response.status === 'proposal') {
                        AppState.currentProposal = response;
                        UI.setText('proposal-purpose', response.purpose || 'No description provided.');
                        
                        UI.setHtml('html-validation-warnings', '');
                        let hasHtmlErrors = false;

                        response.proposedFiles.forEach(file => {
                            if (file.type === 'HTML') {
                                const validationResult = Utils.validateHtml(file.source, file.name);
                                if (!validationResult.isValid) {
                                    hasHtmlErrors = true;
                                    const warningP = document.createElement('p');
                                    warningP.textContent = validationResult.message;
                                    UI.get('html-validation-warnings').appendChild(warningP);
                                }
                            }
                        });

                        if (hasHtmlErrors) {
                            UI.show('html-validation-warnings');
                        }

                        Utils.displayFileComparison(response.originalFiles, response.proposedFiles, response.deletedFileNames);
                        UI.show('proposal-container');
                        Handlers._switchToTabAndScroll('ai-operations-tab', 'proposal-container'); // Add this line
                        UI.show('applyChangesNoDeployButton');
                        UI.show('applyAndDeployButton');
                        UI.show('regenerateProposalButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    } else if (response.status === 'error') {
                        UI.appendNotification('apply-result-content', 'is-danger', 'Failed to regenerate proposal.', response.message);
                        UI.show('apply-result-container');
                        UI.show('regenerateProposalButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for regenerateProposal.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('regenerateProposalButton'));
                    UI.enable('applyChangesNoDeployButton');
                    UI.enable('applyAndDeployButton');
                    UI.enable('prompt');
                    UI.hide('cancelAiOperationButton');
                    UI.enable('proposeBrowserErrorLoggingButton');

                    UI.appendNotification('apply-result-content', 'is-danger', 'Error regenerating proposal:', error.message);
                    UI.show('apply-result-container');
                    UI.show('regenerateProposalButton');
                    UI.show('regeneratePolicyButton');
                    UI.hide('generatePolicyButton');
                })
                .processPrompt(formData);
        },

        /**
         * Handle fixing apply errors using AI.
         */
        handleFixApplyErrors: () => {
            const scriptId = Utils.getEffectiveScriptId();
            if (!scriptId) {
                UI.appendNotification('apply-result-content', 'is-danger', 'Script ID is required to fix errors.');
                UI.show('apply-result-container');
                return;
            }

            UI.showSpinnerInButton(UI.get('fixApplyErrorsButton'), 'Fixing Errors...');
            UI.hide('generatePolicyButton');
            UI.hide('regeneratePolicyButton');
            UI.disable('prompt');
            UI.show('cancelFixErrorsButton');
            UI.hide('regenerateProposalButton');
            UI.hide('proposal-container');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('apply-result-container');
            UI.setHtml('apply-result-content', '');
            UI.setHtml('proposed-files-display', '');
            UI.hide('html-validation-warnings');
            UI.setHtml('html-validation-warnings', '');
            UI.disable('proposeBrowserErrorLoggingButton');


            Utils.saveScriptIdToLocalStorage(scriptId);

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for fixErrorsFromLogs.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('fixApplyErrorsButton'));
                    UI.enable('prompt');
                    UI.hide('cancelFixErrorsButton');
                    UI.enable('proposeBrowserErrorLoggingButton');


                    if (response.status === 'proposal') {
                        AppState.currentProposal = response;
                        UI.setText('proposal-purpose', response.purpose || 'No description provided.');
                        
                        UI.setHtml('html-validation-warnings', '');
                        let hasHtmlErrors = false;

                        response.proposedFiles.forEach(file => {
                            if (file.type === 'HTML') {
                                const validationResult = Utils.validateHtml(file.source, file.name);
                                if (!validationResult.isValid) {
                                    hasHtmlErrors = true;
                                    const warningP = document.createElement('p');
                                    warningP.textContent = validationResult.message;
                                    UI.get('html-validation-warnings').appendChild(warningP);
                                }
                            }
                        });

                        if (hasHtmlErrors) {
                            UI.show('html-validation-warnings');
                        }

                        Utils.displayFileComparison(response.originalFiles, response.proposedFiles, response.deletedFileNames);
                        UI.show('proposal-container');
                        Handlers._switchToTabAndScroll('ai-operations-tab', 'proposal-container'); // Add this line
                        UI.show('applyChangesNoDeployButton');
                        UI.show('applyAndDeployButton');
                        UI.show('regenerateProposalButton');
                        UI.hide('fixApplyErrorsButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    } else if (response.status === 'error') {
                        UI.appendNotification('apply-result-content', 'is-danger', 'Failed to get error fix proposal.', response.message);
                        UI.show('apply-result-container');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for fixErrorsFromLogs.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('fixApplyErrorsButton'));
                    UI.enable('prompt');
                    UI.hide('cancelFixErrorsButton');
                    UI.enable('proposeBrowserErrorLoggingButton');

                    UI.appendNotification('apply-result-content', 'is-danger', 'Error calling AI for fix:', error.message);
                    UI.show('apply-result-container');
                    UI.show('regeneratePolicyButton');
                    UI.hide('generatePolicyButton');
                })
                .fixErrorsFromLogs(scriptId);
        },

        /**
         * Handle submit for the fix errors form.
         * @param {Event} e - The submit event.
         */
        handleFixErrorsFormSubmit: (e) => {
            e.preventDefault();

            const scriptId = Utils.getEffectiveScriptId();
            if (!scriptId) {
                UI.appendNotification('apply-result-content', 'is-danger', 'Script ID is required to fix errors.');
                UI.show('apply-result-container');
                return;
            }

            UI.showSpinnerInButton(UI.get('fixErrorsButton'), 'Fixing Errors...');
            UI.hide('generatePolicyButton');
            UI.hide('regeneratePolicyButton');
            UI.disable('prompt');
            UI.show('cancelFixErrorsButton');
            UI.hide('regenerateProposalButton');
            UI.hide('proposal-container');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('apply-result-container');
            UI.hide('fixApplyErrorsButton');
            UI.setHtml('proposed-files-display', '');
            UI.setText('proposal-purpose', '');
            UI.setHtml('apply-result-content', '');
            UI.hide('html-validation-warnings');
            UI.setHtml('html-validation-warnings', '');
            UI.disable('proposeBrowserErrorLoggingButton');


            Utils.saveScriptIdToLocalStorage(scriptId);

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for fixErrorsFromLogs (via form submit).');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('fixErrorsButton'));
                    UI.enable('prompt');
                    UI.hide('cancelFixErrorsButton');
                    UI.enable('proposeBrowserErrorLoggingButton');


                    if (response.status === 'proposal') {
                        AppState.currentProposal = response;
                        UI.setText('proposal-purpose', response.purpose || 'No description provided.');
                        
                        UI.setHtml('html-validation-warnings', '');
                        let hasHtmlErrors = false;

                        response.proposedFiles.forEach(file => {
                            if (file.type === 'HTML') {
                                const validationResult = Utils.validateHtml(file.source, file.name);
                                if (!validationResult.isValid) {
                                    hasHtmlErrors = true;
                                    const warningP = document.createElement('p');
                                    warningP.textContent = validationResult.message;
                                    UI.get('html-validation-warnings').appendChild(warningP);
                                }
                            }
                        });

                        if (hasHtmlErrors) {
                            UI.show('html-validation-warnings');
                        }

                        Utils.displayFileComparison(response.originalFiles, response.proposedFiles, response.deletedFileNames);
                        UI.show('proposal-container');
                        Handlers._switchToTabAndScroll('ai-operations-tab', 'proposal-container'); // Add this line
                        UI.show('applyChangesNoDeployButton');
                        UI.show('applyAndDeployButton');
                        UI.show('regenerateProposalButton');
                        UI.hide('fixApplyErrorsButton');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    } else if (response.status === 'error') {
                        UI.appendNotification('apply-result-content', 'is-danger', 'Failed to get error fix proposal.', response.message);
                        UI.show('apply-result-container');
                        UI.show('regeneratePolicyButton');
                        UI.hide('generatePolicyButton');
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for fixErrorsFromLogs (via form submit).');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('fixErrorsButton'));
                    UI.enable('prompt');
                    UI.hide('cancelFixErrorsButton');
                    UI.enable('proposeBrowserErrorLoggingButton');

                    UI.appendNotification('apply-result-content', 'is-danger', 'Error calling AI for fix:', error.message);
                    UI.show('apply-result-container');
                    UI.show('regeneratePolicyButton');
                    UI.hide('generatePolicyButton');
                })
                .fixErrorsFromLogs(scriptId);
        },

        /**
         * Handle proposing browser error logging changes for the target script.
         */
        handleProposeBrowserErrorLogging: () => {
            const scriptId = Utils.getEffectiveScriptId();
            if (!scriptId) {
                alert('Please select or enter a Script ID for the target script.');
                return;
            }

            UI.showSpinnerInButton(UI.get('proposeBrowserErrorLoggingButton'), 'Proposing...');
            UI.disable('prompt');
            UI.hide('generatePolicyButton');
            UI.hide('regeneratePolicyButton');
            UI.hide('acceptPolicyButton');
            UI.hide('regenerateProposalButton');
            UI.hide('applyChangesNoDeployButton');
            UI.hide('applyAndDeployButton');
            UI.hide('fixApplyErrorsButton');
            UI.hide('policy-container');
            UI.hide('apply-result-container');
            UI.setHtml('apply-result-content', '');
            UI.hide('html-validation-warnings');
            UI.setHtml('html-validation-warnings', '');
            
            // Clear previous proposal display
            UI.setHtml('proposed-files-display', '');
            UI.setText('proposal-purpose', '');
            UI.hide('proposal-container');
            
            UI.show('propose-browser-error-logging-result-container');
            UI.setText('propose-browser-error-logging-result', 'Generating proposal for browser error logging...');

            Utils.saveScriptIdToLocalStorage(scriptId);

            const requestId = Date.now();
            AppState.activeRequestId = requestId;

            google.script.run
                .withSuccessHandler(function(response) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale success response for proposeBrowserErrorLoggingChanges.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('proposeBrowserErrorLoggingButton'));
                    UI.enable('prompt');
                    UI.show('generatePolicyButton'); // Restore AI operation buttons
                    UI.hide('propose-browser-error-logging-result-container'); // Hide temporary result

                    if (response.status === 'proposal') {
                        AppState.currentProposal = response;
                        // Switch to AI Operations tab and display the proposal
                        // const aiOperationsTab = document.querySelector('.tabs li[data-tab-content-id="ai-operations-tab"]');
                        // if (aiOperationsTab) aiOperationsTab.click();
                        Handlers._switchToTabAndScroll('ai-operations-tab', 'proposal-container'); // Use the new helper

                        UI.setText('proposal-purpose', response.purpose || 'No description provided.');
                        
                        UI.setHtml('html-validation-warnings', '');
                        let hasHtmlErrors = false;

                        response.proposedFiles.forEach(file => {
                            if (file.type === 'HTML') {
                                const validationResult = Utils.validateHtml(file.source, file.name);
                                if (!validationResult.isValid) {
                                    hasHtmlErrors = true;
                                    const warningP = document.createElement('p');
                                    warningP.textContent = validationResult.message;
                                    UI.get('html-validation-warnings').appendChild(warningP);
                                }
                            }
                        });

                        if (hasHtmlErrors) {
                            UI.show('html-validation-warnings');
                        }

                        Utils.displayFileComparison(response.originalFiles, response.proposedFiles, response.deletedFileNames);
                        UI.show('proposal-container');
                        UI.show('applyChangesNoDeployButton');
                        UI.show('applyAndDeployButton');
                        UI.show('regenerateProposalButton');
                        UI.hide('fixApplyErrorsButton');
                        // Ensure Policy related buttons are hidden/shown correctly if this flow bypasses policy generation
                        UI.hide('policy-container');
                        UI.hide('acceptPolicyButton');
                        UI.hide('regeneratePolicyButton'); // Regenerate proposal handles its own button
                        UI.hide('generatePolicyButton'); // Start over button
                    } else if (response.status === 'error') {
                        UI.appendNotification('apply-result-content', 'is-danger', 'Failed to generate proposal.', response.message);
                        UI.show('apply-result-container');
                        UI.show('generatePolicyButton'); // Restore original AI button
                    } else {
                        UI.appendNotification('apply-result-content', 'is-warning', 'Unexpected response status:', response);
                        UI.show('apply-result-container');
                        UI.show('generatePolicyButton'); // Restore original AI button
                    }
                })
                .withFailureHandler(function(error) {
                    if (AppState.activeRequestId !== requestId) {
                        console.log('Ignoring stale failure response for proposeBrowserErrorLoggingChanges.');
                        return;
                    }
                    AppState.activeRequestId = null;
                    UI.hideSpinnerInButton(UI.get('proposeBrowserErrorLoggingButton'));
                    UI.enable('prompt');
                    UI.show('generatePolicyButton'); // Restore AI operation buttons

                    UI.appendNotification('propose-browser-error-logging-result', 'is-danger', 'Error generating browser error logging proposal:', error.message);
                    UI.show('propose-browser-error-logging-result-container');
                })
                .proposeBrowserErrorLoggingChanges(scriptId);
        },
        /**
         * Handle saving the GCP Project ID.
         */
        handleSaveGcpProjectId: () => {
            const gcpProjectId = UI.get('gcpProjectId').value.trim();
            const saveButton = UI.get('saveGcpProjectIdButton');

            UI.show('gcp-save-result-container');
            UI.setText('gcp-save-result', 'Saving...');
            UI.showSpinnerInButton(saveButton, 'Saving...');

            if (!gcpProjectId) {
                UI.setText('gcp-save-result', 'Error: GCP Project ID cannot be empty.');
                UI.show('gcp-save-result-container');
                UI.hideSpinnerInButton(saveButton);
                return;
            }

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.setText('gcp-save-result', response.message);
                    UI.hideSpinnerInButton(saveButton);
                    if (response.status === 'success') {
                        Utils.saveGcpProjectIdToLocalStorage(gcpProjectId);
                    }
                })
                .withFailureHandler(function(error) {
                    UI.setText('gcp-save-result', 'Error saving GCP Project ID: ' + error.message);
                    UI.hideSpinnerInButton(saveButton);
                })
                .setGcpProjectId(gcpProjectId);
        },

        /**
         * Handle submit for the log retrieval form.
         * @param {Event} e - The submit event.
         */
        handleLogFormSubmit: (e) => {
            e.preventDefault();
            const submitButton = UI.get('getLogsButton');

            UI.showSpinnerInButton(submitButton, 'Getting Logs...');
            UI.hide('log-result-container');
            UI.setHtml('log-result', ''); // Use setHtml to clear for structured logs

            const scriptId = Utils.getEffectiveScriptId();
            Utils.saveScriptIdToLocalStorage(scriptId);

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(submitButton);
                    UI.displayLogs(response); // Use the new UI.displayLogs function
                    UI.show('log-result-container');
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(submitButton);
                    UI.setHtml('log-result', `<p class="has-text-danger">Error: ${Utils.escapeHtml(error.message)}</p>`); // Use setHtml for error messages
                    UI.show('log-result-container');
                })
                .getScriptLogs(scriptId);
        },

        /**
         * Handle submit for the deploy form.
         * @param {Event} e - The submit event.
         */
        handleDeployFormSubmit: (e) => {
            e.preventDefault();
            const submitButton = UI.get('deployButton');

            UI.showSpinnerInButton(submitButton, 'Deploying...');
            UI.hide('deploy-result-container');
            UI.setText('deploy-result', '');

            const scriptId = Utils.getEffectiveScriptId();
            const description = UI.get('deploymentDescription').value;
            Utils.saveScriptIdToLocalStorage(scriptId);

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(submitButton);
                    UI.show('deploy-result-container');
                    if (response.status === 'success') {
                        let webappUrlHtml = `Web App URL: ${response.webappUrl}`;
                        if (response.webappUrl && response.webappUrl !== 'null') {
                            webappUrlHtml = `Web App URL: <a href="${response.webappUrl}" target="_blank">${response.webappUrl}</a>`;
                        } else if (response.webappUrl === null) {
                            webappUrlHtml = `Web App URL: Not found in deployment response.`;
                        }
                        UI.setHtml('deploy-result', `${response.message}<br>Deployment ID: ${response.deploymentId}<br>${webappUrlHtml}`);
                    } else {
                        UI.setText('deploy-result', `Error: ${response.message}`);
                    }
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(submitButton);
                    UI.show('deploy-result-container');
                    UI.setText('deploy-result', `Error deploying script: ${error.message}`);
                })
                .deployScript(scriptId, description);
        },

        /**
         * Handle submit for the add library form.
         * @param {Event} e - The submit event.
         */
        handleAddLibraryFormSubmit: (e) => {
            e.preventDefault();
            const submitButton = UI.get('addLibraryButton');

            UI.showSpinnerInButton(submitButton, 'Adding Library...');
            UI.hide('add-library-result-container');
            UI.setText('add-library-result', '');

            const targetScriptId = Utils.getEffectiveScriptId();
            const libraryScriptId = UI.get('libraryScriptId').value.trim();
            const libraryVersion = UI.get('libraryVersion').value.trim();

            if (!targetScriptId) {
                UI.setText('add-library-result', 'Error: Please select or enter a Target Script ID.');
                UI.show('add-library-result-container');
                UI.hideSpinnerInButton(submitButton);
                return;
            }
            if (!libraryScriptId) {
                UI.setText('add-library-result', 'Error: Library Script ID cannot be empty.');
                UI.show('add-library-result-container');
                UI.hideSpinnerInButton(submitButton);
                return;
            }

            Utils.saveScriptIdToLocalStorage(targetScriptId);

            const effectiveVersion = libraryVersion.trim() === '' ? 'HEAD' : libraryVersion.trim();

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(submitButton);
                    UI.show('add-library-result-container');
                    if (response.status === 'success') {
                        UI.setText('add-library-result', response.message);
                        UI.clearValue('libraryScriptId');
                        UI.clearValue('libraryVersion');
                    } else {
                        UI.setText('add-library-result', `Error: ${response.message}`);
                    }
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(submitButton);
                    UI.show('add-library-result-container');
                    UI.setText('add-library-result', `Error adding library: ${error.message}`);
                })
                .addLibraryToProject(targetScriptId, libraryScriptId, effectiveVersion);
        },

        /**
         * Loads and displays comprehensive script details (URL, files, scopes, versions) in the summary section.
         */
        loadScriptDetailsSummary: () => {
            const scriptId = Utils.getEffectiveScriptId();
            const summaryContainer = UI.get('scriptDetailsSummaryContainer');
            const editorUrlDisplay = UI.get('editorUrlDisplay');
            const summaryFilesDisplay = UI.get('summaryFilesDisplay');
            const summaryOAuthScopesDisplay = UI.get('summaryOAuthScopesDisplay');
            const summaryVersionsDisplay = UI.get('summaryVersionsDisplay');
            const summaryVersionSelect = UI.get('summaryVersionSelect');
            const summaryOpenWebAppButton = UI.get('summaryOpenWebAppButton');
            const summaryRevertVersionButton = UI.get('summaryRevertVersionButton');
            const summaryOpenWebAppMessage = UI.get('summaryOpenWebAppMessage');

            UI.hide(summaryContainer); // Hide initially to show loading state cleanly
            if (!scriptId) {
                UI.setHtml(editorUrlDisplay, 'Apps Script Editor URL: (Script ID needed)');
                UI.setHtml(summaryFilesDisplay, '<p class="has-text-grey">No script selected.</p>');
                UI.setHtml(summaryOAuthScopesDisplay, '<p class="has-text-grey">No script selected.</p>');
                UI.setHtml(summaryVersionsDisplay, '<p class="has-text-grey">No script selected.</p>');
                UI.disable(summaryOpenWebAppButton);
                UI.disable(summaryRevertVersionButton);
                UI.setText(summaryOpenWebAppMessage, '');
                UI.setHtml(summaryVersionSelect, '<option value="">-- Select a Script ID first --</option>');
                return;
            }

            UI.show(summaryContainer);
            Utils.saveScriptIdToLocalStorage(scriptId);

            // 1. Editor URL
            UI.setHtml(editorUrlDisplay, 'Apps Script Editor URL: <span class="spinner" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin: 0 5px;"></span> Loading...');
            google.script.run
                .withSuccessHandler(function(url) {
                    if (url.startsWith("Error:")) {
                        UI.setText(editorUrlDisplay, `Apps Script Editor URL: ${url}`);
                    } else {
                        UI.setHtml(editorUrlDisplay, `Apps Script Editor URL: <a href="${url}" target="_blank">${url}</a>`);
                    }
                })
                .withFailureHandler(function(error) {
                    UI.setText(editorUrlDisplay, `Apps Script Editor URL: Error - ${Utils.escapeHtml(error.message)}`);
                })
                .getScriptEditorUrl(scriptId);

            // 2. Files List
            UI.setHtml(summaryFilesDisplay, `<p><span class="spinner" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 8px;"></span>Loading files...</p>`);
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.status === 'success') {
                        if (response.files && response.files.length > 0) {
                            UI.setHtml(summaryFilesDisplay, '');
                            response.files.forEach(file => {
                                const fileItem = document.createElement('div');
                                fileItem.className = 'file-item';

                                let typeClass = '';
                                let typeText = '';

                                switch (file.type) {
                                    case 'SERVER_JS': typeClass = 'is-server-js'; typeText = 'JS'; break;
                                    case 'JSON': typeClass = 'is-json'; typeText = 'JSON'; break;
                                    case 'HTML': typeClass = 'is-html'; typeText = 'HTML'; break;
                                    default: typeClass = 'is-unknown'; typeText = 'UNKNOWN';
                                }
                                
                                fileItem.classList.add(typeClass);

                                fileItem.innerHTML = `
                                    <div class="file-type-badge">${typeText}</div>
                                    <div class="file-name">${Utils.escapeHtml(file.name)}.${Utils.getFileExtension(file.type)}</div>
                                `;
                                summaryFilesDisplay.appendChild(fileItem);
                            });
                        } else {
                            UI.setHtml(summaryFilesDisplay, '<p>No files found in this script.</p>');
                        }
                    } else {
                        UI.setHtml(summaryFilesDisplay, `<p class="has-text-danger">Error retrieving files: ${Utils.escapeHtml(response.message)}</p>`);
                        if (response.apiErrorDetails) {
                            UI.setHtml(summaryFilesDisplay, UI.get('summaryFilesDisplay').innerHTML + `<pre class="has-text-danger-dark is-size-7 mt-2">${Utils.escapeHtml(JSON.stringify(response.apiErrorDetails, null, 2))}</pre>`);
                        }
                    }
                })
                .withFailureHandler(function(error) {
                    UI.setHtml(summaryFilesDisplay, `<p class="has-text-danger">Error calling server function: ${Utils.escapeHtml(error.message)}</p>`);
                })
                .listTargetScriptFiles(scriptId);

            // 3. OAuth Scopes
            UI.setHtml(summaryOAuthScopesDisplay, `<p><span class="spinner" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 8px;"></span>Loading OAuth scopes...</p>`);
            google.script.run
                .withSuccessHandler(function(response) {
                    if (response.status === 'success') {
                        UI.displayOAuthScopes(response.scopes, summaryOAuthScopesDisplay);
                    } else {
                        UI.setHtml(summaryOAuthScopesDisplay, ''); // Clear loading message before appending error
                        UI.appendNotification(summaryOAuthScopesDisplay, 'is-danger', `OAuthスコープの取得中にエラーが発生しました: ${response.message}`, response.apiErrorDetails);
                    }
                })
                .withFailureHandler(function(error) {
                    UI.setHtml(summaryOAuthScopesDisplay, ''); // Clear loading message
                    UI.appendNotification(summaryOAuthScopesDisplay, 'is-danger', `サーバー関数呼び出し中にエラーが発生しました: ${Utils.escapeHtml(error.message)}`);
                })
                .getProjectOAuthScopes(scriptId);

            // 4. Version Info
            UI.setHtml(summaryVersionsDisplay, `<p><span class="spinner" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 8px;"></span>Loading versions...</p>`);
            UI.disable(summaryVersionSelect);
            UI.disable(summaryRevertVersionButton);
            UI.disable(summaryOpenWebAppButton);
            UI.setText(summaryOpenWebAppMessage, '');
            google.script.run
                .withSuccessHandler(function(response) {
                    UI.enable(summaryVersionSelect);
                    UI.setHtml(summaryVersionsDisplay, ''); // Clear spinner message

                    if (response.status === 'success') {
                        UI.setHtml(summaryVersionSelect, '<option value="">-- Select a version --</option>');
                        if (response.versions && response.versions.length > 0) {
                            response.versions.forEach(version => {
                                const option = document.createElement('option');
                                option.value = version.versionNumber;
                                option.textContent = `Version ${version.versionNumber} (Created: ${new Date(version.createTime).toLocaleString()}) - ${version.description}`;
                                if (version.webappUrl !== null) {
                                    option.dataset.webappUrl = version.webappUrl;
                                } else {
                                    option.dataset.webappUrl = 'null';
                                }
                                summaryVersionSelect.appendChild(option);
                            });
                        } else {
                            UI.setHtml(summaryVersionSelect, '<option value="">-- No versions found --</option>');
                        }
                        // Manually trigger change event for the summary version select to update buttons
                        summaryVersionSelect.dispatchEvent(new Event('change'));
                    }
                    else {
                        UI.setHtml(summaryVersionSelect, '<option value="">-- Error loading versions --</option>');
                        UI.appendNotification(summaryVersionsDisplay, 'is-danger', `バージョン情報の取得中にエラーが発生しました: ${response.message}`, response.apiErrorDetails);
                        UI.disable(summaryOpenWebAppButton);
                        UI.disable(summaryRevertVersionButton);
                        UI.setText(summaryOpenWebAppMessage, '');
                    }
                })
                .withFailureHandler(function(error) {
                    UI.enable(summaryVersionSelect);
                    UI.setHtml(summaryVersionsDisplay, ''); // Clear spinner message
                    UI.setHtml(summaryVersionSelect, '<option value="">-- Error loading versions --</option>');
                    UI.appendNotification(summaryVersionsDisplay, 'is-danger', `サーバー関数呼び出し中にエラーが発生しました: ${Utils.escapeHtml(error.message)}`);
                    UI.disable(summaryOpenWebAppButton);
                    UI.disable(summaryRevertVersionButton);
                    UI.setText(summaryOpenWebAppMessage, '');
                })
                .listScriptVersions(scriptId);
        },

        /**
         * Handle change event for the summary version select dropdown.
         */
        handleSummaryVersionSelectChange: () => {
            const versionsSelect = UI.get('summaryVersionSelect');
            const selectedOption = versionsSelect.options[versionsSelect.selectedIndex];

            // Enable/disable revert button based on selection
            UI.get('summaryRevertVersionButton').disabled = !selectedOption.value;

            // Enable/disable open web app button based on webappUrl in dataset
            const webappUrl = selectedOption.dataset.webappUrl;

            if (selectedOption.value && webappUrl && webappUrl !== 'null') {
                UI.enable('summaryOpenWebAppButton');
                UI.setText('summaryOpenWebAppMessage', '');
            } else if (selectedOption.value && (webappUrl === 'null' || !webappUrl)) {
                UI.disable('summaryOpenWebAppButton');
                UI.setText('summaryOpenWebAppMessage', 'No web app URL for this version.');
            } else {
                UI.disable('summaryOpenWebAppButton');
                UI.setText('summaryOpenWebAppMessage', '');
            }
        },

        /**
         * Handle opening the web app URL for the selected version from summary.
         */
        handleSummaryOpenWebApp: () => {
            const versionsSelect = UI.get('summaryVersionSelect');
            const selectedOption = versionsSelect.options[versionsSelect.selectedIndex];
            const webappUrl = selectedOption.dataset.webappUrl;

            if (webappUrl && webappUrl !== 'null') {
                window.open(webappUrl, '_blank');
            } else {
                alert('No web app URL found for the selected version, or URL is invalid.');
            }
        },

        /**
         * Handle reverting to a specific script version from summary.
         */
        handleSummaryRevertVersion: () => {
            const scriptId = Utils.getEffectiveScriptId();
            const versionSelect = UI.get('summaryVersionSelect');
            const selectedVersion = versionSelect.value;
            const revertButton = UI.get('summaryRevertVersionButton');
            const summaryVersionsDisplay = UI.get('summaryVersionsDisplay');
            const summaryOpenWebAppButton = UI.get('summaryOpenWebAppButton');
            const summaryOpenWebAppMessage = UI.get('summaryOpenWebAppMessage');
            
            if (!scriptId) {
                UI.appendNotification(summaryVersionsDisplay, 'is-danger', 'エラー: スクリプトIDを選択または入力してください。');
                return;
            }
            if (!selectedVersion) {
                UI.appendNotification(summaryVersionsDisplay, 'is-danger', 'エラー: リバートするバージョンを選択してください。');
                return;
            }

            if (!confirm(`スクリプトID ${scriptId} をバージョン ${selectedVersion} にリバートします。この操作は元に戻せません。続行しますか？`)) {
                return;
            }

            UI.showSpinnerInButton(revertButton, 'Reverting...');
            UI.disable(versionSelect);
            UI.disable(summaryOpenWebAppButton);
            UI.setText(summaryOpenWebAppMessage, '');
            UI.setHtml(summaryVersionsDisplay, `<p><span class="spinner" style="width: 16px; height: 16px; vertical-align: middle; margin-right: 8px;"></span>Reverting script to version ${selectedVersion}...</p>`);

            Utils.saveScriptIdToLocalStorage(scriptId);

            google.script.run
                .withSuccessHandler(function(response) {
                    UI.hideSpinnerInButton(revertButton);
                    UI.enable(versionSelect);
                    UI.setHtml(summaryVersionsDisplay, ''); // Clear loading message

                    if (response.status === 'success') {
                        UI.appendNotification(summaryVersionsDisplay, 'is-success', response.message);
                        // After revert, refresh the summary details
                        Handlers.loadScriptDetailsSummary();
                    } else {
                        UI.appendNotification(summaryVersionsDisplay, 'is-danger', `エラー: ${response.message}`, response.apiErrorDetails);
                        UI.disable(summaryOpenWebAppButton);
                        UI.setText(summaryOpenWebAppMessage, '');
                    }
                })
                .withFailureHandler(function(error) {
                    UI.hideSpinnerInButton(revertButton);
                    UI.enable(versionSelect);
                    UI.disable(summaryOpenWebAppButton);
                    UI.setText(summaryOpenWebAppMessage, '');
                    UI.setHtml(summaryVersionsDisplay, ''); // Clear loading message
                    UI.appendNotification(summaryVersionsDisplay, 'is-danger', `サーバー関数呼び出し中にエラーが発生しました: ${Utils.escapeHtml(error.message)}`);
                })
                .revertToVersion(scriptId, parseInt(selectedVersion));
        }
    };
</script>
