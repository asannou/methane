<script>
    let currentPolicyData = null;
    let currentProposal = null;
    let activeRequestId = null;
    let isPolicyEditing = false;

    // Map to store original button HTML content
    const originalButtonContents = new Map();

    /**
     * Shows a loading spinner directly within the button.
     * Stores the button's original content and disables it.
     * @param {HTMLElement} buttonElement - The button element to modify.
     * @param {string} [loadingText="Loading..."] - Optional text to display next to the spinner.
     */
    function showSpinnerInButton(buttonElement, loadingText = "Loading...") {
        if (!buttonElement) return;
        originalButtonContents.set(buttonElement.id, buttonElement.innerHTML);
        buttonElement.innerHTML = `<span class="spinner button-spinner"></span> ${loadingText}`;
        buttonElement.disabled = true;
        buttonElement.classList.add('is-loading-button'); // Add a class for potential button-specific loading styles
    }

    /**
     * Hides the loading spinner and restores the button's original content and state.
     * @param {HTMLElement} buttonElement - The button element to restore.
     */
    function hideSpinnerInButton(buttonElement) {
        if (!buttonElement || !originalButtonContents.has(buttonElement.id)) return;
        buttonElement.innerHTML = originalButtonContents.get(buttonElement.id);
        buttonElement.disabled = false;
        buttonElement.classList.remove('is-loading-button');
        originalButtonContents.delete(buttonElement.id); // Clean up map
    }

    // Helper to get a button element by ID and handle cases where it might not exist (e.g. for initially hidden buttons)
    function getButton(id) {
        return document.getElementById(id);
    }

    function getEffectiveScriptId() {
        const manualId = document.getElementById('scriptIdManualInput').value.trim();
        if (manualId) {
            return manualId;
        }
        return document.getElementById('scriptIdSelect').value.trim();
    }

    function saveScriptIdToLocalStorage(id) {
        if (id) {
            localStorage.setItem('targetScriptId', id);
        }
    }

    function saveGcpProjectIdToLocalStorage(id) {
        if (id) {
            localStorage.setItem('gcpProjectId', id);
        }
    }

    function loadProjectsIntoDropdown(selectedId = null) {
        const scriptIdSelect = document.getElementById('scriptIdSelect');

        scriptIdSelect.innerHTML = '<option value="">-- Select or type manually --</option>';

        google.script.run
            .withSuccessHandler(function(response) {
                if (response.status === 'success') {
                    response.projects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = project.title;
                        scriptIdSelect.appendChild(option);
                    });
                    if (selectedId) {
                        scriptIdSelect.value = selectedId;
                    }
                } else {
                    alert('Failed to load Apps Script projects: ' + response.message);
                }
            })
            .withFailureHandler(function(error) {
                alert('Error loading Apps Script projects: ' + error.message);
            })
            .listAppsScriptProjects();
    }

    function updateEditorUrlDisplay() {
        const scriptId = getEffectiveScriptId();
        const editorUrlDisplayDiv = document.getElementById('editor-url-display');
        
        editorUrlDisplayDiv.innerHTML = '';

        if (!scriptId) {
            editorUrlDisplayDiv.textContent = 'Apps Script Editor URL: (Script ID needed)';
            return;
        }

        // This spinner is not in a button, so its existing style remains
        editorUrlDisplayDiv.innerHTML = 'Apps Script Editor URL: <span class="spinner" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin: 0 5px;"></span> Loading...';

        saveScriptIdToLocalStorage(scriptId);

        google.script.run
            .withSuccessHandler(function(response) {
                if (response.startsWith("Error:")) {
                    editorUrlDisplayDiv.textContent = `Apps Script Editor URL: ${response}`;
                } else {
                    editorUrlDisplayDiv.innerHTML = `Apps Script Editor URL: <a href="${response}" target="_blank">${response}</a>`;
                }
            })
            .withFailureHandler(function(error) {
                editorUrlDisplayDiv.textContent = `Apps Script Editor URL: Error - ${error.message}`;
            })
            .getScriptEditorUrl(scriptId);
    }

    document.addEventListener('DOMContentLoaded', function() {
      const scriptIdManualInput = document.getElementById('scriptIdManualInput');
      const gcpProjectIdInput = document.getElementById('gcpProjectId');
      const openWebAppButton = getButton('openWebAppButton');
      const openWebAppMessage = document.getElementById('openWebAppMessage');

      const savedScriptId = localStorage.getItem('targetScriptId');
      if (savedScriptId) {
        scriptIdManualInput.value = savedScriptId;
      }

      const savedGcpProjectId = localStorage.getItem('gcpProjectId');
      if (savedGcpProjectId) {
        gcpProjectIdInput.value = savedGcpProjectId;
      }

      loadProjectsIntoDropdown(savedScriptId);

      document.getElementById('policy-container').style.display = 'none';
      document.getElementById('proposal-container').style.display = 'none';
      getButton('applyChangesNoDeployButton').style.display = 'none';
      getButton('applyAndDeployButton').style.display = 'none';
      getButton('regenerateProposalButton').style.display = 'none';
      document.getElementById('apply-result-container').style.display = 'none';
      getButton('fixApplyErrorsButton').style.display = 'none';

      // Ensure correct initial state for policy buttons
      getButton('generatePolicyButton').style.display = 'inline-block';
      getButton('regeneratePolicyButton').style.display = 'none';
      
      document.getElementById('version-result-container').style.display = 'none';
      document.getElementById('filesListContainer').style.display = 'none';
      openWebAppButton.disabled = true; // Set initial state for the new button
      openWebAppMessage.textContent = ''; // Clear initial message

      updateEditorUrlDisplay();

      const promptTextarea = document.getElementById('prompt');
      if (promptTextarea) {
        promptTextarea.addEventListener('keydown', function(event) {
          if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
            event.preventDefault();
            document.getElementById('agent-form').requestSubmit(document.getElementById('generatePolicyButton'));
          }
        });
      }

      // Tab logic
      const tabs = document.querySelectorAll('.tabs li');
      const tabContents = document.querySelectorAll('.tab-content');

      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          tabs.forEach(item => item.classList.remove('is-active'));
          this.classList.add('is-active');

          const targetId = this.dataset.tabContentId;
          tabContents.forEach(content => {
            if (content.id === targetId) {
              content.classList.add('is-active-content');
            } else {
              content.classList.remove('is-active-content');
            }
          });
        });
      });

      // Initially activate the first tab
      if (tabs.length > 0) {
        tabs[0].click();
      }

    });

    document.getElementById('scriptIdSelect').addEventListener('change', updateEditorUrlDisplay);
    document.getElementById('scriptIdManualInput').addEventListener('input', updateEditorUrlDisplay);

    function validateHtml(htmlString, fileName) {
        console.log(`HTML validation started for file: ${fileName}`);
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlString, 'text/html');
        const parseError = doc.querySelector('parsererror');

        if (parseError) {
            const errorMessage = parseError.textContent;
            console.error(`HTML validation failed in ${fileName}:`, errorMessage);
            return { isValid: false, message: `Syntax error found in HTML file "${fileName}": ${errorMessage}` };
        }
        console.log(`HTML validation successful for file: ${fileName}`);
        return { isValid: true };
    }

    function generateFormattedDiffPanels(originalSource, proposedSource) {
        const originalLines = originalSource ? originalSource.split('\n') : [];
        const proposedLines = proposedSource ? proposedSource.split('\n') : [];

        const diffResult = [];
        let i = 0;
        let j = 0;
        const lookAheadWindow = 5;

        while (i < originalLines.length || j < proposedLines.length) {
            const currentOriginalLine = originalLines[i];
            const currentProposedLine = proposedLines[j];

            if (i < originalLines.length && j < proposedLines.length && currentOriginalLine === currentProposedLine) {
                diffResult.push({ type: 'equal', original: currentOriginalLine, proposed: currentProposedLine });
                i++;
                j++;
            } else {
                let originalFoundInProposedAhead = -1;
                for (let k = j + 1; k < Math.min(j + 1 + lookAheadWindow, proposedLines.length); k++) {
                    if (i < originalLines.length && originalLines[i] === proposedLines[k]) {
                        originalFoundInProposedAhead = k;
                        break;
                    }
                }

                let proposedFoundInOriginalAhead = -1;
                for (let k = i + 1; k < Math.min(i + 1 + lookAheadWindow, originalLines.length); k++) {
                    if (j < proposedLines.length && proposedLines[j] === originalLines[k]) {
                        proposedFoundInOriginalAhead = k;
                        break;
                    }
                }

                if (i < originalLines.length && j < proposedLines.length && originalFoundInProposedAhead === -1 && proposedFoundInOriginalAhead === -1) {
                    diffResult.push({ type: 'modified', original: currentOriginalLine, proposed: currentProposedLine });
                    i++;
                    j++;
                } else if (originalFoundInProposedAhead !== -1 && (proposedFoundInOriginalAhead === -1 || (originalFoundInProposedAhead - j) <= (proposedFoundInOriginalAhead - i))) {
                    diffResult.push({ type: 'added', original: '', proposed: currentProposedLine });
                    j++;
                } else if (proposedFoundInOriginalAhead !== -1 && (originalFoundInProposedAhead === -1 || (proposedFoundInOriginalAhead - i) < (originalFoundInProposedAhead - j))) {
                    diffResult.push({ type: 'removed', original: currentOriginalLine, proposed: '' });
                    i++;
                } else if (i < originalLines.length) {
                    diffResult.push({ type: 'removed', original: currentOriginalLine, proposed: '' });
                    i++;
                } else if (j < proposedLines.length) {
                    diffResult.push({ type: 'added', original: '', proposed: currentProposedLine });
                    j++;
                }
            }
        }

        const OMIT_THRESHOLD = 8;
        const CONTEXT_LINES = 3;

        let originalLineNumbersHtml = '';
        let originalCodeContentHtml = '';
        let proposedLineNumbersHtml = '';
        let proposedCodeContentHtml = '';

        let currentOriginalLineNum = 1;
        let currentProposedLineNum = 1;

        let k = 0;
        while (k < diffResult.length) {
            const entry = diffResult[k];

            if (entry.type === 'equal') {
                let equalBlockStartIndex = k;
                let equalCount = 0;

                while (k < diffResult.length && diffResult[k].type === 'equal') {
                    equalCount++;
                    k++;
                }

                if (equalCount > OMIT_THRESHOLD) {
                    for (let l = 0; l < CONTEXT_LINES; l++) {
                        const lineEntry = diffResult[equalBlockStartIndex + l];
                        originalLineNumbersHtml += `<div>${currentOriginalLineNum}</div>`;
                        originalCodeContentHtml += `<div class="diff-line-equal">${escapeHtml(lineEntry.original)}</div>`;
                        proposedLineNumbersHtml += `<div>${currentProposedLineNum}</div>`;
                        proposedCodeContentHtml += `<div class="diff-line-equal">${escapeHtml(lineEntry.proposed)}</div>`;
                        currentOriginalLineNum++;
                        currentProposedLineNum++;
                    }

                    const omittedLinesCount = equalCount - (2 * CONTEXT_LINES);
                    const originalOmittedStart = currentOriginalLineNum;
                    const proposedOmittedStart = currentProposedLineNum;

                    currentOriginalLineNum += omittedLinesCount;
                    currentProposedLineNum += omittedLinesCount;

                    originalLineNumbersHtml += `<div class="diff-line-omitted">${originalOmittedStart}-${currentOriginalLineNum - 1}</div>`;
                    originalCodeContentHtml += `<div class="diff-line-omitted">... ${omittedLinesCount} lines omitted ...</div>`;
                    proposedLineNumbersHtml += `<div class="diff-line-omitted">${proposedOmittedStart}-${currentProposedLineNum - 1}</div>`;
                    proposedCodeContentHtml += `<div class="diff-line-omitted">... ${omittedLinesCount} lines omitted ...</div>`;

                    for (let l = 0; l < CONTEXT_LINES; l++) {
                        const lineEntry = diffResult[equalBlockStartIndex + equalCount - CONTEXT_LINES + l];
                        originalLineNumbersHtml += `<div>${currentOriginalLineNum}</div>`;
                        originalCodeContentHtml += `<div class="diff-line-equal">${escapeHtml(lineEntry.original)}</div>`;
                        proposedLineNumbersHtml += `<div>${currentProposedLineNum}</div>`;
                        proposedCodeContentHtml += `<div class="diff-line-equal">${escapeHtml(lineEntry.proposed)}</div>`;
                        currentOriginalLineNum++;
                        currentProposedLineNum++;
                    }

                } else {
                    for (let l = 0; l < equalCount; l++) {
                        const lineEntry = diffResult[equalBlockStartIndex + l];
                        originalLineNumbersHtml += `<div>${currentOriginalLineNum}</div>`;
                        originalCodeContentHtml += `<div class="diff-line-equal">${escapeHtml(lineEntry.original)}</div>`;
                        proposedLineNumbersHtml += `<div>${currentProposedLineNum}</div>`;
                        proposedCodeContentHtml += `<div class="diff-line-equal">${escapeHtml(lineEntry.proposed)}</div>`;
                        currentOriginalLineNum++;
                        currentProposedLineNum++;
                    }
                }
            } else {
                if (entry.type === 'added') {
                    originalLineNumbersHtml += `<div>&nbsp;</div>`;
                    originalCodeContentHtml += `<div class="diff-line-empty-fill">&nbsp;</div>`;
                    proposedLineNumbersHtml += `<div>${currentProposedLineNum}</div>`;
                    proposedCodeContentHtml += `<div class="diff-line-added">${escapeHtml(entry.proposed)}</div>`;
                    currentProposedLineNum++;
                } else if (entry.type === 'removed') {
                    originalLineNumbersHtml += `<div>${currentOriginalLineNum}</div>`;
                    originalCodeContentHtml += `<div class="diff-line-removed">${escapeHtml(entry.original)}</div>`;
                    proposedLineNumbersHtml += `<div>&nbsp;</div>`;
                    proposedCodeContentHtml += `<div class="diff-line-empty-fill">&nbsp;</div>`;
                    currentOriginalLineNum++;
                } else if (entry.type === 'modified') {
                    originalLineNumbersHtml += `<div>${currentOriginalLineNum}</div>`;
                    originalCodeContentHtml += `<div class="diff-line-modified">${escapeHtml(entry.original)}</div>`;
                    proposedLineNumbersHtml += `<div>${currentProposedLineNum}</div>`;
                    proposedCodeContentHtml += `<div class="diff-line-modified">${escapeHtml(entry.proposed)}</div>`;
                    currentOriginalLineNum++;
                    currentProposedLineNum++;
                }
                k++;
            }
        }

        return {
            originalLineNumbersHtml, originalCodeContentHtml,
            proposedLineNumbersHtml, proposedCodeContentHtml
        };
    }

    function displayFileComparison(originalFiles, proposedFiles) {
      const displayArea = document.getElementById('proposed-files-display');
      displayArea.innerHTML = '';

      if (!proposedFiles || proposedFiles.length === 0) {
        displayArea.innerHTML = '<p>AI did not propose any changes to existing files, or no files were processed.</p>';
        return;
      }

      proposedFiles.forEach(proposedFile => {
          const name = proposedFile.name;
          const fileType = proposedFile.type;

          const originalFile = (originalFiles || []).find(f => f.name === name);
          const originalSource = originalFile ? originalFile.source : '';
          const proposedSource = proposedFile.source;

          const diffHtmlData = generateFormattedDiffPanels(originalSource, proposedSource);

          const fileComparisonDiv = document.createElement('div');
          fileComparisonDiv.className = 'file-comparison';

          const originalContentDiv = document.createElement('div');
          originalContentDiv.innerHTML = `<h4>${name}.${getFileExtension(fileType)} (Original)</h4><pre class="scroll-sync-target">
              <div class="line-numbers-col">${diffHtmlData.originalLineNumbersHtml}</div>
              <div class="code-content-col">${diffHtmlData.originalCodeContentHtml}</div>
          </pre>`;
          
          const proposedContentDiv = document.createElement('div');
          proposedContentDiv.innerHTML = `<h4>${name}.${getFileExtension(fileType)} (Proposed)</h4><pre class="scroll-sync-target">
              <div class="line-numbers-col">${diffHtmlData.proposedLineNumbersHtml}</div>
              <div class="code-content-col">${diffHtmlData.proposedCodeContentHtml}</div>
          </pre>`;
          
          fileComparisonDiv.appendChild(originalContentDiv);
          fileComparisonDiv.appendChild(proposedContentDiv);
          displayArea.appendChild(fileComparisonDiv);

          const preElements = fileComparisonDiv.querySelectorAll('.scroll-sync-target');
          if (preElements.length === 2) {
              const pre1 = preElements[0];
              const pre2 = preElements[1];

              let isSyncing = false;

              pre1.addEventListener('scroll', function() {
                  if (!isSyncing) {
                      isSyncing = true;
                      pre2.scrollTop = pre1.scrollTop;
                      isSyncing = false;
                  }
              });

              pre2.addEventListener('scroll', function() {
                  if (!isSyncing) {
                      isSyncing = true;
                      pre1.scrollTop = pre2.scrollTop;
                      isSyncing = false;
                  }
              });
          }
      });
    }

    function getFileExtension(type) {
      switch (type) {
        case 'SERVER_JS': return 'gs';
        case 'JSON': return 'json';
        default: return 'html';
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.appendChild(document.createTextNode(text));
      return div.innerHTML;
    }

    document.getElementById('agent-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const submitterId = e.submitter.id;

      const generatePolicyButton = getButton('generatePolicyButton');
      const regeneratePolicyButton = getButton('regeneratePolicyButton');
      const cancelAiOperationButton = getButton('cancelAiOperationButton');
      const promptInput = document.getElementById('prompt');
      const acceptPolicyButton = getButton('acceptPolicyButton');
      const regenerateProposalButton = getButton('regenerateProposalButton');
      const applyChangesNoDeployButton = getButton('applyChangesNoDeployButton');
      const applyAndDeployButton = getButton('applyAndDeployButton');


      const scriptId = getEffectiveScriptId();
      const promptText = promptInput.value;

      if (!scriptId) {
        alert('Please select or enter a Script ID.');
        return;
      }
      if (!promptText.trim()) {
        alert('Prompt cannot be empty.');
        return;
      }

      saveScriptIdToLocalStorage(scriptId);

      // Show spinner in the clicked button, hide others, disable all relevant buttons
      if (submitterId === 'generatePolicyButton') {
        showSpinnerInButton(generatePolicyButton, 'Generating Policy...');
        regeneratePolicyButton.style.display = 'none'; // Will be shown later if successful
      } else { // Should not happen for this form
        console.error("Unknown submitter for agent-form:", submitterId);
        return;
      }

      promptInput.readOnly = true;
      cancelAiOperationButton.style.display = 'inline-block';
      acceptPolicyButton.style.display = 'none';
      regenerateProposalButton.style.display = 'none';
      applyChangesNoDeployButton.style.display = 'none';
      applyAndDeployButton.style.display = 'none';
      document.getElementById('policy-container').style.display = 'none';
      document.getElementById('proposal-container').style.display = 'none';
      document.getElementById('apply-result-container').style.display = 'none';
      getButton('fixApplyErrorsButton').style.display = 'none';
      document.getElementById('proposed-files-display').innerHTML = '';
      document.getElementById('ai-policy').innerHTML = '';
      document.getElementById('html-validation-warnings').style.display = 'none';
      document.getElementById('html-validation-warnings').innerHTML = '';
      document.getElementById('version-result-container').style.display = 'none';
      document.getElementById('policyEditor').style.display = 'none';
      document.getElementById('togglePolicyEditButton').textContent = 'Edit Policy';
      isPolicyEditing = false;
      document.getElementById('apply-result-content').innerHTML = '';

      const formData = { scriptId: scriptId, prompt: promptText };

      const requestId = Date.now();
      activeRequestId = requestId;

      console.log('Generating policy...');
      google.script.run
        .withSuccessHandler(function(response) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale success response for generateProposalPolicy.');
            return;
          }
          activeRequestId = null;
          hideSpinnerInButton(generatePolicyButton); // Hide spinner on the clicked button
          cancelAiOperationButton.style.display = 'none';

          if (response.status === 'policy') {
            currentPolicyData = response;
            document.getElementById('ai-policy').innerHTML = marked.parse(response.policy);
            document.getElementById('policy-container').style.display = 'block';
            acceptPolicyButton.style.display = 'inline-block';
            regeneratePolicyButton.style.display = 'inline-block'; // Show Regenerate Policy button
            generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button is hidden
            promptInput.readOnly = false;
          } else if (response.status === 'error') {
            document.getElementById('ai-policy').textContent = 'Error: ' + response.message;
            document.getElementById('policy-container').style.display = 'block';
            promptInput.readOnly = false;
            generatePolicyButton.style.display = 'inline-block'; // Show Generate Policy on error
            regeneratePolicyButton.style.display = 'none'; // Hide Regenerate Policy
          }
        })
        .withFailureHandler(function(error) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale failure response for generateProposalPolicy.');
            return;
          }
          activeRequestId = null;
          hideSpinnerInButton(generatePolicyButton); // Hide spinner on the clicked button
          promptInput.readOnly = false;
          cancelAiOperationButton.style.display = 'none';
          document.getElementById('ai-policy').textContent = 'Error generating policy: ' + error.message;
          document.getElementById('policy-container').style.display = 'block';
          generatePolicyButton.style.display = 'inline-block'; // Show Generate Policy on error
          regeneratePolicyButton.style.display = 'none'; // Hide Regenerate Policy
        })
        .generateProposalPolicy(formData);
    });

    document.getElementById('togglePolicyEditButton').addEventListener('click', function() {
      const aiPolicyDiv = document.getElementById('ai-policy');
      const policyEditorTextarea = document.getElementById('policyEditor');
      const toggleButton = this;
      const promptInput = document.getElementById('prompt');

      if (isPolicyEditing) {
        currentPolicyData.policy = policyEditorTextarea.value;
        aiPolicyDiv.innerHTML = marked.parse(currentPolicyData.policy);
        aiPolicyDiv.style.display = 'block';
        policyEditorTextarea.style.display = 'none';
        toggleButton.textContent = 'Edit Policy';
        promptInput.readOnly = false;
      } else {
        if (!currentPolicyData || !currentPolicyData.policy) {
          alert('No policy to edit. Please generate a policy first.');
          return;
        }
        policyEditorTextarea.value = currentPolicyData.policy;
        aiPolicyDiv.style.display = 'none';
        policyEditorTextarea.style.display = 'block';
        toggleButton.textContent = 'Finish Editing';
        promptInput.readOnly = false;
        policyEditorTextarea.focus();
      }
      isPolicyEditing = !isPolicyEditing;
    });

    document.getElementById('acceptPolicyButton').addEventListener('click', function() {
      if (!currentPolicyData) {
        alert('No policy to accept. Please generate a policy first.');
        return;
      }

      const acceptPolicyButton = this;
      const cancelAiOperationButton = getButton('cancelAiOperationButton');
      const regeneratePolicyButton = getButton('regeneratePolicyButton');
      const regenerateProposalButton = getButton('regenerateProposalButton');
      const promptInput = document.getElementById('prompt');
      const generatePolicyButton = getButton('generatePolicyButton');

      showSpinnerInButton(acceptPolicyButton, 'Proposing Changes...');
      regeneratePolicyButton.style.display = 'none'; // Hide Regenerate Policy button during proposal generation
      generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button remains hidden
      regenerateProposalButton.style.display = 'none';
      getButton('applyChangesNoDeployButton').style.display = 'none';
      getButton('applyAndDeployButton').style.display = 'none';
      cancelAiOperationButton.style.display = 'inline-block';
      promptInput.readOnly = true;
      
      document.getElementById('policyEditor').style.display = 'none';
      document.getElementById('togglePolicyEditButton').textContent = 'Edit Policy';
      isPolicyEditing = false;
      document.getElementById('apply-result-content').innerHTML = '';

      const formData = { scriptId: currentPolicyData.scriptId, prompt: currentPolicyData.userPrompt, policy: currentPolicyData.policy };

      const requestId = Date.now();
      activeRequestId = requestId;

      console.log('Generating code proposal...');
      google.script.run
        .withSuccessHandler(function(response) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale success response for processPrompt (after policy).');
            return;
          }
          activeRequestId = null;
          hideSpinnerInButton(acceptPolicyButton); // Hide spinner on the clicked button
          promptInput.readOnly = false;
          cancelAiOperationButton.style.display = 'none';

          if (response.status === 'proposal') {
            currentProposal = response;
            document.getElementById('proposal-purpose').textContent = response.purpose || 'No description provided.';
            
            const htmlWarningsDiv = document.getElementById('html-validation-warnings');
            htmlWarningsDiv.innerHTML = '';
            let hasHtmlErrors = false;

            response.proposedFiles.forEach(file => {
                if (file.type === 'HTML') {
                    const validationResult = validateHtml(file.source, file.name);
                    if (!validationResult.isValid) {
                        hasHtmlErrors = true;
                        const warningP = document.createElement('p');
                        warningP.textContent = validationResult.message;
                        htmlWarningsDiv.appendChild(warningP);
                    }
                }
            });

            if (hasHtmlErrors) {
                htmlWarningsDiv.style.display = 'block';
            } else {
                htmlWarningsDiv.style.display = 'none';
            }

            displayFileComparison(response.originalFiles, response.proposedFiles);
            document.getElementById('proposal-container').style.display = 'block';
            getButton('applyChangesNoDeployButton').style.display = 'block';
            getButton('applyAndDeployButton').style.display = 'block';
            regenerateProposalButton.style.display = 'inline-block';
            regeneratePolicyButton.style.display = 'inline-block'; // Show Regenerate Policy button again
            generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button is hidden
          } else if (response.status === 'error') {
            const applyResultContent = document.getElementById('apply-result-content');
            applyResultContent.innerHTML = `
                <div class="notification is-danger">
                    <p><strong>Error:</strong> Failed to generate proposal.</p>
                    <p>${escapeHtml(response.message)}</p>
                </div>
            `;
            document.getElementById('apply-result-container').style.display = 'block';
            document.getElementById('proposal-container').style.display = 'block';
            regeneratePolicyButton.style.display = 'inline-block'; // Show Regenerate Policy button on error
            generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button is hidden
          } else {
            const applyResultContent = document.getElementById('apply-result-content');
            applyResultContent.innerHTML = `
                <div class="notification is-warning">
                    <p><strong>Unexpected response status:</strong></p>
                    <pre>${escapeHtml(JSON.stringify(response, null, 2))}</pre>
                </div>
            `;
            document.getElementById('apply-result-container').style.display = 'block';
            document.getElementById('proposal-container').style.display = 'block';
            regeneratePolicyButton.style.display = 'inline-block'; // Show Regenerate Policy button on unexpected response
            generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button is hidden
          }
        })
        .withFailureHandler(function(error) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale failure response for processPrompt (after policy).');
            return;
          }
          activeRequestId = null;
          hideSpinnerInButton(acceptPolicyButton); // Hide spinner on the clicked button
          promptInput.readOnly = false;
          cancelAiOperationButton.style.display = 'none';

          const applyResultContent = document.getElementById('apply-result-content');
          applyResultContent.innerHTML = `
              <div class="notification is-danger">
                  <p><strong>Error calling AI:</strong></p>
                  <p>${escapeHtml(error.message)}</p>
              </div>
          `;
          document.getElementById('apply-result-container').style.display = 'block';
          document.getElementById('proposal-container').style.display = 'block';
          regeneratePolicyButton.style.display = 'inline-block'; // Show Regenerate Policy button on failure
          generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button is hidden
        })
        .processPrompt(formData);
    });

    document.getElementById('cancelAiOperationButton').addEventListener('click', function() {
      activeRequestId = null;

      const generatePolicyButton = getButton('generatePolicyButton');
      const cancelAiOperationButton = getButton('cancelAiOperationButton');
      const acceptPolicyButton = getButton('acceptPolicyButton');
      const regeneratePolicyButton = getButton('regeneratePolicyButton');
      const regenerateProposalButton = getButton('regenerateProposalButton');
      const applyChangesNoDeployButton = getButton('applyChangesNoDeployButton');
      const applyAndDeployButton = getButton('applyAndDeployButton');
      const fixApplyErrorsButton = getButton('fixApplyErrorsButton');

      const policyContainer = document.getElementById('policy-container');
      const proposalContainer = document.getElementById('proposal-container');
      const applyResultContainer = document.getElementById('apply-result-container');
      const htmlWarningsDiv = document.getElementById('html-validation-warnings');
      const promptInput = document.getElementById('prompt');
      const policyEditorTextarea = document.getElementById('policyEditor');
      const togglePolicyEditButton = document.getElementById('togglePolicyEditButton');
      const applyResultContent = document.getElementById('apply-result-content');

      // Hide spinners and re-enable buttons that might have been loading
      hideSpinnerInButton(generatePolicyButton);
      hideSpinnerInButton(acceptPolicyButton);
      hideSpinnerInButton(regeneratePolicyButton);
      hideSpinnerInButton(regenerateProposalButton);
      hideSpinnerInButton(applyChangesNoDeployButton);
      hideSpinnerInButton(applyAndDeployButton);
      hideSpinnerInButton(fixApplyErrorsButton);
      
      promptInput.readOnly = false;
      cancelAiOperationButton.style.display = 'none';

      currentPolicyData = null;
      currentProposal = null;
      document.getElementById('ai-policy').innerHTML = '';
      document.getElementById('proposal-purpose').textContent = '';
      document.getElementById('proposed-files-display').innerHTML = '';
      applyResultContent.innerHTML = '';
      htmlWarningsDiv.style.display = 'none';
      htmlWarningsDiv.innerHTML = '';

      policyContainer.style.display = 'none';
      proposalContainer.style.display = 'none';
      acceptPolicyButton.style.display = 'none';
      regenerateProposalButton.style.display = 'none';
      applyChangesNoDeployButton.style.display = 'none';
      applyAndDeployButton.style.display = 'none';
      applyResultContainer.style.display = 'none';
      fixApplyErrorsButton.style.display = 'none';

      // Reset to initial state for policy buttons
      generatePolicyButton.style.display = 'inline-block';
      regeneratePolicyButton.style.display = 'none';

      policyEditorTextarea.style.display = 'none';
      togglePolicyEditButton.textContent = 'Edit Policy';
      isPolicyEditing = false;

      alert('AI operation canceled by user.');
    });

    document.getElementById('regeneratePolicyButton').addEventListener('click', function() {
      const scriptId = getEffectiveScriptId();
      const promptText = document.getElementById('prompt').value;

      if (!scriptId) {
        alert('Please select or enter a Script ID.');
        return;
      }
      if (!promptText.trim()) {
        alert('Prompt cannot be empty.');
        return;
      }

      saveScriptIdToLocalStorage(scriptId);

      const generatePolicyButton = getButton('generatePolicyButton');
      const acceptPolicyButton = getButton('acceptPolicyButton');
      const regeneratePolicyButton = this; // This is the button that was clicked
      const cancelAiOperationButton = getButton('cancelAiOperationButton');
      const policyContainer = document.getElementById('policy-container');
      const proposalContainer = document.getElementById('proposal-container');
      const applyChangesNoDeployButton = getButton('applyChangesNoDeployButton');
      const applyAndDeployButton = getButton('applyAndDeployButton');
      const regenerateProposalButton = getButton('regenerateProposalButton');
      const applyResultContainer = document.getElementById('apply-result-container');
      const fixApplyErrorsButton = getButton('fixApplyErrorsButton');
      const htmlWarningsDiv = document.getElementById('html-validation-warnings');
      const promptInput = document.getElementById('prompt');
      const policyEditorTextarea = document.getElementById('policyEditor');
      const togglePolicyEditButton = document.getElementById('togglePolicyEditButton');
      const applyResultContent = document.getElementById('apply-result-content');

      // Show spinner in the clicked button
      showSpinnerInButton(regeneratePolicyButton, 'Regenerating Policy...');
      generatePolicyButton.style.display = 'none'; // Keep Generate Policy button hidden
      acceptPolicyButton.style.display = 'none'; // Hide accept button
      
      promptInput.readOnly = true;
      cancelAiOperationButton.style.display = 'inline-block';

      policyContainer.style.display = 'none';
      proposalContainer.style.display = 'none';
      applyChangesNoDeployButton.style.display = 'none';
      applyAndDeployButton.style.display = 'none';
      regenerateProposalButton.style.display = 'none';
      applyResultContainer.style.display = 'none';
      fixApplyErrorsButton.style.display = 'none';
      document.getElementById('proposed-files-display').innerHTML = '';
      document.getElementById('ai-policy').innerHTML = '';
      document.getElementById('proposal-purpose').textContent = '';
      htmlWarningsDiv.style.display = 'none';
      htmlWarningsDiv.innerHTML = '';
      policyEditorTextarea.style.display = 'none';
      togglePolicyEditButton.textContent = 'Edit Policy';
      isPolicyEditing = false;
      applyResultContent.innerHTML = '';

      currentPolicyData = null;
      currentProposal = null;

      const formData = { scriptId: scriptId, prompt: promptText };

      const requestId = Date.now();
      activeRequestId = requestId;

      console.log('Regenerating policy...');
      google.script.run
        .withSuccessHandler(function(response) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale success response for regeneratePolicy.');
            return;
          }
          activeRequestId = null;
          hideSpinnerInButton(regeneratePolicyButton); // Hide spinner on the clicked button
          promptInput.readOnly = false;
          cancelAiOperationButton.style.display = 'none';

          if (response.status === 'policy') {
            currentPolicyData = response;
            document.getElementById('ai-policy').innerHTML = marked.parse(response.policy);
            policyContainer.style.display = 'block';
            acceptPolicyButton.style.display = 'inline-block';
            regeneratePolicyButton.style.display = 'inline-block'; // Show Regenerate Policy button
            generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button is hidden
          } else if (response.status === 'error') {
            document.getElementById('ai-policy').textContent = 'Error: ' + response.message;
            policyContainer.style.display = 'block';
            regeneratePolicyButton.style.display = 'inline-block'; // Show Regenerate Policy button on error
            generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button is hidden
          }
        })
        .withFailureHandler(function(error) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale failure response for regeneratePolicy.');
            return;
          }
          activeRequestId = null;
          hideSpinnerInButton(regeneratePolicyButton); // Hide spinner on the clicked button
          promptInput.readOnly = false;
          cancelAiOperationButton.style.display = 'none';

          document.getElementById('ai-policy').textContent = 'Error regenerating policy: ' + error.message;
          policyContainer.style.display = 'block';
          regeneratePolicyButton.style.display = 'inline-block'; // Show Regenerate Policy button on failure
          generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button is hidden
        })
        .generateProposalPolicy(formData);
    });

    document.getElementById('applyChangesNoDeployButton').addEventListener('click', function() {
      handleApplyChanges(false, this); // No deploy, pass clicked button
    });

    document.getElementById('applyAndDeployButton').addEventListener('click', function() {
      handleApplyChanges(true, this); // Deploy, pass clicked button
    });

    function handleApplyChanges(autoDeploy, clickedButton) {
      if (!currentProposal) {
        const applyResultContent = document.getElementById('apply-result-content');
        applyResultContent.innerHTML = `
            <div class="notification is-danger">
                <p><strong>Error:</strong> No proposal to apply.</p>
            </div>
        `;
        document.getElementById('apply-result-container').style.display = 'block';
        return;
      }

      saveScriptIdToLocalStorage(currentProposal.scriptId);

      const applyNoDeployButton = getButton('applyChangesNoDeployButton');
      const applyAndDeployButton = getButton('applyAndDeployButton');
      const applyResultContent = document.getElementById('apply-result-content');
      const fixApplyErrorsButton = getButton('fixApplyErrorsButton');
      const regenerateProposalButton = getButton('regenerateProposalButton');

      // Show spinner in the clicked button
      showSpinnerInButton(clickedButton, autoDeploy ? 'Applying & Deploying...' : 'Applying Changes...');
      
      // Disable other related buttons that are not loading a spinner within them
      if (clickedButton.id === 'applyChangesNoDeployButton') {
          applyAndDeployButton.disabled = true;
      } else {
          applyNoDeployButton.disabled = true;
      }
      regenerateProposalButton.disabled = true;
      fixApplyErrorsButton.disabled = true; // Disable fix apply errors button too if it's visible

      fixApplyErrorsButton.style.display = 'none';
      applyResultContent.innerHTML = `
        <div class="notification is-info is-light">
          <p>Applying changes...</p>
          ${autoDeploy ? '<p>Auto-deploying...</p>' : ''}
        </div>
      `;
      document.getElementById('apply-result-container').style.display = 'block';

      google.script.run
        .withSuccessHandler(function(response) {
          hideSpinnerInButton(clickedButton); // Hide spinner on the clicked button
          applyNoDeployButton.disabled = false; // Re-enable all apply buttons
          applyAndDeployButton.disabled = false;
          regenerateProposalButton.disabled = false;
          fixApplyErrorsButton.disabled = false;
          applyResultContent.innerHTML = '';

          if (response.status === 'success') {
            const successNotification = document.createElement('div');
            successNotification.className = 'notification is-success';
            successNotification.innerHTML = `<p><strong>${escapeHtml(response.message)}</strong></p>`;
            applyResultContent.appendChild(successNotification);

            if (autoDeploy) { // Only show deployment status if auto-deploy was attempted
              const deployMessageContainer = document.createElement('article');
              deployMessageContainer.className = 'message mt-3';

              let headerText = 'Auto-deploy Result';
              let messageBodyContent = '';
              let messageClass = '';

              if (response.deploymentStatus === 'success') {
                messageClass = 'is-success';
                headerText += ' (Success)';
                messageBodyContent += `
                  <ul>
                    <li><strong>Status:</strong> Success</li>
                    <li><strong>Message:</strong> ${escapeHtml(response.deploymentMessage)}</li>
                `;
                if (response.deploymentId) {
                  messageBodyContent += `<li><strong>Deployment ID:</strong> ${escapeHtml(response.deploymentId)}</li>`;
                }
                if (response.webappUrl && response.webappUrl !== 'null') { // Ensure webappUrl is a valid string, not 'null'
                  messageBodyContent += `<li><strong>Web App URL:</strong> <a href="${escapeHtml(response.webappUrl)}" target="_blank">${escapeHtml(response.webappUrl)}</a></li>`;
                } else if (response.webappUrl === null) { // Explicitly check for null from backend
                  messageBodyContent += `<li><strong>Web App URL:</strong> Not found in deployment response.</li>`;
                }
                messageBodyContent += `</ul>`;
              } else if (response.deploymentStatus === 'error') {
                messageClass = 'is-danger';
                headerText += ' (Error)';
                messageBodyContent += `
                  <ul>
                    <li><strong>Status:</strong> Error</li>
                    <li><strong>Message:</strong> ${escapeHtml(response.deploymentMessage)}</li>
                `;
                if (response.deploymentId) {
                  messageBodyContent += `<li><strong>Deployment ID:</strong> ${escapeHtml(response.deploymentId)}</li>`;
                }
                messageBodyContent += `</ul>`;
              } else { // This case should theoretically not be reached if autoDeploy is true
                messageClass = 'is-warning';
                headerText += ' (Unknown Status)';
                messageBodyContent += `
                  <ul>
                    <li><strong>Status:</strong> Unknown</li>
                    <li><strong>Message:</strong> ${escapeHtml(response.deploymentMessage)}</li>
                  </ul>
                `;
              }
              
              deployMessageContainer.classList.add(messageClass);
              deployMessageContainer.innerHTML = `
                <div class="message-header">
                  <p>${headerText}</p>
                </div>
                <div class="message-body">
                  ${messageBodyContent}
                </div>
              `;
              applyResultContent.appendChild(deployMessageContainer);
            }

            currentProposal = null;
            applyNoDeployButton.style.display = 'none';
            applyAndDeployButton.style.display = 'none';
            regenerateProposalButton.style.display = 'none';
            document.getElementById('proposed-files-display').innerHTML = '<p>Changes applied successfully. You can propose new changes or check logs.</p>';
            document.getElementById('html-validation-warnings').style.display = 'none';
            document.getElementById('html-validation-warnings').innerHTML = '';
            fixApplyErrorsButton.style.display = 'none';
          } else {
            const errorNotification = document.createElement('div');
            errorNotification.className = 'notification is-danger';
            let errorMessage = `<strong>Failed to Apply Changes:</strong> ${escapeHtml(response.message)}`;
            
            if (response.apiErrorDetails) {
                errorMessage += `<h4>API Error Details:</h4><pre>${escapeHtml(JSON.stringify(response.apiErrorDetails, null, 2))}</pre>`;
            } else if (response.fullErrorText) {
                errorMessage += `<h4>Raw API Response:</h4><pre>${escapeHtml(response.fullErrorText)}</pre>`;
            }
            errorNotification.innerHTML = `<p>${errorMessage}</p>`;
            applyResultContent.appendChild(errorNotification);
            fixApplyErrorsButton.style.display = 'block';
          }
        })
        .withFailureHandler(function(error) {
          hideSpinnerInButton(clickedButton); // Hide spinner on the clicked button
          applyNoDeployButton.disabled = false;
          applyAndDeployButton.disabled = false;
          regenerateProposalButton.disabled = false;
          fixApplyErrorsButton.disabled = false;
          applyResultContent.innerHTML = `
              <div class="notification is-danger">
                  <p><strong>Error applying changes (Uncaught):</strong></p>
                  <p>${escapeHtml(error.message)}</p>
              </div>
          `;
          fixApplyErrorsButton.style.display = 'block';
        })
        .applyProposedChanges(currentProposal.scriptId, currentProposal.proposedFiles, autoDeploy, currentProposal.purpose);
    }

    document.getElementById('fixApplyErrorsButton').addEventListener('click', function() {
      const scriptId = getEffectiveScriptId();
      if (!scriptId) {
        const applyResultContent = document.getElementById('apply-result-content');
        applyResultContent.innerHTML = `
            <div class="notification is-danger">
                <p><strong>Error:</strong> Script ID is required to fix errors.</p>
            </div>
        `;
        document.getElementById('apply-result-container').style.display = 'block';
        return;
      }

      const fixButton = this;
      const proposalContainer = document.getElementById('proposal-container');
      const applyNoDeployButton = getButton('applyChangesNoDeployButton');
      const applyAndDeployButton = getButton('applyAndDeployButton');
      const applyResultContainer = document.getElementById('apply-result-container');
      const generatePolicyButton = getButton('generatePolicyButton');
      const cancelFixErrorsButton = getButton('cancelFixErrorsButton');
      const regenerateProposalButton = getButton('regenerateProposalButton');
      const promptInput = document.getElementById('prompt');
      const htmlWarningsDiv = document.getElementById('html-validation-warnings');
      const applyResultContent = document.getElementById('apply-result-content');
      const regeneratePolicyButton = getButton('regeneratePolicyButton');

      const requestId = Date.now();
      activeRequestId = requestId;

      showSpinnerInButton(fixButton, 'Fixing Errors...');
      generatePolicyButton.style.display = 'none'; // Ensure generate button is hidden
      regeneratePolicyButton.style.display = 'none'; // Hide regenerate button during loading
      promptInput.readOnly = true;
      cancelFixErrorsButton.style.display = 'inline-block';
      regenerateProposalButton.style.display = 'none';
      proposalContainer.style.display = 'none';
      applyNoDeployButton.style.display = 'none';
      applyAndDeployButton.style.display = 'none';
      applyResultContainer.style.display = 'none';
      applyResultContent.innerHTML = '';
      document.getElementById('proposed-files-display').innerHTML = '';
      htmlWarningsDiv.style.display = 'none';
      htmlWarningsDiv.innerHTML = '';

      saveScriptIdToLocalStorage(scriptId);

      google.script.run
        .withSuccessHandler(function(response) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale success response for fixErrorsFromLogs.');
            return;
          }
          activeRequestId = null;
          hideSpinnerInButton(fixButton); // Hide spinner on the clicked button
          promptInput.readOnly = false;
          cancelFixErrorsButton.style.display = 'none';

          if (response.status === 'proposal') {
            currentProposal = response;
            document.getElementById('proposal-purpose').textContent = response.purpose || 'No description provided.';
            
            htmlWarningsDiv.innerHTML = '';
            let hasHtmlErrors = false;

            response.proposedFiles.forEach(file => {
                if (file.type === 'HTML') {
                    const validationResult = validateHtml(file.source, file.name);
                    if (!validationResult.isValid) {
                        hasHtmlErrors = true;
                        const warningP = document.createElement('p');
                        warningP.textContent = validationResult.message;
                        htmlWarningsDiv.appendChild(warningP);
                    }
                }
            });

            if (hasHtmlErrors) {
                htmlWarningsDiv.style.display = 'block';
            } else {
                htmlWarningsDiv.style.display = 'none';
            }

            displayFileComparison(response.originalFiles, response.proposedFiles);
            proposalContainer.style.display = 'block';
            applyNoDeployButton.style.display = 'block';
            applyAndDeployButton.style.display = 'block';
            regenerateProposalButton.style.display = 'inline-block';
            fixButton.style.display = 'none';
            regeneratePolicyButton.style.display = 'inline-block'; // Show Regenerate Policy button
            generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button is hidden
          } else if (response.status === 'error') {
            const applyResultContent = document.getElementById('apply-result-content');
            applyResultContent.innerHTML = `
                <div class="notification is-danger">
                    <p><strong>Error:</strong> Failed to get error fix proposal.</p>
                    <p>${escapeHtml(response.message)}</p>
                </div>
            `;
            applyResultContainer.style.display = 'block';
            proposalContainer.style.display = 'block';
            regeneratePolicyButton.style.display = 'inline-block'; // Show Regenerate Policy button on error
            generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button is hidden
          } else {
            const applyResultContent = document.getElementById('apply-result-content');
            applyResultContent.innerHTML = `
                <div class="notification is-warning">
                    <p><strong>Unexpected response status:</strong></p>
                    <pre>${escapeHtml(JSON.stringify(response, null, 2))}</pre>
                }
            `;
            applyResultContainer.style.display = 'block';
            proposalContainer.style.display = 'block';
            regeneratePolicyButton.style.display = 'inline-block'; // Show Regenerate Policy button on unexpected response
            generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button is hidden
          }
        })
        .withFailureHandler(function(error) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale failure response for fixErrorsFromLogs.');
            return;
          }
          activeRequestId = null;
          hideSpinnerInButton(fixButton); // Hide spinner on the clicked button
          promptInput.readOnly = false;
          cancelFixErrorsButton.style.display = 'none';

          const applyResultContent = document.getElementById('apply-result-content');
          applyResultContent.innerHTML = `
              <div class="notification is-danger">
                  <p><strong>Error calling AI for fix:</strong></p>
                  <p>${escapeHtml(error.message)}</p>
              </div>
          `;
          document.getElementById('apply-result-container').style.display = 'block';
          document.getElementById('proposal-container').style.display = 'block';
          regeneratePolicyButton.style.display = 'inline-block'; // Show Regenerate Policy button on failure
          generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button is hidden
        })
        .fixErrorsFromLogs(scriptId);
    });

    document.getElementById('fix-errors-form').addEventListener('submit', function(e) {
      e.preventDefault();

      const scriptId = getEffectiveScriptId();
      if (!scriptId) {
        const applyResultContent = document.getElementById('apply-result-content');
        applyResultContent.innerHTML = `
            <div class="notification is-danger">
                <p><strong>Error:</strong> Script ID is required to fix errors.</p>
            </div>
        `;
        document.getElementById('apply-result-container').style.display = 'block';
        return;
      }

      const fixErrorsButton = getButton('fixErrorsButton'); // This is the button that was clicked
      const cancelFixErrorsButton = getButton('cancelFixErrorsButton');
      const proposalContainer = document.getElementById('proposal-container');
      const applyNoDeployButton = getButton('applyChangesNoDeployButton');
      const applyAndDeployButton = getButton('applyAndDeployButton');
      const applyResultContainer = document.getElementById('apply-result-container');
      const fixApplyErrorsButton = getButton('fixApplyErrorsButton');
      const generatePolicyButton = getButton('generatePolicyButton');
      const regenerateProposalButton = getButton('regenerateProposalButton');
      const promptInput = document.getElementById('prompt');
      const htmlWarningsDiv = document.getElementById('html-validation-warnings');
      const applyResultContent = document.getElementById('apply-result-content');
      const regeneratePolicyButton = getButton('regeneratePolicyButton');

      const requestId = Date.now();
      activeRequestId = requestId;

      showSpinnerInButton(fixErrorsButton, 'Fixing Errors...');
      generatePolicyButton.style.display = 'none'; // Ensure generate button is hidden
      regeneratePolicyButton.style.display = 'none'; // Hide regenerate button during loading
      promptInput.readOnly = true;
      cancelFixErrorsButton.style.display = 'inline-block';
      regenerateProposalButton.style.display = 'none';
      proposalContainer.style.display = 'none';
      applyNoDeployButton.style.display = 'none';
      applyAndDeployButton.style.display = 'none';
      applyResultContainer.style.display = 'none';
      fixApplyErrorsButton.style.display = 'none';
      document.getElementById('proposed-files-display').innerHTML = '';
      document.getElementById('proposal-purpose').textContent = '';
      applyResultContent.innerHTML = '';
      htmlWarningsDiv.style.display = 'none';
      htmlWarningsDiv.innerHTML = '';

      saveScriptIdToLocalStorage(scriptId);

      google.script.run
        .withSuccessHandler(function(response) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale success response for fixErrorsFromLogs (via form submit).');
            return;
          }
          activeRequestId = null;
          hideSpinnerInButton(fixErrorsButton); // Hide spinner on the clicked button
          promptInput.readOnly = false;
          cancelFixErrorsButton.style.display = 'none';

          if (response.status === 'proposal') {
            currentProposal = response;
            document.getElementById('proposal-purpose').textContent = response.purpose || 'No description provided.';
            
            htmlWarningsDiv.innerHTML = '';
            let hasHtmlErrors = false;

            response.proposedFiles.forEach(file => {
                if (file.type === 'HTML') {
                    const validationResult = validateHtml(file.source, file.name);
                    if (!validationResult.isValid) {
                        hasHtmlErrors = true;
                        const warningP = document.createElement('p');
                        warningP.textContent = validationResult.message;
                        htmlWarningsDiv.appendChild(warningP);
                    }
                }
            });

            if (hasHtmlErrors) {
                htmlWarningsDiv.style.display = 'block';
            }
            else {
                htmlWarningsDiv.style.display = 'none';
            }

            displayFileComparison(response.originalFiles, response.proposedFiles);
            proposalContainer.style.display = 'block';
            applyNoDeployButton.style.display = 'block';
            applyAndDeployButton.style.display = 'block';
            regenerateProposalButton.style.display = 'inline-block';
            fixApplyErrorsButton.style.display = 'none';
            regeneratePolicyButton.style.display = 'inline-block'; // Show Regenerate Policy button
            generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button is hidden
          } else if (response.status === 'error') {
            const applyResultContent = document.getElementById('apply-result-content');
            applyResultContent.innerHTML = `
                <div class="notification is-danger">
                    <p><strong>Error:</strong> Failed to get error fix proposal.</p>
                    <p>${escapeHtml(response.message)}</p>
                </div>
            `;
            applyResultContainer.style.display = 'block';
            proposalContainer.style.display = 'block';
            regeneratePolicyButton.style.display = 'inline-block'; // Show Regenerate Policy button on error
            generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button is hidden
          } else {
            const applyResultContent = document.getElementById('apply-result-content');
            applyResultContent.innerHTML = `
                <div class="notification is-warning">
                    <p><strong>Unexpected response status:</strong></p>
                    <pre>${escapeHtml(JSON.stringify(response, null, 2))}</pre>
                </div>
            `;
            applyResultContainer.style.display = 'block';
            proposalContainer.style.display = 'block';
            regeneratePolicyButton.style.display = 'inline-block'; // Show Regenerate Policy button on unexpected response
            generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button is hidden
          }
        })
        .withFailureHandler(function(error) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale failure response for fixErrorsFromLogs (via form submit).');
            return;
          }
          activeRequestId = null;
          hideSpinnerInButton(fixErrorsButton); // Hide spinner on the clicked button
          promptInput.readOnly = false;
          cancelFixErrorsButton.style.display = 'none';

          const applyResultContent = document.getElementById('apply-result-content');
          applyResultContent.innerHTML = `
              <div class="notification is-danger">
                  <p><strong>Error calling AI for fix:</strong></p>
                  <p>${escapeHtml(error.message)}</p>
              </div>
          `;
          document.getElementById('apply-result-container').style.display = 'block';
          document.getElementById('proposal-container').style.display = 'block';
          regeneratePolicyButton.style.display = 'inline-block'; // Show Regenerate Policy button on failure
          generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button is hidden
        })
        .fixErrorsFromLogs(scriptId);
    });

    document.getElementById('cancelFixErrorsButton').addEventListener('click', function() {
      activeRequestId = null;

      const fixErrorsButton = getButton('fixErrorsButton');
      const cancelFixErrorsButton = getButton('cancelFixErrorsButton');
      const proposalContainer = document.getElementById('proposal-container');
      const applyNoDeployButton = getButton('applyChangesNoDeployButton');
      const applyAndDeployButton = getButton('applyAndDeployButton');
      const applyResultContainer = document.getElementById('apply-result-container');
      const fixApplyErrorsButton = getButton('fixApplyErrorsButton');
      const generatePolicyButton = getButton('generatePolicyButton');
      const regenerateProposalButton = getButton('regenerateProposalButton');
      const promptInput = document.getElementById('prompt');
      const htmlWarningsDiv = document.getElementById('html-validation-warnings');
      const applyResultContent = document.getElementById('apply-result-content');
      const regeneratePolicyButton = getButton('regeneratePolicyButton');

      hideSpinnerInButton(fixErrorsButton); // Hide spinner on this button
      promptInput.readOnly = false;
      cancelFixErrorsButton.style.display = 'none';
      regenerateProposalButton.style.display = 'none';
      
      currentProposal = null;
      document.getElementById('proposal-purpose').textContent = '';
      document.getElementById('proposed-files-display').innerHTML = '<p>AI error fix canceled by user.</p>';
      htmlWarningsDiv.style.display = 'none';
      htmlWarningsDiv.innerHTML = '';
      proposalContainer.style.display = 'block';
      applyNoDeployButton.style.display = 'none';
      applyAndDeployButton.style.display = 'none';
      applyResultContainer.style.display = 'none';
      applyResultContent.innerHTML = '';
      fixApplyErrorsButton.style.display = 'none';

      // Reset to initial state for policy buttons
      generatePolicyButton.style.display = 'inline-block';
      regeneratePolicyButton.style.display = 'none';
    });

    document.getElementById('regenerateProposalButton').addEventListener('click', function() {
      if (!currentPolicyData || !currentPolicyData.scriptId || !currentPolicyData.userPrompt || !currentPolicyData.policy) {
        alert('Cannot regenerate proposal. Policy data is missing.');
        return;
      }

      const scriptId = currentPolicyData.scriptId;
      const promptText = currentPolicyData.userPrompt;
      const policyText = currentPolicyData.policy;

      const regenerateButton = this; // This is the button that was clicked
      const cancelAiOperationButton = getButton('cancelAiOperationButton');
      const proposalContainer = document.getElementById('proposal-container');
      const applyChangesNoDeployButton = getButton('applyChangesNoDeployButton');
      const applyAndDeployButton = getButton('applyAndDeployButton');
      const applyResultContainer = document.getElementById('apply-result-container');
      const fixApplyErrorsButton = getButton('fixApplyErrorsButton');
      const htmlWarningsDiv = document.getElementById('html-validation-warnings');
      const promptInput = document.getElementById('prompt');
      const applyResultContent = document.getElementById('apply-result-content');
      const generatePolicyButton = getButton('generatePolicyButton');
      const regeneratePolicyButton = getButton('regeneratePolicyButton');

      showSpinnerInButton(regenerateButton, 'Regenerating Proposal...');
      applyChangesNoDeployButton.disabled = true;
      applyAndDeployButton.disabled = true;
      promptInput.readOnly = true;
      cancelAiOperationButton.style.display = 'inline-block';

      proposalContainer.style.display = 'none';
      applyChangesNoDeployButton.style.display = 'none';
      applyAndDeployButton.style.display = 'none';
      applyResultContainer.style.display = 'none';
      fixApplyErrorsButton.style.display = 'none';
      document.getElementById('proposed-files-display').innerHTML = '';
      document.getElementById('proposal-purpose').textContent = '';
      applyResultContent.innerHTML = '';
      htmlWarningsDiv.style.display = 'none';
      htmlWarningsDiv.innerHTML = '';

      currentProposal = null;

      const formData = { scriptId: scriptId, prompt: promptText, policy: policyText };

      const requestId = Date.now();
      activeRequestId = requestId;

      console.log('Regenerating AI proposed changes...');
      google.script.run
        .withSuccessHandler(function(response) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale success response for regenerateProposal.');
            return;
          }
          activeRequestId = null;
          hideSpinnerInButton(regenerateButton); // Hide spinner on the clicked button
          applyChangesNoDeployButton.disabled = false;
          applyAndDeployButton.disabled = false;
          promptInput.readOnly = false;
          cancelAiOperationButton.style.display = 'none';

          if (response.status === 'proposal') {
            currentProposal = response;
            document.getElementById('proposal-purpose').textContent = response.purpose || 'No description provided.';
            
            htmlWarningsDiv.innerHTML = '';
            let hasHtmlErrors = false;

            response.proposedFiles.forEach(file => {
                if (file.type === 'HTML') {
                    const validationResult = validateHtml(file.source, file.name);
                    if (!validationResult.isValid) {
                        hasHtmlErrors = true;
                        const warningP = document.createElement('p');
                        warningP.textContent = validationResult.message;
                        htmlWarningsDiv.appendChild(warningP);
                    }
                }
            });

            if (hasHtmlErrors) {
                htmlWarningsDiv.style.display = 'block';
            }
            else {
                htmlWarningsDiv.style.display = 'none';
            }

            displayFileComparison(response.originalFiles, response.proposedFiles);
            proposalContainer.style.display = 'block';
            applyChangesNoDeployButton.style.display = 'block';
            applyAndDeployButton.style.display = 'block';
            regenerateButton.style.display = 'inline-block';
            regeneratePolicyButton.style.display = 'inline-block'; // Keep Regenerate Policy button visible
            generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button is hidden
          } else if (response.status === 'error') {
            const applyResultContent = document.getElementById('apply-result-content');
            applyResultContent.innerHTML = `
                <div class="notification is-danger">
                    <p><strong>Error:</strong> Failed to regenerate proposal.</p>
                    <p>${escapeHtml(response.message)}</p>
                </div>
            `;
            applyResultContainer.style.display = 'block';
            proposalContainer.style.display = 'block';
            regenerateButton.style.display = 'inline-block';
            regeneratePolicyButton.style.display = 'inline-block'; // Keep Regenerate Policy button visible on error
            generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button is hidden
          } else {
            const applyResultContent = document.getElementById('apply-result-content');
            applyResultContent.innerHTML = `
                <div class="notification is-warning">
                    <p><strong>Unexpected response status:</strong></p>
                    <pre>${escapeHtml(JSON.stringify(response, null, 2))}</pre>
                </div>
            `;
            applyResultContainer.style.display = 'block';
            proposalContainer.style.display = 'block';
            regenerateButton.style.display = 'inline-block';
            regeneratePolicyButton.style.display = 'inline-block'; // Keep Regenerate Policy button visible on unexpected response
            generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button is hidden
          }
        })
        .withFailureHandler(function(error) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale failure response for regenerateProposal.');
            return;
          }
          activeRequestId = null;
          hideSpinnerInButton(regenerateButton); // Hide spinner on the clicked button
          applyChangesNoDeployButton.disabled = false;
          applyAndDeployButton.disabled = false;
          promptInput.readOnly = false;
          cancelAiOperationButton.style.display = 'none';

          const applyResultContent = document.getElementById('apply-result-content');
          applyResultContent.innerHTML = `
              <div class="notification is-danger">
                  <p><strong>Error regenerating proposal:</strong></p>
                  <p>${escapeHtml(error.message)}</p>
              </div>
          `;
          applyResultContainer.style.display = 'block';
          proposalContainer.style.display = 'block';
          regenerateButton.style.display = 'inline-block';
          regeneratePolicyButton.style.display = 'inline-block'; // Keep Regenerate Policy button visible on failure
          generatePolicyButton.style.display = 'none'; // Ensure Generate Policy button is hidden
        })
        .processPrompt(formData);
    });

    document.getElementById('saveGcpProjectIdButton').addEventListener('click', function() {
      const gcpProjectIdInput = document.getElementById('gcpProjectId');
      const gcpProjectId = gcpProjectIdInput.value.trim();
      const saveResultContainer = document.getElementById('gcp-save-result-container');
      const saveResultText = document.getElementById('gcp-save-result');
      const saveButton = this;

      saveResultContainer.style.display = 'block';
      saveResultText.textContent = 'Saving...';
      showSpinnerInButton(saveButton, 'Saving...');

      if (!gcpProjectId) {
        saveResultText.textContent = 'Error: GCP Project ID cannot be empty.';
        hideSpinnerInButton(saveButton);
        return;
      }

      google.script.run
        .withSuccessHandler(function(response) {
          saveResultText.textContent = response.message;
          hideSpinnerInButton(saveButton);
          if (response.status === 'success') {
            saveGcpProjectIdToLocalStorage(gcpProjectId);
          }
        })
        .withFailureHandler(function(error) {
          saveResultText.textContent = 'Error saving GCP Project ID: ' + error.message;
          hideSpinnerInButton(saveButton);
        })
        .setGcpProjectId(gcpProjectId);
    });

    document.getElementById('log-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = this;
      const submitButton = form.querySelector('#getLogsButton');
      const resultContainer = document.getElementById('log-result-container');
      const resultText = document.getElementById('log-result');

      showSpinnerInButton(submitButton, 'Getting Logs...');
      resultContainer.style.display = 'none';
      resultText.textContent = '';

      const scriptId = getEffectiveScriptId();

      saveScriptIdToLocalStorage(scriptId);

      google.script.run
        .withSuccessHandler(function(response) {
          hideSpinnerInButton(submitButton);
          resultText.textContent = response;
          resultContainer.style.display = 'block';
        })
        .withFailureHandler(function(error) {
          hideSpinnerInButton(submitButton);
          resultText.textContent = 'Error: ' + error.message;
          resultContainer.style.display = 'block';
        })
        .getScriptLogs(scriptId);
    });

    document.getElementById('deploy-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = this;
      const submitButton = form.querySelector('#deployButton');
      const resultContainer = document.getElementById('deploy-result-container');
      const resultText = document.getElementById('deploy-result');

      showSpinnerInButton(submitButton, 'Deploying...');
      resultContainer.style.display = 'none';
      resultText.textContent = '';

      const scriptId = getEffectiveScriptId();
      const description = document.getElementById('deploymentDescription').value;

      saveScriptIdToLocalStorage(scriptId);

      google.script.run
        .withSuccessHandler(function(response) {
          hideSpinnerInButton(submitButton);
          resultContainer.style.display = 'block';
          if (response.status === 'success') {
            let webappUrlHtml = `Web App URL: ${response.webappUrl}`;
            if (response.webappUrl && response.webappUrl !== 'null') { // Check for actual URL, not 'null' string
              webappUrlHtml = `Web App URL: <a href="${response.webappUrl}" target="_blank">${response.webappUrl}</a>`;
            } else if (response.webappUrl === null) { // Explicitly check for null from backend
                webappUrlHtml = `Web App URL: Not found in deployment response.`;
            }
            resultText.innerHTML = `${response.message}<br>Deployment ID: ${response.deploymentId}<br>${webappUrlHtml}`;
          } else {
            resultText.textContent = `Error: ${response.message}`;
          }
        })
        .withFailureHandler(function(error) {
          hideSpinnerInButton(submitButton);
          resultContainer.style.display = 'block';
          resultText.textContent = `Error deploying script: ${error.message}`;
        })
        .deployScript(scriptId, description);
    });

    document.getElementById('add-library-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = this;
      const submitButton = form.querySelector('#addLibraryButton');
      const resultContainer = document.getElementById('add-library-result-container');
      const resultText = document.getElementById('add-library-result');

      showSpinnerInButton(submitButton, 'Adding Library...');
      resultContainer.style.display = 'none';
      resultText.textContent = '';

      const targetScriptId = getEffectiveScriptId();
      const libraryScriptId = document.getElementById('libraryScriptId').value.trim();
      const libraryVersion = document.getElementById('libraryVersion').value.trim();

      if (!targetScriptId) {
        resultText.textContent = 'Error: Please select or enter a Target Script ID.';
        resultContainer.style.display = 'block';
        hideSpinnerInButton(submitButton);
        return;
      }
      if (!libraryScriptId) {
        resultText.textContent = 'Error: Library Script ID cannot be empty.';
        resultContainer.style.display = 'block';
        hideSpinnerInButton(submitButton);
        return;
      }

      saveScriptIdToLocalStorage(targetScriptId);

      const effectiveVersion = libraryVersion.trim() === '' ? 'HEAD' : libraryVersion.trim();

      google.script.run
        .withSuccessHandler(function(response) {
          hideSpinnerInButton(submitButton);
          resultContainer.style.display = 'block';
          if (response.status === 'success') {
            resultText.textContent = response.message;
            document.getElementById('libraryScriptId').value = '';
            document.getElementById('libraryVersion').value = '';
          } else {
            resultText.textContent = `Error: ${response.message}`;
          }
        })
        .withFailureHandler(function(error) {
          hideSpinnerInButton(submitButton);
          resultContainer.style.display = 'block';
          resultText.textContent = `Error adding library: ${error.message}`;
        })
        .addLibraryToProject(targetScriptId, libraryScriptId, effectiveVersion);
    });

    document.getElementById('getVersionsButton').addEventListener('click', function() {
      const scriptId = getEffectiveScriptId();
      const versionsSelect = document.getElementById('versionSelect');
      const getVersionsButton = this; // This is the button that was clicked
      const revertVersionButton = getButton('revertVersionButton');
      const openWebAppButton = getButton('openWebAppButton'); // Get button reference
      const openWebAppMessage = document.getElementById('openWebAppMessage');
      const versionResultContainer = document.getElementById('version-result-container');
      const versionResultText = document.getElementById('version-result');

      versionsSelect.innerHTML = '<option value="">-- Loading versions --</option>';
      versionsSelect.disabled = true;
      showSpinnerInButton(getVersionsButton, 'Getting Versions...');
      revertVersionButton.disabled = true;
      openWebAppButton.disabled = true; // Ensure it's disabled when versions are loading/reloading
      openWebAppMessage.textContent = ''; // Clear message while loading
      versionResultContainer.style.display = 'none';

      if (!scriptId) {
        versionsSelect.innerHTML = '<option value="">-- Select a Script ID first --</option>';
        versionResultText.textContent = 'Error: Please select or enter a Script ID to get versions.';
        versionResultContainer.style.display = 'block';
        versionsSelect.disabled = false;
        hideSpinnerInButton(getVersionsButton);
        return;
      }

      saveScriptIdToLocalStorage(scriptId);

      google.script.run
        .withSuccessHandler(function(response) {
          hideSpinnerInButton(getVersionsButton);
          versionsSelect.disabled = false;
          // revertVersionButton.disabled and openWebAppButton.disabled will be handled by versionSelect change handler

          if (response.status === 'success') {
            versionsSelect.innerHTML = '<option value="">-- Select a version --</option>';
            if (response.versions && response.versions.length > 0) {
              response.versions.forEach(version => {
                const option = document.createElement('option');
                option.value = version.versionNumber;
                option.textContent = `Version ${version.versionNumber} (Created: ${new Date(version.createTime).toLocaleString()}) - ${version.description}`;
                if (version.webappUrl !== null) { // Store 'null' as a string if it's null from backend
                    option.dataset.webappUrl = version.webappUrl;
                } else {
                    option.dataset.webappUrl = 'null'; // Explicitly store 'null' string for proper checking
                }
                versionsSelect.appendChild(option);
              });
              versionResultText.textContent = `Versions found: ${response.versions.length} items`;
            } else {
              versionsSelect.innerHTML = '<option value="">-- No versions found --</option>';
              versionResultText.textContent = response.message;
            }
            // After populating options, trigger change event to correctly set button state and message
            versionsSelect.dispatchEvent(new Event('change'));
          }
          else {
            versionsSelect.innerHTML = '<option value="">-- Error loading versions --</option>';
            versionResultText.textContent = `Error: ${response.message}`;
            openWebAppButton.disabled = true; // Disable on error
            revertVersionButton.disabled = true; // Disable on error
            openWebAppMessage.textContent = ''; // Clear message on error
          }
          versionResultContainer.style.display = 'block';
        })
        .withFailureHandler(function(error) {
          hideSpinnerInButton(getVersionsButton);
          versionsSelect.disabled = false;
          revertVersionButton.disabled = true;
          openWebAppButton.disabled = true; // Disable on error
          openWebAppMessage.textContent = ''; // Clear message on error
          versionsSelect.innerHTML = '<option value="">-- Error loading versions --</option>';
          versionResultText.textContent = `Error getting versions: ${error.message}`;
          versionResultContainer.style.display = 'block';
        })
        .listScriptVersions(scriptId);
    });

    document.getElementById('versionSelect').addEventListener('change', function() {
        const versionsSelect = this;
        const selectedOption = versionsSelect.options[versionsSelect.selectedIndex];
        const revertVersionButton = getButton('revertVersionButton');
        const openWebAppButton = getButton('openWebAppButton');
        const openWebAppMessage = document.getElementById('openWebAppMessage');

        // Enable/disable revert button based on selection
        revertVersionButton.disabled = !selectedOption.value;

        // Enable/disable open web app button based on webappUrl in dataset
        const webappUrl = selectedOption.dataset.webappUrl;

        if (selectedOption.value && webappUrl && webappUrl !== 'null') { 
            openWebAppButton.disabled = false;
            openWebAppMessage.textContent = ''; // Clear message
        } else if (selectedOption.value && (webappUrl === 'null' || !webappUrl)) { 
            openWebAppButton.disabled = true;
            openWebAppMessage.textContent = 'No web app URL for this version.';
        } else { // No version selected
            openWebAppButton.disabled = true;
            openWebAppMessage.textContent = ''; // Clear message
        }
    });

    document.getElementById('openWebAppButton').addEventListener('click', function() {
        const versionsSelect = document.getElementById('versionSelect');
        const selectedOption = versionsSelect.options[versionsSelect.selectedIndex];
        const webappUrl = selectedOption.dataset.webappUrl;

        if (webappUrl && webappUrl !== 'null') { // Ensure it's a valid URL string
            window.open(webappUrl, '_blank');
        } else {
            alert('No web app URL found for the selected version, or URL is invalid.'); // More specific message for consistency
        }
    });

    document.getElementById('revertVersionButton').addEventListener('click', function() {
      const scriptId = getEffectiveScriptId();
      const versionSelect = document.getElementById('versionSelect');
      const selectedVersion = versionSelect.value;
      const revertButton = this; // This is the button that was clicked
      const getVersionsButton = getButton('getVersionsButton');
      const openWebAppButton = getButton('openWebAppButton'); // Get button reference
      const openWebAppMessage = document.getElementById('openWebAppMessage');
      const versionResultContainer = document.getElementById('version-result-container');
      const versionResultText = document.getElementById('version-result');

      if (!scriptId) {
        versionResultText.textContent = 'Error: Please select or enter a Script ID.';
        versionResultContainer.style.display = 'block';
        return;
      }
      if (!selectedVersion) {
        versionResultText.textContent = 'Error: Please select a version to revert to.';
        versionResultContainer.style.display = 'block';
        return;
      }

      if (!confirm(`Reverting script ID ${scriptId} to version ${selectedVersion}. This cannot be undone. Do you wish to continue?`)) {
        return;
      }

      showSpinnerInButton(revertButton, 'Reverting...');
      getVersionsButton.disabled = true;
      versionSelect.disabled = true;
      openWebAppButton.disabled = true; // Disable during revert operation
      openWebAppMessage.textContent = ''; // Clear message during revert
      versionResultContainer.style.display = 'block';
      versionResultText.textContent = `Reverting script to version ${selectedVersion}...`;

      saveScriptIdToLocalStorage(scriptId);

      google.script.run
        .withSuccessHandler(function(response) {
          hideSpinnerInButton(revertButton);
          getVersionsButton.disabled = false;
          versionSelect.disabled = false;
          // openWebAppButton.disabled will be handled by versionSelect change after success

          if (response.status === 'success') {
            versionResultText.textContent = response.message;
            versionSelect.innerHTML = '<option value="">-- Select a version --</option>';
            revertButton.disabled = true;
            openWebAppButton.disabled = true; // Ensure disabled after revert
            openWebAppMessage.textContent = ''; // Ensure cleared after revert
          }

          else {
            versionResultText.textContent = `Error: ${response.message}`;
            openWebAppButton.disabled = true; // Disable on error
            openWebAppMessage.textContent = ''; // Clear message on error
          }
        })
        .withFailureHandler(function(error) {
          hideSpinnerInButton(revertButton);
          getVersionsButton.disabled = false;
          versionSelect.disabled = false;
          openWebAppButton.disabled = true; // Disable on failure
          openWebAppMessage.textContent = ''; // Clear message on failure
          versionResultText.textContent = `Error reverting to version: ${error.message}`;
        })
        .revertToVersion(scriptId, parseInt(selectedVersion));
    });

    document.getElementById('getFilesListButton').addEventListener('click', function() {
        const scriptId = getEffectiveScriptId();
        const filesListContainer = document.getElementById('filesListContainer');
        const filesListDisplay = document.getElementById('filesListDisplay');
        const getFilesListButton = this; // This is the button that was clicked

        filesListContainer.style.display = 'block';
        filesListDisplay.innerHTML = '';
        showSpinnerInButton(getFilesListButton, 'Getting Files...');

        if (!scriptId) {
            filesListDisplay.innerHTML = '<p class="has-text-danger">Error: Please select or enter a Script ID.</p>';
            hideSpinnerInButton(getFilesListButton);
            return;
        }

        saveScriptIdToLocalStorage(scriptId);

        google.script.run
            .withSuccessHandler(function(response) {
                hideSpinnerInButton(getFilesListButton);

                if (response.status === 'success') {
                    if (response.files && response.files.length > 0) {
                        filesListDisplay.innerHTML = '';
                        response.files.forEach(file => {
                            const fileItem = document.createElement('div');
                            fileItem.className = 'file-item';

                            let typeClass = '';
                            let typeText = '';

                            switch (file.type) {
                                case 'SERVER_JS':
                                    typeClass = 'is-server-js';
                                    typeText = 'JS';
                                    break;
                                case 'JSON':
                                    typeClass = 'is-json';
                                    typeText = 'JSON';
                                    break;
                                case 'HTML':
                                    typeClass = 'is-html';
                                    typeText = 'HTML';
                                    break;
                                default:
                                    typeClass = 'is-unknown';
                                    typeText = 'UNKNOWN';
                            }
                            
                            fileItem.classList.add(typeClass);

                            fileItem.innerHTML = `
                                <div class="file-type-badge">${typeText}</div>
                                <div class="file-name">${escapeHtml(file.name)}.${getFileExtension(file.type)}</div>
                            `;

                            filesListDisplay.appendChild(fileItem);
                        });
                    } else {
                        filesListDisplay.innerHTML = '<p>No files found in this script.</p>';
                    }
                } else {
                    filesListDisplay.innerHTML = `<p class="has-text-danger">Error retrieving files: ${escapeHtml(response.message)}</p>`;
                    if (response.apiErrorDetails) {
                        filesListDisplay.innerHTML += `<pre class="has-text-danger-dark is-size-7 mt-2">${escapeHtml(JSON.stringify(response.apiErrorDetails, null, 2))}</pre>`;
                    }
                }
            })
            .withFailureHandler(function(error) {
                hideSpinnerInButton(getFilesListButton);
                filesListDisplay.innerHTML = `<p class="has-text-danger">Error calling server function: ${escapeHtml(error.message)}</p>`;
            })
            .listTargetScriptFiles(scriptId);
    });
  </script>
