<!DOCTYPE html>
<html>
<head>
<base target="_top">
<?!= include('style'); ?>
</head>
<body>
  <h1>Methane AI Agent</h1>
  <form id="agent-form">
    <label for="scriptIdSelect">Target Script ID:</label>
    <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">
      <select id="scriptIdSelect" name="scriptIdSelect" style="flex-grow: 1;">
        <option value="">-- Select or type manually --</option>
      </select>
      <button type="button" id="loadProjectsButton" style="width: auto; margin-bottom: 0;">Load Projects</button>
    </div>
    <input type="text" id="scriptIdManualInput" placeholder="Or paste Script ID here (overrides selection)" style="margin-bottom: 10px;">
    <div id="editor-url-display" style="margin-bottom: 10px; font-size: 0.9em;"></div>

    <label for="prompt">Prompt:</label>
    <textarea id="prompt" name="prompt" required></textarea>
    <button type="submit" id="generatePolicyButton">Generate Policy</button>
    <button type="button" id="cancelAiOperationButton" style="display:none;">Cancel</button>
  </form>

  <!-- Loading spinner for proposal -->
  <div id="loading-spinner" class="spinner" style="display:none;"></div>

  <!-- Policy Review Section -->
  <div id="policy-container" style="display:none;">
    <h2>AI Generated Policy:</h2>
    <pre id="ai-policy"></pre>
    <button type="button" id="acceptPolicyButton" style="display:none;">Accept Policy & Propose Changes</button>
    <button type="button" id="regeneratePolicyButton" style="display:none;">Regenerate Policy</button>
  </div>

  <!-- Proposal Review Section -->
  <div id="proposal-container" style="display:none;">
    <h2>AI Proposed Changes:</h2>
    <p><strong id="proposal-purpose-label">変更の主旨:</strong> <span id="proposal-purpose"></span></p>
    <!-- NEW: HTML Validation Warnings -->
    <div id="html-validation-warnings" style="color: red; margin-bottom: 10px; display: none;"></div>
    <p>以下の変更がAIから提案されました。内容を確認し、問題なければ「Apply Changes」ボタンをクリックして適用してください。</p>
    <div id="proposed-files-display">
      <!-- File comparisons will be inserted here by JavaScript -->
    </div>
    <div>
        <label><input type="checkbox" id="autoDeployAfterApply"> 適用後自動デプロイ</label>
    </div>
    <button type="button" id="applyChangesButton" style="display:none;">Apply Changes</button>
    <button type="button" id="regenerateProposalButton" style="display:none;">Regenerate Proposal</button>
    <div id="apply-loading-spinner" class="spinner" style="display:none;"></div>
    <div id="apply-result-container" style="display:none;">
      <h3>Apply Result:</h3>
      <pre id="apply-result"></pre>
      <!-- NEW BUTTON for fixing errors after apply failure -->
      <button type="button" id="fixApplyErrorsButton" style="display:none;">Fix Apply Errors with AI</button>
    </div>
  </div>

  <hr>

  <h2>Google Cloud Project ID Configuration</h2>
  <p>ログ取得には、このApps ScriptがリンクされているGoogle Cloud Projectが必要です。APIで自動取得できない場合に備え、GCPプロジェクトIDを手動で設定してください。</p>
  <label for="gcpProjectId">GCP Project ID:</label>
  <input type="text" id="gcpProjectId" name="gcpProjectId">
  <button type="button" id="saveGcpProjectIdButton">Save GCP Project ID</button>
  <div id="gcp-save-result-container" style="display:none;">
    <h3>Save Result:</h3>
    <pre id="gcp-save-result"></pre>
  </div>

  <hr>

  <h2>Get Script Logs</h2>
  <form id="log-form">
    <p>Using the Script ID entered above.</p>
    <button type="submit" id="getLogsButton">Get Logs</button>
  </form>

  <div id="log-loading-spinner" class="spinner" style="display:none;"></div>

  <div id="log-result-container" style="display:none;">
    <h3>Logs:</h3>
    <pre id="log-result"></pre>
  </div>

  <hr>

  <h2>Automated Error Fix from Logs</h2>
  <p>既存のスクリプトログに基づいて、AIにエラー修正の提案をさせます。提案された変更は上記の「AI Proposed Changes」セクションに表示されます。</p>
  <form id="fix-errors-form">
    <p>Using the Script ID entered above.</p>
    <button type="submit" id="fixErrorsButton">Fix Errors from Logs</button>
    <button type="button" id="cancelFixErrorsButton" style="display:none;">Cancel</button>
  </form>

  <div id="fix-loading-spinner" class="spinner" style="display:none;"></div>

  <hr>

  <h2>Deploy Script</h2>
  <form id="deploy-form">
    <p>Using the Script ID entered above.</p>
    <label for="deploymentDescription">Deployment Description (Optional):</label>
    <input type="text" id="deploymentDescription" name="deploymentDescription">
    <p>This will deploy the current HEAD version as a new Web App deployment, using the Web App settings defined in <code>appsscript.json</code>.</p>
    <button type="submit" id="deployButton">Create New Web App Deployment</button>
  </form>

  <div id="deploy-loading-spinner" class="spinner" style="display:none;"></div>

  <div id="deploy-result-container" style="display:none;">
    <h3>Deployment Result:</h3>
    <pre id="deploy-result"></pre>
  </div>

  <script>
    let currentPolicyData = null; // Stores AI policy and original prompt
    let currentProposal = null; // Store the AI's code proposal globally for applyChanges
    let activeRequestId = null; // Global flag for the currently active request ID

    // Helper to get the effective script ID
    function getEffectiveScriptId() {
        const manualId = document.getElementById('scriptIdManualInput').value.trim();
        if (manualId) {
            return manualId;
        }
        return document.getElementById('scriptIdSelect').value.trim();
    }

    // --- Helper function to save scriptId to localStorage ---
    function saveScriptIdToLocalStorage(id) {
        if (id) {
            localStorage.setItem('targetScriptId', id);
        }
    }

    // Helper function to save gcpProjectId to localStorage
    function saveGcpProjectIdToLocalStorage(id) {
        if (id) {
            localStorage.setItem('gcpProjectId', id);
        }
    }

    // Function to load projects and populate the dropdown
    function loadProjectsIntoDropdown(selectedId = null) {
        const scriptIdSelect = document.getElementById('scriptIdSelect');
        const loadProjectsButton = document.getElementById('loadProjectsButton');
        loadProjectsButton.disabled = true; // Disable button while loading

        // Clear existing options except the placeholder
        scriptIdSelect.innerHTML = '<option value="">-- Select or type manually --</option>';

        google.script.run
            .withSuccessHandler(function(response) {
                loadProjectsButton.disabled = false;
                if (response.status === 'success') {
                    response.projects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = project.title;
                        scriptIdSelect.appendChild(option);
                    });
                    if (selectedId) {
                        scriptIdSelect.value = selectedId; // Set selected if saved ID was passed
                    }
                } else {
                    alert('Failed to load Apps Script projects: ' + response.message);
                }
            })
            .withFailureHandler(function(error) {
                loadProjectsButton.disabled = false;
                alert('Error loading Apps Script projects: ' + error.message);
            })
            .listAppsScriptProjects();
    }

    // Function to display the Apps Script Editor URL based on current Script ID
    function updateEditorUrlDisplay() {
        const scriptId = getEffectiveScriptId();
        const editorUrlDisplayDiv = document.getElementById('editor-url-display');
        
        editorUrlDisplayDiv.innerHTML = ''; // Clear previous content

        if (!scriptId) {
            editorUrlDisplayDiv.textContent = 'Apps Script Editor URL: (Script ID needed)';
            return;
        }

        editorUrlDisplayDiv.innerHTML = 'Apps Script Editor URL: <span class="spinner" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin: 0 5px;"></span> Loading...';

        // Save scriptId to localStorage every time it's used/updated
        saveScriptIdToLocalStorage(scriptId);

        google.script.run
            .withSuccessHandler(function(response) {
                if (response.startsWith("エラー:")) {
                    editorUrlDisplayDiv.textContent = `Apps Script Editor URL: ${response}`;
                } else {
                    editorUrlDisplayDiv.innerHTML = `Apps Script Editor URL: <a href="${response}" target="_blank">${response}</a>`;
                }
            })
            .withFailureHandler(function(error) {
                editorUrlDisplayDiv.textContent = `Apps Script Editor URL: Error - ${error.message}`;
            })
            .getScriptEditorUrl(scriptId);
    }

    // --- Load scriptId from localStorage on page load ---
    document.addEventListener('DOMContentLoaded', function() {
      const scriptIdManualInput = document.getElementById('scriptIdManualInput');
      const gcpProjectIdInput = document.getElementById('gcpProjectId');

      const savedScriptId = localStorage.getItem('targetScriptId');
      if (savedScriptId) {
        scriptIdManualInput.value = savedScriptId;
      }

      // Load GCP Project ID from localStorage
      const savedGcpProjectId = localStorage.getItem('gcpProjectId');
      if (savedGcpProjectId) {
        gcpProjectIdInput.value = savedGcpProjectId;
      }

      // Auto-load projects on page load
      loadProjectsIntoDropdown(savedScriptId); // Pass the saved ID so it tries to pre-select

      // Initial UI state setup
      document.getElementById('policy-container').style.display = 'none';
      document.getElementById('proposal-container').style.display = 'none';
      document.getElementById('applyChangesButton').style.display = 'none';
      document.getElementById('regenerateProposalButton').style.display = 'none';
      document.getElementById('apply-result-container').style.display = 'none';
      document.getElementById('fixApplyErrorsButton').style.display = 'none';
      document.getElementById('regeneratePolicyButton').style.display = 'none';

      // Initial display of editor URL
      updateEditorUrlDisplay();
    });

    // NEW: Add event listeners for script ID changes
    document.getElementById('scriptIdSelect').addEventListener('change', updateEditorUrlDisplay);
    document.getElementById('scriptIdManualInput').addEventListener('input', updateEditorUrlDisplay);

    // NEW: Function to validate HTML content using DOMParser
    function validateHtml(htmlString, fileName) {
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlString, 'text/html');
        const parseError = doc.querySelector('parsererror');

        if (parseError) {
            // DOMParser finds errors and inserts <parsererror> in the parsed document.
            const errorMessage = parseError.textContent;
            console.error(`HTML validation error in ${fileName}:`, errorMessage);
            return { isValid: false, message: `HTMLファイル "${fileName}" に構文エラーが見つかりました: ${errorMessage}` };
        }
        return { isValid: true };
    }

    // Function to generate the formatted diff data for both original and proposed panels for a single file.
    function generateFormattedDiffPanels(originalSource, proposedSource) {
        const originalLines = originalSource ? originalSource.split('\n') : [];
        const proposedLines = proposedSource ? proposedSource.split('\n') : [];

        const rawDiffResult = []; // Stores the raw diff (equal, added, removed, modified)
        let i = 0; // Pointer for originalLines
        let j = 0; // Pointer for proposedLines
        const lookAheadWindow = 5; // How many lines to look ahead for a match

        while (i < originalLines.length || j < proposedLines.length) {
            const currentOriginalLine = originalLines[i];
            const currentProposedLine = proposedLines[j];

            if (i < originalLines.length && j < proposedLines.length && currentOriginalLine === currentProposedLine) {
                rawDiffResult.push({ type: 'equal', original: currentOriginalLine, proposed: currentProposedLine });
                i++;
                j++;
            } else {
                let originalFoundInProposedAhead = -1;
                for (let k = j + 1; k < Math.min(j + 1 + lookAheadWindow, proposedLines.length); k++) {
                    if (i < originalLines.length && originalLines[i] === proposedLines[k]) {
                        originalFoundInProposedAhead = k;
                        break;
                    }
                }

                let proposedFoundInOriginalAhead = -1;
                for (let k = i + 1; k < Math.min(i + 1 + lookAheadWindow, originalLines.length); k++) {
                    if (j < proposedLines.length && proposedLines[j] === originalLines[k]) {
                        proposedFoundInOriginalAhead = k;
                        break;
                    }
                }

                if (i < originalLines.length && j < proposedLines.length && originalFoundInProposedAhead === -1 && proposedFoundInOriginalAhead === -1) {
                    rawDiffResult.push({ type: 'modified', original: currentOriginalLine, proposed: currentProposedLine });
                    i++;
                    j++;
                } else if (originalFoundInProposedAhead !== -1 && (proposedFoundInOriginalAhead === -1 || (originalFoundInProposedAhead - j) <= (proposedFoundInOriginalAhead - i))) {
                    rawDiffResult.push({ type: 'added', original: '', proposed: currentProposedLine });
                    j++;
                } else if (proposedFoundInOriginalAhead !== -1 && (originalFoundInProposedAhead === -1 || (proposedFoundInOriginalAhead - i) < (originalFoundInProposedAhead - j))) {
                    rawDiffResult.push({ type: 'removed', original: currentOriginalLine, proposed: '' });
                    i++;
                } else if (i < originalLines.length) {
                    rawDiffResult.push({ type: 'removed', original: currentOriginalLine, proposed: '' });
                    i++;
                } else if (j < proposedLines.length) {
                    rawDiffResult.push({ type: 'added', original: '', proposed: currentProposedLine });
                    j++;
                }
            }
        }

        // Post-process raw diff to introduce collapsed blocks
        const processedDiffBlocks = [];
        let originalLineNumCounter = 0;
        let proposedLineNumCounter = 0;
        const minLinesToCollapse = 5; // Threshold for collapsing identical lines

        let currentEqualBlock = [];

        rawDiffResult.forEach(entry => {
            if (entry.type === 'equal') {
                originalLineNumCounter++;
                proposedLineNumCounter++;
                currentEqualBlock.push({
                    type: 'equal',
                    original: entry.original,
                    proposed: entry.proposed,
                    originalLineNum: originalLineNumCounter,
                    proposedLineNum: proposedLineNumCounter
                });
            } else {
                // Non-equal line encountered, process the current equal block if any
                if (currentEqualBlock.length > 0) {
                    if (currentEqualBlock.length >= minLinesToCollapse) {
                        processedDiffBlocks.push({
                            type: 'collapsed',
                            count: currentEqualBlock.length,
                            lines: currentEqualBlock // These lines already have their sequential line numbers
                        });
                    } else {
                        // Not enough lines to collapse, render them normally
                        processedDiffBlocks.push(...currentEqualBlock);
                    }
                    currentEqualBlock = []; // Reset for next block
                }

                // Now, process the current non-equal line
                if (entry.type === 'added') {
                    proposedLineNumCounter++;
                    processedDiffBlocks.push({
                        type: 'added',
                        original: '',
                        proposed: entry.proposed,
                        originalLineNum: '&nbsp;', // Placeholder for alignment
                        proposedLineNum: proposedLineNumCounter
                    });
                } else if (entry.type === 'removed') {
                    originalLineNumCounter++;
                    processedDiffBlocks.push({
                        type: 'removed',
                        original: entry.original,
                        proposed: '',
                        originalLineNum: originalLineNumCounter,
                        proposedLineNum: '&nbsp;' // Placeholder for alignment
                    });
                } else if (entry.type === 'modified') {
                    originalLineNumCounter++;
                    proposedLineNumCounter++;
                    processedDiffBlocks.push({
                        type: 'modified',
                        original: entry.original,
                        proposed: entry.proposed,
                        originalLineNum: originalLineNumCounter,
                        proposedLineNum: proposedLineNumCounter
                    });
                }
            }
        });

        // Process any remaining equal block at the end of the file
        if (currentEqualBlock.length > 0) {
            if (currentEqualBlock.length >= minLinesToCollapse) {
                processedDiffBlocks.push({
                    type: 'collapsed',
                    count: currentEqualBlock.length,
                    lines: currentEqualBlock
                });
            } else {
                processedDiffBlocks.push(...currentEqualBlock);
            }
        }
        return processedDiffBlocks;
    }

    // Function to display file comparison
    function displayFileComparison(originalFiles, proposedFiles) {
      const displayArea = document.getElementById('proposed-files-display');
      displayArea.innerHTML = ''; // Clear previous content

      if (!proposedFiles || proposedFiles.length === 0) {
        displayArea.innerHTML = '<p>AI did not propose any changes to existing files, or no files were processed.</p>';
        return;
      }

      proposedFiles.forEach(proposedFile => {
          const name = proposedFile.name;
          const fileType = proposedFile.type; // Get type from the proposed file

          const originalFile = (originalFiles || []).find(f => f.name === name);
          const originalSource = originalFile ? originalFile.source : '';
          const proposedSource = proposedFile.source;

          const diffBlocks = generateFormattedDiffPanels(originalSource, proposedSource); // Get structured blocks

          const fileComparisonDiv = document.createElement('div');
          fileComparisonDiv.className = 'file-comparison';

          // Create original panel elements
          const originalContentDiv = document.createElement('div');
          originalContentDiv.innerHTML = `<h4>${name}.${getFileExtension(fileType)} (Original)</h4>`;
          const originalPre = document.createElement('pre');
          originalPre.className = 'scroll-sync-target';
          const originalLineNumbersCol = document.createElement('div');
          originalLineNumbersCol.className = 'line-numbers-col';
          const originalCodeContentCol = document.createElement('div');
          originalCodeContentCol.className = 'code-content-col';
          originalPre.appendChild(originalLineNumbersCol);
          originalPre.appendChild(originalCodeContentCol);
          originalContentDiv.appendChild(originalPre);

          // Create proposed panel elements
          const proposedContentDiv = document.createElement('div');
          proposedContentDiv.innerHTML = `<h4>${name}.${getFileExtension(fileType)} (Proposed)</h4>`;
          const proposedPre = document.createElement('pre');
          proposedPre.className = 'scroll-sync-target';
          const proposedLineNumbersCol = document.createElement('div');
          proposedLineNumbersCol.className = 'line-numbers-col';
          const proposedCodeContentCol = document.createElement('div');
          proposedCodeContentCol.className = 'code-content-col';
          proposedPre.appendChild(proposedLineNumbersCol);
          proposedPre.appendChild(proposedCodeContentCol);
          proposedContentDiv.appendChild(proposedPre);
          
          diffBlocks.forEach(block => {
              if (block.type === 'equal' || block.type === 'added' || block.type === 'removed' || block.type === 'modified') {
                  const origLineNumDiv = document.createElement('div');
                  origLineNumDiv.textContent = block.originalLineNum;
                  originalLineNumbersCol.appendChild(origLineNumDiv);

                  const origCodeDiv = document.createElement('div');
                  origCodeDiv.className = `diff-line-${block.type === 'equal' ? 'equal' : (block.type === 'added' ? 'empty-fill' : block.type)}`;
                  origCodeDiv.innerHTML = escapeHtml(block.original);
                  originalCodeContentCol.appendChild(origCodeDiv);

                  const propLineNumDiv = document.createElement('div');
                  propLineNumDiv.textContent = block.proposedLineNum;
                  proposedLineNumbersCol.appendChild(propLineNumDiv);

                  const propCodeDiv = document.createElement('div');
                  propCodeDiv.className = `diff-line-${block.type === 'equal' ? 'equal' : (block.type === 'removed' ? 'empty-fill' : block.type)}`;
                  propCodeDiv.innerHTML = escapeHtml(block.proposed);
                  proposedCodeContentCol.appendChild(propCodeDiv);
              } else if (block.type === 'collapsed') {
                  const commonIdBase = `${name}-${block.lines[0].originalLineNum}`;

                  // --- Original Panel Collapsed Group ---
                  const origCollapseGroupLn = document.createElement('div');
                  origCollapseGroupLn.className = 'diff-collapsed-group';
                  const origButtonLn = document.createElement('button');
                  origButtonLn.className = 'diff-collapse-button';
                  origButtonLn.textContent = `${block.count} unchanged lines`;
                  origButtonLn.setAttribute('data-target-ln', `ln-${commonIdBase}-orig`);
                  origButtonLn.setAttribute('data-target-code', `code-${commonIdBase}-orig`);
                  origButtonLn.setAttribute('data-lines-count', block.count);
                  origCollapseGroupLn.appendChild(origButtonLn);
                  originalLineNumbersCol.appendChild(origCollapseGroupLn);

                  const origCollapseGroupCode = document.createElement('div');
                  origCollapseGroupCode.className = 'diff-collapsed-group';
                  const origButtonCode = document.createElement('button');
                  origButtonCode.className = 'diff-collapse-button';
                  origButtonCode.textContent = `${block.count} unchanged lines`;
                  origButtonCode.setAttribute('data-target-ln', `ln-${commonIdBase}-orig`);
                  origButtonCode.setAttribute('data-target-code', `code-${commonIdBase}-orig`);
                  origButtonCode.setAttribute('data-lines-count', block.count);
                  origCollapseGroupCode.appendChild(origButtonCode);
                  originalCodeContentCol.appendChild(origCollapseGroupCode);

                  // Hidden line numbers div for Original
                  const origHiddenLnDiv = document.createElement('div');
                  origHiddenLnDiv.className = 'diff-hidden-lines';
                  origHiddenLnDiv.id = `ln-${commonIdBase}-orig`;
                  origHiddenLnDiv.style.display = 'none';
                  block.lines.forEach(line => {
                      const div = document.createElement('div');
                      div.textContent = line.originalLineNum;
                      origHiddenLnDiv.appendChild(div);
                  });
                  originalLineNumbersCol.appendChild(origHiddenLnDiv);

                  // Hidden code content div for Original
                  const origHiddenCodeDiv = document.createElement('div');
                  origHiddenCodeDiv.className = 'diff-hidden-lines';
                  origHiddenCodeDiv.id = `code-${commonIdBase}-orig`;
                  origHiddenCodeDiv.style.display = 'none';
                  block.lines.forEach(line => {
                      const div = document.createElement('div');
                      div.className = 'diff-line-equal';
                      div.innerHTML = escapeHtml(line.original);
                      origHiddenCodeDiv.appendChild(div);
                  });
                  originalCodeContentCol.appendChild(origHiddenCodeDiv);

                  // --- Proposed Panel Collapsed Group ---
                  const propCollapseGroupLn = document.createElement('div');
                  propCollapseGroupLn.className = 'diff-collapsed-group';
                  const propButtonLn = document.createElement('button');
                  propButtonLn.className = 'diff-collapse-button';
                  propButtonLn.textContent = `${block.count} unchanged lines`;
                  propButtonLn.setAttribute('data-target-ln', `ln-${commonIdBase}-prop`);
                  propButtonLn.setAttribute('data-target-code', `code-${commonIdBase}-prop`);
                  propButtonLn.setAttribute('data-lines-count', block.count);
                  propCollapseGroupLn.appendChild(propButtonLn);
                  proposedLineNumbersCol.appendChild(propCollapseGroupLn);

                  const propCollapseGroupCode = document.createElement('div');
                  propCollapseGroupCode.className = 'diff-collapsed-group';
                  const propButtonCode = document.createElement('button');
                  propButtonCode.className = 'diff-collapse-button';
                  propButtonCode.textContent = `${block.count} unchanged lines`;
                  propButtonCode.setAttribute('data-target-ln', `ln-${commonIdBase}-prop`);
                  propButtonCode.setAttribute('data-target-code', `code-${commonIdBase}-prop`);
                  propButtonCode.setAttribute('data-lines-count', block.count);
                  propCollapseGroupCode.appendChild(propButtonCode);
                  proposedCodeContentCol.appendChild(propCollapseGroupCode);

                  // Hidden line numbers div for Proposed
                  const propHiddenLnDiv = document.createElement('div');
                  propHiddenLnDiv.className = 'diff-hidden-lines';
                  propHiddenLnDiv.id = `ln-${commonIdBase}-prop`;
                  propHiddenLnDiv.style.display = 'none';
                  block.lines.forEach(line => {
                      const div = document.createElement('div');
                      div.textContent = line.proposedLineNum;
                      propHiddenLnDiv.appendChild(div);
                  });
                  proposedLineNumbersCol.appendChild(propHiddenLnDiv);

                  // Hidden code content div for Proposed
                  const propHiddenCodeDiv = document.createElement('div');
                  propHiddenCodeDiv.className = 'diff-hidden-lines';
                  propHiddenCodeDiv.id = `code-${commonIdBase}-prop`;
                  propHiddenCodeDiv.style.display = 'none';
                  block.lines.forEach(line => {
                      const div = document.createElement('div');
                      div.className = 'diff-line-equal';
                      div.innerHTML = escapeHtml(line.proposed);
                      propHiddenCodeDiv.appendChild(div);
                  });
                  proposedCodeContentCol.appendChild(propHiddenCodeDiv);
              }
          });

          fileComparisonDiv.appendChild(originalContentDiv);
          fileComparisonDiv.appendChild(proposedContentDiv);
          displayArea.appendChild(fileComparisonDiv);

          // Add event listeners for collapse buttons after they are in the DOM
          fileComparisonDiv.querySelectorAll('.diff-collapse-button').forEach(button => {
              button.addEventListener('click', function() {
                  const targetIdLn = this.getAttribute('data-target-ln');
                  const targetIdCode = this.getAttribute('data-target-code');
                  const linesCount = this.getAttribute('data-lines-count');

                  const targetElementLn = document.getElementById(targetIdLn);
                  const targetElementCode = document.getElementById(targetIdCode);

                  if (targetElementLn && targetElementCode) {
                      const isHidden = targetElementLn.style.display === 'none';
                      const newDisplay = isHidden ? 'block' : 'none';
                      const newText = isHidden ? 'Hide unchanged lines' : `${linesCount} unchanged lines`;

                      // Find all 4 buttons linked to this logical collapsed group and update them
                      const commonIdBase = targetIdLn.substring(targetIdLn.indexOf('-') + 1, targetIdLn.lastIndexOf('-')); // e.g., 