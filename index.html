<!DOCTYPE html>
<html>
<head>
<base target="_top">
<style>
  body { font-family: sans-serif; margin: 20px; }
  input, textarea, button, select { width: 100%; margin-bottom: 10px; padding: 8px; box-sizing: border-box; }
  textarea { height: 150px; }
  /* Updated pre styles for better code display */
  pre {
    background-color: #f4f4f4;
    padding: 0; /* Removed padding from pre itself, apply to inner divs */
    border-radius: 4px;
    white-space: pre-wrap; /* Allows wrapping for long lines */
    word-wrap: break-word;
    overflow-x: auto;
    font-family: monospace; /* Ensure monospaced font for code */
    font-size: 0.9em; /* Slightly smaller font for dense code */
    line-height: 1.4; /* Better line spacing */
    display: flex; /* Use flexbox for line numbers */
  }

  /* Spinner styles */
  .spinner {
    border: 4px solid #f3f3f3; /* Light grey */
    border-top: 4px solid #3498db; /* Blue */
    border-radius: 50%;
    width: 20px;
    height: 20px;
    animation: spin 1s linear infinite;
    margin: 10px auto; /* Center the spinner */
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  /* Layout for diff-like display */
  .file-comparison {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
    border: 1px solid #ddd;
    padding: 10px;
    background-color: #f9f9f9;
  }
  .file-comparison div {
    flex: 1;
    margin: 0 5px;
  }
  .file-comparison h4 {
    margin-top: 0;
  }
  .file-comparison pre {
    height: 250px; /* Increased height for more lines */
    overflow-y: scroll;
    border: 1px solid #ccc;
    /* padding: 0; */ /* Already set above for pre */
    /* display: flex; */ /* Already set above for pre */
  }

  /* Styles for line numbers and code content columns */
  .line-numbers-col {
    background-color: #eee;
    color: #888;
    /* padding: 10px 5px; */ /* Moved to inner divs */
    text-align: right;
    user-select: none;
    flex-shrink: 0;
    width: max-content; /* Ensure width is natural based on content */
    border-right: 1px solid #ddd;
    font-family: monospace;
    font-size: 0.9em;
    line-height: 1.4;
  }
  .code-content-col {
    /* padding: 10px; */ /* Moved to inner divs */
    flex-grow: 1;
    font-family: monospace;
    font-size: 0.9em;
    line-height: 1.4;
  }

  /* NEW: Styles for individual line divs within the pre blocks */
  .line-numbers-col > div,
  .code-content-col > div {
    padding: 0 5px; /* Apply padding directly to each line div */
    min-height: 1.4em; /* Ensure consistent height for each line, including empty ones */
    box-sizing: border-box; /* Include padding in element's total width/height */
  }

  /* Specific diff line highlighting */
  .code-content-col > .diff-line-added { background-color: #e6ffe6; } /* Light green for added/new content */
  .code-content-col > .diff-line-removed { background-color: #ffe6e6; } /* Light red for removed/old content */
</style>
</head>
<body>
  <h1>Methane AI Agent</h1>
  <form id="agent-form">
    <label for="scriptIdSelect">Target Script ID:</label>
    <div style="display: flex; align-items: center; gap: 5px; margin-bottom: 10px;">
      <select id="scriptIdSelect" name="scriptIdSelect" style="flex-grow: 1;">
        <option value="">-- Select or type manually --</option>
      </select>
      <button type="button" id="loadProjectsButton" style="width: auto; margin-bottom: 0;">Load Projects</button>
    </div>
    <input type="text" id="scriptIdManualInput" placeholder="Or paste Script ID here (overrides selection)" style="margin-bottom: 10px;">

    <label for="prompt">Prompt:</label>
    <textarea id="prompt" name="prompt" required></textarea>
    <button type="submit" id="generatePolicyButton">Generate Policy</button>
    <button type="button" id="cancelAiOperationButton" style="display:none;">Cancel</button>
  </form>

  <!-- Loading spinner for proposal -->
  <div id="loading-spinner" class="spinner" style="display:none;"></div>

  <!-- Policy Review Section -->
  <div id="policy-container" style="display:none;">
    <h2>AI Generated Policy:</h2>
    <pre id="ai-policy"></pre>
    <button type="button" id="acceptPolicyButton" style="display:none;">Accept Policy & Propose Changes</button>
    <button type="button" id="regeneratePolicyButton" style="display:none;">Regenerate Policy</button>
  </div>

  <!-- Proposal Review Section -->
  <div id="proposal-container" style="display:none;">
    <h2>AI Proposed Changes:</h2>
    <p><strong id="proposal-purpose-label">変更の主旨:</strong> <span id="proposal-purpose"></span></p>
    <p>以下の変更がAIから提案されました。内容を確認し、問題なければ「Apply Changes」ボタンをクリックして適用してください。</p>
    <div id="proposed-files-display">
      <!-- File comparisons will be inserted here by JavaScript -->
    </div>
    <button type="button" id="applyChangesButton" style="display:none;">Apply Changes</button>
    <div id="apply-loading-spinner" class="spinner" style="display:none;"></div>
    <div id="apply-result-container" style="display:none;">
      <h3>Apply Result:</h3>
      <pre id="apply-result"></pre>
      <!-- NEW BUTTON for fixing errors after apply failure -->
      <button type="button" id="fixApplyErrorsButton" style="display:none;">Fix Apply Errors with AI</button>
    </div>
  </div>

  <hr>

  <h2>Google Cloud Project ID Configuration</h2>
  <p>ログ取得には、このApps ScriptがリンクされているGoogle Cloud Projectが必要です。APIで自動取得できない場合に備え、GCPプロジェクトIDを手動で設定してください。</p>
  <label for="gcpProjectId">GCP Project ID:</label>
  <input type="text" id="gcpProjectId" name="gcpProjectId">
  <button type="button" id="saveGcpProjectIdButton">Save GCP Project ID</button>
  <div id="gcp-save-result-container" style="display:none;">
    <h3>Save Result:</h3>
    <pre id="gcp-save-result"></pre>
  </div>

  <hr>

  <h2>Get Script Logs</h2>
  <form id="log-form">
    <p>Using the Script ID entered above.</p>
    <button type="submit" id="getLogsButton">Get Logs</button>
  </form>

  <div id="log-loading-spinner" class="spinner" style="display:none;"></div>

  <div id="log-result-container" style="display:none;">
    <h3>Logs:</h3>
    <pre id="log-result"></pre>
  </div>

  <hr>

  <h2>Script Editor URL</h2>
  <form id="editor-url-form">
    <p>Using the Script ID entered above.</p>
    <button type="submit" id="getEditorUrlButton">Show Editor URL</button>
  </form>

  <div id="editor-url-loading-spinner" class="spinner" style="display:none;"></div>

  <div id="editor-url-result-container" style="display:none;">
    <h3>Editor URL:</h3>
    <pre id="editor-url-result"></pre>
  </div>

  <hr>

  <h2>Automated Error Fix from Logs</h2>
  <p>既存のスクリプトログに基づいて、AIにエラー修正の提案をさせます。提案された変更は上記の「AI Proposed Changes」セクションに表示されます。</p>
  <form id="fix-errors-form">
    <p>Using the Script ID entered above.</p>
    <button type="submit" id="fixErrorsButton">Fix Errors from Logs</button>
    <button type="button" id="cancelFixErrorsButton" style="display:none;">Cancel</button>
  </form>

  <div id="fix-loading-spinner" class="spinner" style="display:none;"></div>

  <hr>

  <h2>Deploy Script</h2>
  <form id="deploy-form">
    <p>Using the Script ID entered above.</p>
    <label for="deploymentDescription">Deployment Description (Optional):</label>
    <input type="text" id="deploymentDescription" name="deploymentDescription">
    <p>This will deploy the current HEAD version as a new Web App deployment, using the Web App settings defined in <code>appsscript.json</code>.</p>
    <button type="submit" id="deployButton">Create New Web App Deployment</button>
  </form>

  <div id="deploy-loading-spinner" class="spinner" style="display:none;"></div>

  <div id="deploy-result-container" style="display:none;">
    <h3>Deployment Result:</h3>
    <pre id="deploy-result"></pre>
  </div>

  <script>
    let currentPolicyData = null; // Stores AI policy and original prompt
    let currentProposal = null; // Store the AI's code proposal globally for applyChanges
    let activeRequestId = null; // Global flag for the currently active request ID

    // Helper to get the effective script ID
    function getEffectiveScriptId() {
        const manualId = document.getElementById('scriptIdManualInput').value.trim();
        if (manualId) {
            return manualId;
        }
        return document.getElementById('scriptIdSelect').value.trim();
    }

    // --- Helper function to save scriptId to localStorage ---
    function saveScriptIdToLocalStorage(id) {
        if (id) {
            localStorage.setItem('targetScriptId', id);
        }
    }

    // Helper function to save gcpProjectId to localStorage
    function saveGcpProjectIdToLocalStorage(id) {
        if (id) {
            localStorage.setItem('gcpProjectId', id);
        }
    }

    // Function to load projects and populate the dropdown
    function loadProjectsIntoDropdown(selectedId = null) {
        const scriptIdSelect = document.getElementById('scriptIdSelect');
        const loadProjectsButton = document.getElementById('loadProjectsButton');
        loadProjectsButton.disabled = true; // Disable button while loading

        // Clear existing options except the placeholder
        scriptIdSelect.innerHTML = '<option value="">-- Select or type manually --</option>';

        google.script.run
            .withSuccessHandler(function(response) {
                loadProjectsButton.disabled = false;
                if (response.status === 'success') {
                    response.projects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = project.title;
                        scriptIdSelect.appendChild(option);
                    });
                    if (selectedId) {
                        scriptIdSelect.value = selectedId; // Set selected if saved ID was passed
                    }
                } else {
                    alert('Failed to load Apps Script projects: ' + response.message);
                }
            })
            .withFailureHandler(function(error) {
                loadProjectsButton.disabled = false;
                alert('Error loading Apps Script projects: ' + error.message);
            })
            .listAppsScriptProjects();
    }

    // --- Load scriptId from localStorage on page load ---
    document.addEventListener('DOMContentLoaded', function() {
      const scriptIdManualInput = document.getElementById('scriptIdManualInput');
      const gcpProjectIdInput = document.getElementById('gcpProjectId');

      const savedScriptId = localStorage.getItem('targetScriptId');
      if (savedScriptId) {
        scriptIdManualInput.value = savedScriptId;
      }

      // Load GCP Project ID from localStorage
      const savedGcpProjectId = localStorage.getItem('gcpProjectId');
      if (savedGcpProjectId) {
        gcpProjectIdInput.value = savedGcpProjectId;
      }

      // Auto-load projects on page load
      loadProjectsIntoDropdown(savedScriptId); // Pass the saved ID so it tries to pre-select

      // Initial UI state setup
      document.getElementById('policy-container').style.display = 'none';
      document.getElementById('proposal-container').style.display = 'none';
      document.getElementById('applyChangesButton').style.display = 'none';
      document.getElementById('apply-result-container').style.display = 'none';
      document.getElementById('fixApplyErrorsButton').style.display = 'none';
      document.getElementById('regeneratePolicyButton').style.display = 'none';
    });

    // Function to generate the formatted HTML for both original and proposed panels for a single file.
    // This function aims for simple highlighting of changes line-by-line without full diff alignment.
    function generateFormattedDiffPanels(originalSource, proposedSource) {
        const originalLines = originalSource ? originalSource.split('\n') : [];
        const proposedLines = proposedSource ? proposedSource.split('\n') : [];

        let originalLineNumbersHtml = '';
        let originalCodeContentHtml = '';
        let proposedLineNumbersHtml = '';
        let proposedCodeContentHtml = '';

        const maxLength = Math.max(originalLines.length, proposedLines.length);

        for (let i = 0; i < maxLength; i++) {
            const originalLine = originalLines[i] !== undefined ? originalLines[i] : '';
            const proposedLine = proposedLines[i] !== undefined ? proposedLines[i] : '';

            let originalLineClass = '';
            let proposedLineClass = '';

            if (originalLine === proposedLine) {
                // Lines are identical at this index, no special highlight
            } else {
                // Lines are different at this index.
                // Mark original line as removed and proposed line as added for simplicity.
                // This is not a true 'modified' state, but highlights the change.
                if (originalLine !== '') {
                    originalLineClass = 'diff-line-removed';
                }
                if (proposedLine !== '') {
                    proposedLineClass = 'diff-line-added';
                }
            }

            // Add line numbers, handling cases where one side is shorter
            originalLineNumbersHtml += `<div>${(i < originalLines.length) ? (i + 1) : '&nbsp;'}</div>`;
            proposedLineNumbersHtml += `<div>${(i < proposedLines.length) ? (i + 1) : '&nbsp;'}</div>`;

            // Add code content with classes, ensuring empty lines also take space
            originalCodeContentHtml += `<div class="${originalLineClass}">${escapeHtml(originalLine) || '&nbsp;'}</div>`;
            proposedCodeContentHtml += `<div class="${proposedLineClass}">${escapeHtml(proposedLine) || '&nbsp;'}</div>`;
        }

        return {
            originalLineNumbersHtml, originalCodeContentHtml,
            proposedLineNumbersHtml, proposedCodeContentHtml
        };
    }

    // Function to display file comparison
    function displayFileComparison(originalFiles, proposedFiles) {
      const displayArea = document.getElementById('proposed-files-display');
      displayArea.innerHTML = ''; // Clear previous content

      if (!proposedFiles || proposedFiles.length === 0) {
        displayArea.innerHTML = '<p>AI did not propose any changes to existing files, or no files were processed.</p>';
        return;
      }

      proposedFiles.forEach(proposedFile => {
          const name = proposedFile.name;
          const fileType = proposedFile.type; // Get type from the proposed file

          const originalFile = (originalFiles || []).find(f => f.name === name);
          const originalSource = originalFile ? originalFile.source : '';
          const proposedSource = proposedFile.source;

          const diffHtmlData = generateFormattedDiffPanels(originalSource, proposedSource);

          const fileComparisonDiv = document.createElement('div');
          fileComparisonDiv.className = 'file-comparison';

          // Original content display
          const originalContentDiv = document.createElement('div');
          originalContentDiv.innerHTML = `<h4>${name}.${getFileExtension(fileType)} (Original)</h4><pre class="scroll-sync-target">
              <div class="line-numbers-col">${diffHtmlData.originalLineNumbersHtml}</div>
              <div class="code-content-col">${diffHtmlData.originalCodeContentHtml}</div>
          </pre>`;
          
          // Proposed content display
          const proposedContentDiv = document.createElement('div');
          proposedContentDiv.innerHTML = `<h4>${name}.${getFileExtension(fileType)} (Proposed)</h4><pre class="scroll-sync-target">
              <div class="line-numbers-col">${diffHtmlData.proposedLineNumbersHtml}</div>
              <div class="code-content-col">${diffHtmlData.proposedCodeContentHtml}</div>
          </pre>`;
          
          fileComparisonDiv.appendChild(originalContentDiv);
          fileComparisonDiv.appendChild(proposedContentDiv);
          displayArea.appendChild(fileComparisonDiv);

          // Scroll synchronization
          const preElements = fileComparisonDiv.querySelectorAll('.scroll-sync-target');
          if (preElements.length === 2) {
              const pre1 = preElements[0];
              const pre2 = preElements[1];

              let isSyncing = false; // Flag to prevent infinite recursion between scroll events

              pre1.addEventListener('scroll', function() {
                  if (!isSyncing) {
                      isSyncing = true;
                      pre2.scrollTop = pre1.scrollTop;
                      isSyncing = false;
                  }
              });

              pre2.addEventListener('scroll', function() {
                  if (!isSyncing) {
                      isSyncing = true;
                      pre1.scrollTop = pre2.scrollTop;
                      isSyncing = false;
                  }
              });
          }
      });
    }

    function getFileExtension(type) {
      switch (type) {
        case 'SERVER_JS': return 'gs';
        case 'JSON': return 'json';
        case 'HTML': return 'html';
        default: return 'txt';
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.appendChild(document.createTextNode(text));
      return div.innerHTML;
    }

    // Main form submission handler for both policy generation and proposal generation
    document.getElementById('agent-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const submitterId = e.submitter.id;

      const generatePolicyButton = document.getElementById('generatePolicyButton');
      const cancelAiOperationButton = document.getElementById('cancelAiOperationButton');
      const loadingSpinner = document.getElementById('loading-spinner');
      const regeneratePolicyButton = document.getElementById('regeneratePolicyButton');

      const scriptId = getEffectiveScriptId();
      const promptText = document.getElementById('prompt').value;

      if (!scriptId) {
        alert('Please select or enter a Script ID.');
        return;
      }
      if (!promptText.trim()) {
        alert('Prompt cannot be empty.');
        return;
      }

      // Save scriptId to localStorage regardless of operation
      saveScriptIdToLocalStorage(scriptId);

      // Reset UI for new operation
      loadingSpinner.style.display = 'block';
      generatePolicyButton.disabled = true;
      document.getElementById('prompt').readOnly = true; // Disable prompt input during operation
      cancelAiOperationButton.style.display = 'inline-block';
      regeneratePolicyButton.style.display = 'none'; // Hide regenerate button
      document.getElementById('policy-container').style.display = 'none';
      document.getElementById('proposal-container').style.display = 'none';
      document.getElementById('applyChangesButton').style.display = 'none';
      document.getElementById('apply-result-container').style.display = 'none';
      document.getElementById('fixApplyErrorsButton').style.display = 'none';
      document.getElementById('proposed-files-display').innerHTML = '';
      document.getElementById('ai-policy').textContent = '';

      const formData = { scriptId: scriptId, prompt: promptText };

      // Generate a unique ID for this request and set it as active
      const requestId = Date.now();
      activeRequestId = requestId;

      if (submitterId === 'generatePolicyButton') {
        console.log('Generating policy...');
        google.script.run
          .withSuccessHandler(function(response) {
            if (activeRequestId !== requestId) {
              console.log('Ignoring stale success response for generateProposalPolicy.');
              return;
            }
            activeRequestId = null;
            loadingSpinner.style.display = 'none';
            generatePolicyButton.disabled = false;
            document.getElementById('prompt').readOnly = false; // Re-enable prompt input
            cancelAiOperationButton.style.display = 'none';

            if (response.status === 'policy') {
              currentPolicyData = response; // Store policy data
              document.getElementById('ai-policy').textContent = response.policy;
              document.getElementById('policy-container').style.display = 'block';
              document.getElementById('acceptPolicyButton').style.display = 'inline-block';
              regeneratePolicyButton.style.display = 'inline-block'; // Show regenerate button
              generatePolicyButton.style.display = 'none'; // Hide generate policy button
              document.getElementById('prompt').readOnly = true; // Keep prompt read-only until accepted or cancelled
            } else if (response.status === 'error') {
              document.getElementById('ai-policy').textContent = 'Error: ' + response.message;
              document.getElementById('policy-container').style.display = 'block';
            }
          })
          .withFailureHandler(function(error) {
            if (activeRequestId !== requestId) {
              console.log('Ignoring stale failure response for generateProposalPolicy.');
              return;
            }
            activeRequestId = null;
            loadingSpinner.style.display = 'none';
            generatePolicyButton.disabled = false;
            document.getElementById('prompt').readOnly = false;
            cancelAiOperationButton.style.display = 'none';
            document.getElementById('ai-policy').textContent = 'Error generating policy: ' + error.message;
            document.getElementById('policy-container').style.display = 'block';
          })
          .generateProposalPolicy(formData);
      }
    });

    // Event Listener for Accept Policy & Propose Changes button
    document.getElementById('acceptPolicyButton').addEventListener('click', function() {
      if (!currentPolicyData) {
        alert('No policy to accept. Please generate a policy first.');
        return;
      }

      const acceptPolicyButton = this;
      const generatePolicyButton = document.getElementById('generatePolicyButton');
      const cancelAiOperationButton = document.getElementById('cancelAiOperationButton');
      const loadingSpinner = document.getElementById('loading-spinner');
      const regeneratePolicyButton = document.getElementById('regeneratePolicyButton');

      // Reset UI for proposal generation
      loadingSpinner.style.display = 'block';
      acceptPolicyButton.disabled = true;
      acceptPolicyButton.style.display = 'none'; // Hide accept policy button
      regeneratePolicyButton.style.display = 'none'; // Hide regenerate button
      cancelAiOperationButton.style.display = 'inline-block';
      document.getElementById('policy-container').style.display = 'none'; // Hide policy container
      document.getElementById('prompt').readOnly = true; // Keep prompt read-only during proposal

      const formData = { scriptId: currentPolicyData.scriptId, prompt: currentPolicyData.userPrompt };

      const requestId = Date.now();
      activeRequestId = requestId;

      console.log('Generating code proposal...');
      google.script.run
        .withSuccessHandler(function(response) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale success response for processPrompt (after policy).');
            return;
          }
          activeRequestId = null;
          loadingSpinner.style.display = 'none';
          acceptPolicyButton.disabled = false;
          generatePolicyButton.style.display = 'inline-block'; // Show generate policy button again
          document.getElementById('prompt').readOnly = false; // Re-enable prompt input
          cancelAiOperationButton.style.display = 'none';

          if (response.status === 'proposal') {
            currentProposal = response; // Store the proposal
            document.getElementById('proposal-purpose').textContent = response.purpose || '説明がありません。'; // Display the purpose
            displayFileComparison(response.originalFiles, response.proposedFiles);
            document.getElementById('proposal-container').style.display = 'block';
            document.getElementById('applyChangesButton').style.display = 'block'; // Show apply button
            document.getElementById('apply-result').textContent = response.message; // Display initial message
            document.getElementById('apply-result-container').style.display = 'block';
          } else if (response.status === 'error') {
            document.getElementById('apply-result').textContent = 'Error: ' + response.message;
            document.getElementById('apply-result-container').style.display = 'block';
            document.getElementById('proposal-container').style.display = 'block'; // Show container to display error
          } else {
            document.getElementById('apply-result').textContent = 'Unexpected response status: ' + JSON.stringify(response);
            document.getElementById('apply-result-container').style.display = 'block';
            document.getElementById('proposal-container').style.display = 'block'; // Show container to display error
          }
        })
        .withFailureHandler(function(error) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale failure response for processPrompt (after policy).');
            return;
          }
          activeRequestId = null;
          loadingSpinner.style.display = 'none';
          acceptPolicyButton.disabled = false;
          generatePolicyButton.style.display = 'inline-block'; // Show generate policy button again
          document.getElementById('prompt').readOnly = false;
          cancelAiOperationButton.style.display = 'none';

          document.getElementById('apply-result').textContent = 'Error calling AI: ' + error.message;
          document.getElementById('apply-result-container').style.display = 'block';
          document.getElementById('proposal-container').style.display = 'block'; // Show container for error
        })
        .processPrompt(formData);
    });

    // Event Listener for general AI operation cancel button
    document.getElementById('cancelAiOperationButton').addEventListener('click', function() {
      activeRequestId = null; // Invalidate the current active request

      const generatePolicyButton = document.getElementById('generatePolicyButton');
      const cancelAiOperationButton = document.getElementById('cancelAiOperationButton');
      const loadingSpinner = document.getElementById('loading-spinner');
      const policyContainer = document.getElementById('policy-container');
      const proposalContainer = document.getElementById('proposal-container');
      const acceptPolicyButton = document.getElementById('acceptPolicyButton');
      const regeneratePolicyButton = document.getElementById('regeneratePolicyButton');
      const applyChangesButton = document.getElementById('applyChangesButton');
      const applyResultContainer = document.getElementById('apply-result-container');
      const fixApplyErrorsButton = document.getElementById('fixApplyErrorsButton');

      loadingSpinner.style.display = 'none';
      generatePolicyButton.disabled = false;
      document.getElementById('prompt').readOnly = false;
      cancelAiOperationButton.style.display = 'none';

      currentPolicyData = null; // Clear any partial policy
      currentProposal = null; // Clear any partial proposal
      document.getElementById('ai-policy').textContent = '';
      document.getElementById('proposal-purpose').textContent = '';
      document.getElementById('proposed-files-display').innerHTML = '';
      document.getElementById('apply-result').textContent = '';

      policyContainer.style.display = 'none';
      proposalContainer.style.display = 'none';
      acceptPolicyButton.style.display = 'none';
      regeneratePolicyButton.style.display = 'none';
      applyChangesButton.style.display = 'none';
      applyResultContainer.style.display = 'none';
      fixApplyErrorsButton.style.display = 'none';

      generatePolicyButton.style.display = 'inline-block'; // Ensure primary button is visible

      alert('AI操作はユーザーによってキャンセルされました。');
    });

    // Event Listener for Regenerate Policy button
    document.getElementById('regeneratePolicyButton').addEventListener('click', function() {
      const scriptId = getEffectiveScriptId();
      const promptText = document.getElementById('prompt').value;

      if (!scriptId) {
        alert('Please select or enter a Script ID.');
        return;
      }
      if (!promptText.trim()) {
        alert('Prompt cannot be empty.');
        return;
      }

      saveScriptIdToLocalStorage(scriptId);

      // UI Reset and loading state
      const loadingSpinner = document.getElementById('loading-spinner');
      const generatePolicyButton = document.getElementById('generatePolicyButton');
      const acceptPolicyButton = document.getElementById('acceptPolicyButton');
      const regeneratePolicyButton = this; // The button itself
      const cancelAiOperationButton = document.getElementById('cancelAiOperationButton');
      const policyContainer = document.getElementById('policy-container');
      const proposalContainer = document.getElementById('proposal-container');
      const applyChangesButton = document.getElementById('applyChangesButton');
      const applyResultContainer = document.getElementById('apply-result-container');
      const fixApplyErrorsButton = document.getElementById('fixApplyErrorsButton');

      loadingSpinner.style.display = 'block';
      generatePolicyButton.disabled = true; // Disable original generate button
      acceptPolicyButton.disabled = true; // Disable accept button
      regeneratePolicyButton.disabled = true; // Disable regenerate button
      document.getElementById('prompt').readOnly = true;
      cancelAiOperationButton.style.display = 'inline-block';

      // Hide all related sections and clear content
      policyContainer.style.display = 'none';
      proposalContainer.style.display = 'none';
      applyChangesButton.style.display = 'none';
      applyResultContainer.style.display = 'none';
      fixApplyErrorsButton.style.display = 'none';
      document.getElementById('proposed-files-display').innerHTML = '';
      document.getElementById('ai-policy').textContent = '';
      document.getElementById('proposal-purpose').textContent = '';

      currentPolicyData = null; // Clear previous policy data
      currentProposal = null; // Clear previous proposal data

      const formData = { scriptId: scriptId, prompt: promptText };

      const requestId = Date.now();
      activeRequestId = requestId;

      console.log('Regenerating policy...');
      google.script.run
        .withSuccessHandler(function(response) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale success response for regeneratePolicy.');
            return;
          }
          activeRequestId = null;
          loadingSpinner.style.display = 'none';
          generatePolicyButton.disabled = false; // Re-enable original generate button
          acceptPolicyButton.disabled = false; // Re-enable accept button
          regeneratePolicyButton.disabled = false; // Re-enable regenerate button
          document.getElementById('prompt').readOnly = false;
          cancelAiOperationButton.style.display = 'none';

          if (response.status === 'policy') {
            currentPolicyData = response;
            document.getElementById('ai-policy').textContent = response.policy;
            policyContainer.style.display = 'block';
            acceptPolicyButton.style.display = 'inline-block';
            regeneratePolicyButton.style.display = 'inline-block'; // Show regenerate button again
            generatePolicyButton.style.display = 'none'; // Keep original generate button hidden
            document.getElementById('prompt').readOnly = true; // Keep prompt read-only until accepted or cancelled
          } else if (response.status === 'error') {
            document.getElementById('ai-policy').textContent = 'Error: ' + response.message;
            policyContainer.style.display = 'block';
            generatePolicyButton.style.display = 'inline-block'; // Show original generate button on error
          }
        })
        .withFailureHandler(function(error) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale failure response for regeneratePolicy.');
            return;
          }
          activeRequestId = null;
          loadingSpinner.style.display = 'none';
          generatePolicyButton.disabled = false;
          acceptPolicyButton.disabled = false;
          regeneratePolicyButton.disabled = false;
          document.getElementById('prompt').readOnly = false;
          cancelAiOperationButton.style.display = 'none';

          document.getElementById('ai-policy').textContent = 'Error regenerating policy: ' + error.message;
          policyContainer.style.display = 'block';
          generatePolicyButton.style.display = 'inline-block'; // Show original generate button on error
        })
        .generateProposalPolicy(formData);
    });

    // Event Listener for Apply Changes
    document.getElementById('applyChangesButton').addEventListener('click', function() {
      if (!currentProposal) {
        document.getElementById('apply-result').textContent = 'Error: No proposal to apply.';
        document.getElementById('apply-result-container').style.display = 'block';
        return;
      }

      // --- Save scriptId to localStorage before applying changes ---
      saveScriptIdToLocalStorage(currentProposal.scriptId);

      const applyButton = this;
      const applySpinner = document.getElementById('apply-loading-spinner');
      const applyResultText = document.getElementById('apply-result');
      const fixApplyErrorsButton = document.getElementById('fixApplyErrorsButton');

      applyButton.disabled = true;
      fixApplyErrorsButton.style.display = 'none';
      applySpinner.style.display = 'block';
      applyResultText.textContent = 'Applying changes...';

      google.script.run
        .withSuccessHandler(function(response) {
          applySpinner.style.display = 'none';
          applyButton.disabled = false;
          
          if (response.status === 'success') {
            applyResultText.textContent = response.message;
            currentProposal = null; // Clear proposal
            document.getElementById('applyChangesButton').style.display = 'none';
            document.getElementById('proposed-files-display').innerHTML = '<p>Changes applied successfully. You can propose new changes or check logs.</p>';
            fixApplyErrorsButton.style.display = 'none';
          } else { // response.status === 'error'
            let errorMessage = response.message;
            if (response.fullErrorText) {
                errorMessage += '\nAPI Response: ' + response.fullErrorText;
            }
            else if (response.apiErrorDetails) {
                errorMessage += '\nAPI Details: ' + JSON.stringify(response.apiErrorDetails, null, 2);
            }
            applyResultText.textContent = errorMessage;
            fixApplyErrorsButton.style.display = 'block';
          }
        })
        .withFailureHandler(function(error) {
          applySpinner.style.display = 'none';
          applyButton.disabled = false;
          applyResultText.textContent = 'Error applying changes (Uncaught): ' + error.message;
          fixApplyErrorsButton.style.display = 'block';
        })
        .applyProposedChanges(currentProposal.scriptId, currentProposal.proposedFiles);
    });

    // Event Listener for Fix Apply Errors button
    document.getElementById('fixApplyErrorsButton').addEventListener('click', function() {
      const scriptId = getEffectiveScriptId();
      if (!scriptId) {
        document.getElementById('apply-result').textContent = 'Error: Script ID is required to fix errors.';
        document.getElementById('apply-result-container').style.display = 'block';
        return;
      }

      // Re-use the existing fix errors logic
      const fixButton = this; // The fixApplyErrorsButton itself
      const spinner = document.getElementById('fix-loading-spinner'); // Re-use the existing fix spinner
      const proposalContainer = document.getElementById('proposal-container');
      const applyButton = document.getElementById('applyChangesButton');
      const applyResultContainer = document.getElementById('apply-result-container');
      const generatePolicyButton = document.getElementById('generatePolicyButton'); // Updated from proposeChangesButton
      const cancelFixErrorsButton = document.getElementById('cancelFixErrorsButton');
      const promptInput = document.getElementById('prompt');

      // Generate a unique ID for this request and set it as active
      const requestId = Date.now();
      activeRequestId = requestId;

      fixButton.disabled = true;
      generatePolicyButton.disabled = true;
      promptInput.readOnly = true; // Disable prompt input during operation
      cancelFixErrorsButton.style.display = 'inline-block';
      spinner.style.display = 'block';
      proposalContainer.style.display = 'none';
      applyButton.style.display = 'none';
      applyResultContainer.style.display = 'none';
      document.getElementById('proposed-files-display').innerHTML = '';

      // Save scriptId to localStorage
      saveScriptIdToLocalStorage(scriptId);

      google.script.run
        .withSuccessHandler(function(response) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale success response for fixErrorsFromLogs.');
            return; 
          }
          activeRequestId = null;
          spinner.style.display = 'none';
          fixButton.disabled = false;
          generatePolicyButton.disabled = false; 
          promptInput.readOnly = false; 
          cancelFixErrorsButton.style.display = 'none';

          if (response.status === 'proposal') {
            currentProposal = response;
            document.getElementById('proposal-purpose').textContent = response.purpose || '説明がありません。';
            displayFileComparison(response.originalFiles, response.proposedFiles);
            proposalContainer.style.display = 'block';
            applyButton.style.display = 'block';
            document.getElementById('apply-result').textContent = response.message;
            applyResultContainer.style.display = 'block';
            fixButton.style.display = 'none'; 
          } else if (response.status === 'error') {
            document.getElementById('apply-result').textContent = 'Error: ' + response.message;
            applyResultContainer.style.display = 'block';
            proposalContainer.style.display = 'block';
          } else {
            document.getElementById('apply-result').textContent = 'Unexpected response status: ' + JSON.stringify(response);
            applyResultContainer.style.display = 'block';
            proposalContainer.style.display = 'block';
          }
        })
        .withFailureHandler(function(error) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale failure response for fixErrorsFromLogs.');
            return; 
          }
          activeRequestId = null;
          spinner.style.display = 'none';
          fixButton.disabled = false;
          generatePolicyButton.disabled = false; 
          promptInput.readOnly = false; 
          cancelFixErrorsButton.style.display = 'none';

          document.getElementById('apply-result').textContent = 'Error calling AI for fix: ' + error.message;
          document.getElementById('apply-result-container').style.display = 'block';
          document.getElementById('proposal-container').style.display = 'block';
        })
        .fixErrorsFromLogs(scriptId);
    });

    // Event Listener for Cancel Fix Errors
    document.getElementById('cancelFixErrorsButton').addEventListener('click', function() {
      activeRequestId = null; // Invalidate the current active request

      const fixButton = document.getElementById('fixErrorsButton');
      const cancelFixErrorsButton = document.getElementById('cancelFixErrorsButton');
      const spinner = document.getElementById('fix-loading-spinner');
      const proposalContainer = document.getElementById('proposal-container');
      const applyButton = document.getElementById('applyChangesButton');
      const applyResultContainer = document.getElementById('apply-result-container');
      const fixApplyErrorsButton = document.getElementById('fixApplyErrorsButton');
      const generatePolicyButton = document.getElementById('generatePolicyButton'); // Updated from proposeChangesButton
      const promptInput = document.getElementById('prompt');

      spinner.style.display = 'none';
      fixButton.disabled = false;
      generatePolicyButton.disabled = false; 
      promptInput.readOnly = false; 
      cancelFixErrorsButton.style.display = 'none';
      
      currentProposal = null; // Clear any partial proposal
      document.getElementById('proposal-purpose').textContent = '';
      document.getElementById('proposed-files-display').innerHTML = '<p>AIによるエラー修正はユーザーによってキャンセルされました。</p>';
      proposalContainer.style.display = 'block'; 
      applyButton.style.display = 'none';
      applyResultContainer.style.display = 'none';
      fixApplyErrorsButton.style.display = 'none';
    });


    // Event Listener for Save GCP Project ID
    document.getElementById('saveGcpProjectIdButton').addEventListener('click', function() {
      const gcpProjectIdInput = document.getElementById('gcpProjectId');
      const gcpProjectId = gcpProjectIdInput.value.trim();
      const saveResultContainer = document.getElementById('gcp-save-result-container');
      const saveResultText = document.getElementById('gcp-save-result');

      saveResultContainer.style.display = 'block';
      saveResultText.textContent = 'Saving...';

      if (!gcpProjectId) {
        saveResultText.textContent = 'Error: GCP Project ID cannot be empty.';
        return;
      }

      google.script.run
        .withSuccessHandler(function(response) {
          saveResultText.textContent = response.message;
          if (response.status === 'success') {
            saveGcpProjectIdToLocalStorage(gcpProjectId); // Save to localStorage on success
          }
        })
        .withFailureHandler(function(error) {
          saveResultText.textContent = 'Error saving GCP Project ID: ' + error.message;
        })
        .setGcpProjectId(gcpProjectId);
    });

    document.getElementById('log-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = this;
      const submitButton = form.querySelector('#getLogsButton');
      const spinner = document.getElementById('log-loading-spinner');

      submitButton.disabled = true;
      spinner.style.display = 'block';

      const scriptId = getEffectiveScriptId();

      // --- Save scriptId to localStorage when getting logs ---
      saveScriptIdToLocalStorage(scriptId);

      google.script.run
        .withSuccessHandler(function(response) {
          document.getElementById('log-result').textContent = response;
          document.getElementById('log-result-container').style.display = 'block';
          submitButton.disabled = false;
          spinner.style.display = 'none';
        })
        .withFailureHandler(function(error) {
          document.getElementById('log-result').textContent = 'Error: ' + error.message;
          document.getElementById('log-result-container').style.display = 'block';
          submitButton.disabled = false;
          spinner.style.display = 'none';
        })
        .getScriptLogs(scriptId);
    });

    // Event Listener for Deploy Script
    document.getElementById('deploy-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = this;
      const submitButton = form.querySelector('#deployButton');
      const spinner = document.getElementById('deploy-loading-spinner');
      const resultContainer = document.getElementById('deploy-result-container');
      const resultText = document.getElementById('deploy-result');

      submitButton.disabled = true;
      spinner.style.display = 'block';
      resultContainer.style.display = 'none';
      resultText.textContent = '';

      const scriptId = getEffectiveScriptId();
      const description = document.getElementById('deploymentDescription').value;

      // Save scriptId to localStorage when deploying
      saveScriptIdToLocalStorage(scriptId);

      google.script.run
        .withSuccessHandler(function(response) {
          spinner.style.display = 'none';
          submitButton.disabled = false;
          resultContainer.style.display = 'block';
          if (response.status === 'success') {
            let webappUrlHtml = `Web App URL: ${response.webappUrl}`;
            if (response.webappUrl && response.webappUrl !== 'URL not found in response') {
              webappUrlHtml = `Web App URL: <a href="${response.webappUrl}" target="_blank">${response.webappUrl}</a>`;
            }
            resultText.innerHTML = `${response.message}<br>Deployment ID: ${response.deploymentId}<br>${webappUrlHtml}`;
          } else {
            resultText.textContent = `Error: ${response.message}`;
          }
        })
        .withFailureHandler(function(error) {
          spinner.style.display = 'none';
          submitButton.disabled = false;
          resultContainer.style.display = 'block';
          resultText.textContent = `Error deploying script: ${error.message}`;
        })
        .deployScript(scriptId, description);
    });

    // Event listener for Load Projects button
    document.getElementById('loadProjectsButton').addEventListener('click', function() {
        loadProjectsIntoDropdown(getEffectiveScriptId()); // Pass current ID to try and re-select
    });

    // Event Listener for Show Editor URL button
    document.getElementById('editor-url-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = this;
      const submitButton = form.querySelector('#getEditorUrlButton');
      const spinner = document.getElementById('editor-url-loading-spinner');
      const resultContainer = document.getElementById('editor-url-result-container');
      const resultText = document.getElementById('editor-url-result');

      submitButton.disabled = true;
      spinner.style.display = 'block';
      resultContainer.style.display = 'none';
      resultText.textContent = '';

      const scriptId = getEffectiveScriptId();

      // Save scriptId to localStorage when getting editor URL
      saveScriptIdToLocalStorage(scriptId);

      if (!scriptId) {
        resultText.textContent = 'Error: スクリプトIDが指定されていません。';
        resultContainer.style.display = 'block';
        submitButton.disabled = false;
        spinner.style.display = 'none';
        return;
      }

      google.script.run
        .withSuccessHandler(function(response) {
          spinner.style.display = 'none';
          submitButton.disabled = false;
          resultContainer.style.display = 'block';
          if (response.startsWith("エラー:")) {
            resultText.textContent = response;
          } else {
            resultText.innerHTML = `Apps Script Editor URL: <a href="${response}" target="_blank">${response}</a>`;
          }
        })
        .withFailureHandler(function(error) {
          spinner.style.display = 'none';
          submitButton.disabled = false;
          resultContainer.style.display = 'block';
          resultText.textContent = `Error getting editor URL: ${error.message}`;
        })
        .getScriptEditorUrl(scriptId);
    });
  </script>
</body>
</html>
