<!DOCTYPE html>
<html lang="en">
<head>
<base target="_top">
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.0/css/bulma.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js"></script>
<?!= include('style'); ?>
</head>
<body>
  <section class="section">
    <div class="container">
      <h1 class="title is-2">Methane AI Agent</h1>

      <form id="agent-form" class="box">
        <div class="field mb-3">
          <label class="label" for="scriptIdSelect">Target Script ID:</label>
          <div class="control is-expanded">
            <div class="select is-fullwidth">
              <select id="scriptIdSelect" name="scriptIdSelect">
                <option value="">-- Select or type manually --</option>
              </select>
            </div>
          </div>
        </div>
        <div class="field mb-3">
          <div class="control">
            <input type="text" id="scriptIdManualInput" placeholder="Or paste Script ID here (overrides selection)" class="input">
          </div>
        </div>
        <div id="editor-url-display" class="notification is-light is-info is-small mb-4"></div>

        <div class="field">
          <label class="label" for="prompt">Prompt:</label>
          <div class="control">
            <textarea id="prompt" name="prompt" required class="textarea"></textarea>
          </div>
        </div>
        <div class="field is-grouped">
          <div class="control">
            <button type="submit" id="generatePolicyButton" class="button is-primary">Generate Policy</button>
          </div>
          <div class="control">
            <button type="button" id="cancelAiOperationButton" class="button is-danger is-light" style="display:none;">Cancel</button>
          </div>
        </div>
      </form>

      <!-- Loading spinner for policy generation -->
      <div id="policy-loading-spinner" class="spinner" style="display:none;"></div>

      <!-- Policy Review Section -->
      <div id="policy-container" class="box mt-4" style="display:none;">
        <h2 class="title is-4">AI Generated Policy:</h2>
        <div class="field is-grouped is-flex is-justify-content-space-between is-align-items-center mb-3">
          <div class="control">
            <!-- Policy editing controls (placeholder for future expansion) -->
          </div>
          <div class="control">
            <button type="button" id="togglePolicyEditButton" class="button is-small is-light">Edit Policy</button>
          </div>
        </div>
        <div id="ai-policy" class="content"></div>
        <textarea id="policyEditor" class="textarea is-small" style="display:none; height: 200px;"></textarea>
        <div class="field is-grouped mt-3">
          <div class="control">
            <button type="button" id="acceptPolicyButton" class="button is-success" style="display:none;">Accept Policy & Propose Changes</button>
          </div>
          <div class="control">
            <button type="button" id="regeneratePolicyButton" class="button is-warning is-light" style="display:none;">Regenerate Policy</button>
          </div>
        </div>
      </div>

      <!-- Loading spinner for proposal generation -->
      <div id="proposal-loading-spinner" class="spinner" style="display:none;"></div>

      <!-- Proposal Review Section -->
      <div id="proposal-container" class="box mt-4" style="display:none;">
        <h2 class="title is-4">AI Proposed Changes:</h2>
        <p class="content"><strong id="proposal-purpose-label">Purpose of Change:</strong> <span id="proposal-purpose"></span></p>
        <!-- NEW: HTML Validation Warnings -->
        <div id="html-validation-warnings" class="notification is-danger is-light mb-4" style="display: none;"></div>
        <p class="content">The following changes have been proposed by the AI. Please review the content and click the "Apply Changes" button to apply if there are no issues.</p>
        <div id="proposed-files-display">
          <!-- File comparisons will be inserted here by JavaScript -->
        </div>
        <div class="field mt-3">
          <label class="checkbox">
            <input type="checkbox" id="autoDeployAfterApply">
            Auto-deploy after applying
          </label>
        </div>
        <div class="field is-grouped mt-4">
          <div class="control">
            <button type="button" id="applyChangesButton" class="button is-primary" style="display:none;">Apply Changes</button>
          </div>
          <div class="control">
            <button type="button" id="regenerateProposalButton" class="button is-info is-light" style="display:none;">Regenerate Proposal</button>
          </div>
        </div>
        <div id="apply-loading-spinner" class="spinner" style="display:none;"></div>
        <div id="apply-result-container" class="box mt-4" style="display:none;">
          <h3 class="title is-5">Apply Result:</h3>
          <pre id="apply-result" class="content"></pre>
          <!-- NEW BUTTON for fixing errors after apply failure -->
          <button type="button" id="fixApplyErrorsButton" class="button is-danger mt-3" style="display:none;">Fix Apply Errors with AI</button>
        </div>
      </div>

      <hr class="my-5">

      <h2 class="title is-4">Google Cloud Project ID Configuration</h2>
      <p class="content">A Google Cloud Project linked to this Apps Script is required for log retrieval. Please manually set your GCP Project ID in case automatic retrieval via API fails.</p>
      <div class="field">
        <label class="label" for="gcpProjectId">GCP Project ID:</label>
        <div class="control">
          <input type="text" id="gcpProjectId" name="gcpProjectId" class="input">
        </div>
      </div>
      <div class="control mt-3">
        <button type="button" id="saveGcpProjectIdButton" class="button is-info">Save GCP Project ID</button>
      </div>
      <div id="gcp-save-result-container" class="box mt-4" style="display:none;">
        <h3 class="title is-5">Save Result:</h3>
        <pre id="gcp-save-result" class="content"></pre>
      </div>

      <hr class="my-5">

      <h2 class="title is-4">Get Script Logs</h2>
      <form id="log-form">
        <p class="content">Using the Script ID entered above.</p>
        <div class="control">
          <button type="submit" id="getLogsButton" class="button is-link">Get Logs</button>
        </div>
      </form>

      <div id="log-result-container" class="box mt-4" style="display:none;">
        <div id="log-loading-spinner" class="spinner" style="display:none;"></div>
        <h3 class="title is-5">Logs:</h3>
        <pre id="log-result" class="content"></pre>
      </div>

      <hr class="my-5">

      <h2 class="title is-4">Automated Error Fix from Logs</h2>
      <p class="content">Allows AI to propose error fixes based on existing script logs. Proposed changes will appear in the "AI Proposed Changes" section above.</p>
      <form id="fix-errors-form">
        <p class="content">Using the Script ID entered above.</p>
        <div class="field is-grouped">
          <div class="control">
            <button type="submit" id="fixErrorsButton" class="button is-danger">Fix Errors from Logs</button>
          </div>
          <div class="control">
            <button type="button" id="cancelFixErrorsButton" class="button is-warning is-light" style="display:none;">Cancel</button>
          </div>
        </div>
      </form>

      <hr class="my-5">

      <h2 class="title is-4">Deploy Script</h2>
      <form id="deploy-form">
        <p class="content">Using the Script ID entered above.</p>
        <div class="field">
          <label class="label" for="deploymentDescription">Deployment Description (Optional):</label>
          <div class="control">
            <input type="text" id="deploymentDescription" name="deploymentDescription" class="input">
          </div>
        </div>
        <p class="content is-small">This will deploy the current HEAD version as a new Web App deployment, using the Web App settings defined in <code>appsscript.json</code>.</p>
        <div class="control">
          <button type="submit" id="deployButton" class="button is-info">Create New Web App Deployment</button>
        </div>
      </form>

      <div id="deploy-result-container" class="box mt-4" style="display:none;">
        <div id="deploy-loading-spinner" class="spinner" style="display:none;"></div>
        <h3 class="title is-5">Deployment Result:</h3>
        <pre id="deploy-result" class="content"></pre>
      </div>

      <hr class="my-5">

      <h2 class="title is-4">Add Apps Script Library</h2>
      <p class="content">Target Script ID is the one entered above.</p>
      <form id="add-library-form">
        <div class="field">
          <label class="label" for="libraryScriptId">Library Script ID:</label>
          <div class="control">
            <input type="text" id="libraryScriptId" name="libraryScriptId" required class="input">
          </div>
        </div>
        <div class="field">
          <label class="label" for="libraryVersion">Library Version (Optional, defaults to HEAD):</label>
          <div class="control">
            <input type="text" id="libraryVersion" name="libraryVersion" placeholder="e.g., 1, 2, 3 or HEAD" class="input">
          </div>
        </div>
        <div class="control mt-3">
          <button type="submit" id="addLibraryButton" class="button is-success">Add Library</button>
        </div>
      </form>

      <div id="add-library-result-container" class="box mt-4" style="display:none;">
        <div id="add-library-loading-spinner" class="spinner" style="display:none;"></div>
        <h3 class="title is-5">Add Library Result:</h3>
        <pre id="add-library-result" class="content"></pre>
      </div>

      <!-- NEW: Version Control Section -->
      <hr class="my-5">

      <h2 class="title is-4">Version Control</h2>
      <p class="content">View script version history and revert to a specific past version.</p>
      <div class="field is-grouped">
        <div class="control">
          <button type="button" id="getVersionsButton" class="button is-info">Get Versions</button>
        </div>
        <div class="control is-expanded">
          <div class="select is-fullwidth">
            <select id="versionSelect">
              <option value="">-- Select a version --</option>
            </select>
          </div>
        </div>
        <div class="control">
          <button type="button" id="revertVersionButton" class="button is-danger" disabled>Revert to Selected Version</button>
        </div>
      </div>

      <div id="version-loading-spinner" class="spinner" style="display:none;"></div>
      <div id="version-result-container" class="box mt-4" style="display:none;">
        <h3 class="title is-5">Version Operation Result:</h3>
        <pre id="version-result" class="content"></pre>
      </div>

    </div>
  </section>

  <script>
    let currentPolicyData = null; 
    let currentProposal = null; 
    let activeRequestId = null; 
    let isPolicyEditing = false; 

    function getEffectiveScriptId() {
        const manualId = document.getElementById('scriptIdManualInput').value.trim();
        if (manualId) {
            return manualId;
        }
        return document.getElementById('scriptIdSelect').value.trim();
    }

    function saveScriptIdToLocalStorage(id) {
        if (id) {
            localStorage.setItem('targetScriptId', id);
        }
    }

    function saveGcpProjectIdToLocalStorage(id) {
        if (id) {
            localStorage.setItem('gcpProjectId', id);
        }
    }

    function loadProjectsIntoDropdown(selectedId = null) {
        const scriptIdSelect = document.getElementById('scriptIdSelect');

        scriptIdSelect.innerHTML = '<option value="">-- Select or type manually --</option>';

        google.script.run
            .withSuccessHandler(function(response) {
                if (response.status === 'success') {
                    response.projects.forEach(project => {
                        const option = document.createElement('option');
                        option.value = project.id;
                        option.textContent = project.title;
                        scriptIdSelect.appendChild(option);
                    });
                    if (selectedId) {
                        scriptIdSelect.value = selectedId;
                    }
                } else {
                    alert('Failed to load Apps Script projects: ' + response.message);
                }
            })
            .withFailureHandler(function(error) {
                alert('Error loading Apps Script projects: ' + error.message);
            })
            .listAppsScriptProjects();
    }

    function updateEditorUrlDisplay() {
        const scriptId = getEffectiveScriptId();
        const editorUrlDisplayDiv = document.getElementById('editor-url-display');
        
        editorUrlDisplayDiv.innerHTML = ''; 

        if (!scriptId) {
            editorUrlDisplayDiv.textContent = 'Apps Script Editor URL: (Script ID needed)';
            return;
        }

        editorUrlDisplayDiv.innerHTML = 'Apps Script Editor URL: <span class="spinner" style="width: 14px; height: 14px; display: inline-block; vertical-align: middle; margin: 0 5px;"></span> Loading...';

        saveScriptIdToLocalStorage(scriptId);

        google.script.run
            .withSuccessHandler(function(response) {
                if (response.startsWith("Error:")) {
                    editorUrlDisplayDiv.textContent = `Apps Script Editor URL: ${response}`;
                } else {
                    editorUrlDisplayDiv.innerHTML = `Apps Script Editor URL: <a href="${response}" target="_blank">${response}</a>`;
                }
            })
            .withFailureHandler(function(error) {
                editorUrlDisplayDiv.textContent = `Apps Script Editor URL: Error - ${error.message}`;
            })
            .getScriptEditorUrl(scriptId);
    }

    document.addEventListener('DOMContentLoaded', function() {
      const scriptIdManualInput = document.getElementById('scriptIdManualInput');
      const gcpProjectIdInput = document.getElementById('gcpProjectId');

      const savedScriptId = localStorage.getItem('targetScriptId');
      if (savedScriptId) {
        scriptIdManualInput.value = savedScriptId;
      }

      const savedGcpProjectId = localStorage.getItem('gcpProjectId');
      if (savedGcpProjectId) {
        gcpProjectIdInput.value = savedGcpProjectId;
      }

      loadProjectsIntoDropdown(savedScriptId);

      document.getElementById('policy-container').style.display = 'none';
      document.getElementById('proposal-container').style.display = 'none';
      document.getElementById('applyChangesButton').style.display = 'none';
      document.getElementById('regenerateProposalButton').style.display = 'none';
      document.getElementById('apply-result-container').style.display = 'none';
      document.getElementById('fixApplyErrorsButton').style.display = 'none';
      document.getElementById('regeneratePolicyButton').style.display = 'none';
      
      document.getElementById('version-result-container').style.display = 'none';

      updateEditorUrlDisplay();

      const promptTextarea = document.getElementById('prompt');
      if (promptTextarea) {
        promptTextarea.addEventListener('keydown', function(event) {
          if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
            event.preventDefault();
            document.getElementById('agent-form').requestSubmit(document.getElementById('generatePolicyButton'));
          }
        });
      }
    });

    document.getElementById('scriptIdSelect').addEventListener('change', updateEditorUrlDisplay);
    document.getElementById('scriptIdManualInput').addEventListener('input', updateEditorUrlDisplay);

    function validateHtml(htmlString, fileName) {
        console.log(`HTML validation started for file: ${fileName}`);
        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlString, 'text/html');
        const parseError = doc.querySelector('parsererror');

        if (parseError) {
            const errorMessage = parseError.textContent;
            console.error(`HTML validation failed in ${fileName}:`, errorMessage);
            return { isValid: false, message: `Syntax error found in HTML file "${fileName}": ${errorMessage}` };
        }
        console.log(`HTML validation successful for file: ${fileName}`);
        return { isValid: true };
    }

    function generateFormattedDiffPanels(originalSource, proposedSource) {
        const originalLines = originalSource ? originalSource.split('\n') : [];
        const proposedLines = proposedSource ? proposedSource.split('\n') : [];

        const diffResult = [];
        let i = 0;
        let j = 0;
        const lookAheadWindow = 5;

        while (i < originalLines.length || j < proposedLines.length) {
            const currentOriginalLine = originalLines[i];
            const currentProposedLine = proposedLines[j];

            if (i < originalLines.length && j < proposedLines.length && currentOriginalLine === currentProposedLine) {
                diffResult.push({ type: 'equal', original: currentOriginalLine, proposed: currentProposedLine });
                i++;
                j++;
            } else {
                let originalFoundInProposedAhead = -1;
                for (let k = j + 1; k < Math.min(j + 1 + lookAheadWindow, proposedLines.length); k++) {
                    if (i < originalLines.length && originalLines[i] === proposedLines[k]) {
                        originalFoundInProposedAhead = k;
                        break;
                    }
                }

                let proposedFoundInOriginalAhead = -1;
                for (let k = i + 1; k < Math.min(i + 1 + lookAheadWindow, originalLines.length); k++) {
                    if (j < proposedLines.length && proposedLines[j] === originalLines[k]) {
                        proposedFoundInOriginalAhead = k;
                        break;
                    }
                }

                if (i < originalLines.length && j < proposedLines.length && originalFoundInProposedAhead === -1 && proposedFoundInOriginalAhead === -1) {
                    diffResult.push({ type: 'modified', original: currentOriginalLine, proposed: currentProposedLine });
                    i++;
                    j++;
                } else if (originalFoundInProposedAhead !== -1 && (proposedFoundInOriginalAhead === -1 || (originalFoundInProposedAhead - j) <= (proposedFoundInOriginalAhead - i))) {
                    diffResult.push({ type: 'added', original: '', proposed: currentProposedLine });
                    j++;
                } else if (proposedFoundInOriginalAhead !== -1 && (originalFoundInProposedAhead === -1 || (proposedFoundInOriginalAhead - i) < (originalFoundInProposedAhead - j))) {
                    diffResult.push({ type: 'removed', original: currentOriginalLine, proposed: '' });
                    i++;
                } else if (i < originalLines.length) {
                    diffResult.push({ type: 'removed', original: currentOriginalLine, proposed: '' });
                    i++;
                } else if (j < proposedLines.length) {
                    diffResult.push({ type: 'added', original: '', proposed: currentProposedLine });
                    j++;
                }
            }
        }

        let originalLineNumbersHtml = '';
        let originalCodeContentHtml = '';
        let proposedLineNumbersHtml = '';
        let proposedCodeContentHtml = '';

        let originalLineNum = 0;
        let proposedLineNum = 0;

        diffResult.forEach(entry => {
            if (entry.type === 'equal') {
                originalLineNum++;
                proposedLineNum++;
                originalLineNumbersHtml += `<div>${originalLineNum}</div>`;
                originalCodeContentHtml += `<div class="diff-line-equal">${escapeHtml(entry.original)}</div>`;
                proposedLineNumbersHtml += `<div>${proposedLineNum}</div>`;
                proposedCodeContentHtml += `<div class="diff-line-equal">${escapeHtml(entry.proposed)}</div>`;
            } else if (entry.type === 'added') {
                proposedLineNum++;
                originalLineNumbersHtml += `<div>&nbsp;</div>`;
                originalCodeContentHtml += `<div class="diff-line-empty-fill">&nbsp;</div>`;
                proposedLineNumbersHtml += `<div>${proposedLineNum}</div>`;
                proposedCodeContentHtml += `<div class="diff-line-added">${escapeHtml(entry.proposed)}</div>`;
            } else if (entry.type === 'removed') {
                originalLineNum++;
                originalLineNumbersHtml += `<div>${originalLineNum}</div>`;
                originalCodeContentHtml += `<div class="diff-line-removed">${escapeHtml(entry.original)}</div>`;
                proposedLineNumbersHtml += `<div>&nbsp;</div>`;
                proposedCodeContentHtml += `<div class="diff-line-empty-fill">&nbsp;</div>`;
            } else if (entry.type === 'modified') {
                originalLineNum++;
                proposedLineNum++;
                originalLineNumbersHtml += `<div>${originalLineNum}</div>`;
                originalCodeContentHtml += `<div class="diff-line-modified">${escapeHtml(entry.original)}</div>`;
                proposedLineNumbersHtml += `<div>${proposedLineNum}</div>`;
                proposedCodeContentHtml += `<div class="diff-line-modified">${escapeHtml(entry.proposed)}</div>`;
            }
        });

        return {
            originalLineNumbersHtml, originalCodeContentHtml,
            proposedLineNumbersHtml, proposedCodeContentHtml
        };
    }

    function displayFileComparison(originalFiles, proposedFiles) {
      const displayArea = document.getElementById('proposed-files-display');
      displayArea.innerHTML = ''; 

      if (!proposedFiles || proposedFiles.length === 0) {
        displayArea.innerHTML = '<p>AI did not propose any changes to existing files, or no files were processed.</p>';
        return;
      }

      proposedFiles.forEach(proposedFile => {
          const name = proposedFile.name;
          const fileType = proposedFile.type; 

          const originalFile = (originalFiles || []).find(f => f.name === name);
          const originalSource = originalFile ? originalFile.source : '';
          const proposedSource = proposedFile.source;

          const diffHtmlData = generateFormattedDiffPanels(originalSource, proposedSource);

          const fileComparisonDiv = document.createElement('div');
          fileComparisonDiv.className = 'file-comparison';

          const originalContentDiv = document.createElement('div');
          originalContentDiv.innerHTML = `<h4>${name}.${getFileExtension(fileType)} (Original)</h4><pre class="scroll-sync-target">
              <div class="line-numbers-col">${diffHtmlData.originalLineNumbersHtml}</div>
              <div class="code-content-col">${diffHtmlData.originalCodeContentHtml}</div>
          </pre>`;
          
          const proposedContentDiv = document.createElement('div');
          proposedContentDiv.innerHTML = `<h4>${name}.${getFileExtension(fileType)} (Proposed)</h4><pre class="scroll-sync-target">
              <div class="line-numbers-col">${diffHtmlData.proposedLineNumbersHtml}</div>
              <div class="code-content-col">${diffHtmlData.proposedCodeContentHtml}</div>
          </pre>`;
          
          fileComparisonDiv.appendChild(originalContentDiv);
          fileComparisonDiv.appendChild(proposedContentDiv);
          displayArea.appendChild(fileComparisonDiv);

          const preElements = fileComparisonDiv.querySelectorAll('.scroll-sync-target');
          if (preElements.length === 2) {
              const pre1 = preElements[0];
              const pre2 = preElements[1];

              let isSyncing = false; 

              pre1.addEventListener('scroll', function() {
                  if (!isSyncing) {
                      isSyncing = true;
                      pre2.scrollTop = pre1.scrollTop;
                      isSyncing = false;
                  }
              });

              pre2.addEventListener('scroll', function() {
                  if (!isSyncing) {
                      isSyncing = true;
                      pre1.scrollTop = pre2.scrollTop;
                      isSyncing = false;
                  }
              });
          }
      });
    }

    function getFileExtension(type) {
      switch (type) {
        case 'SERVER_JS': return 'gs';
        case 'JSON': return 'json';
        default: return 'html';
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.appendChild(document.createTextNode(text));
      return div.innerHTML;
    }

    document.getElementById('agent-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const submitterId = e.submitter.id;

      const generatePolicyButton = document.getElementById('generatePolicyButton');
      const cancelAiOperationButton = document.getElementById('cancelAiOperationButton');
      const policyLoadingSpinner = document.getElementById('policy-loading-spinner');
      const regeneratePolicyButton = document.getElementById('regeneratePolicyButton');
      const promptInput = document.getElementById('prompt');

      const scriptId = getEffectiveScriptId();
      const promptText = promptInput.value;

      if (!scriptId) {
        alert('Please select or enter a Script ID.');
        return;
      }
      if (!promptText.trim()) {
        alert('Prompt cannot be empty.');
        return;
      }

      saveScriptIdToLocalStorage(scriptId);

      policyLoadingSpinner.style.display = 'block';
      generatePolicyButton.disabled = true;
      promptInput.readOnly = true;
      cancelAiOperationButton.style.display = 'inline-block';
      regeneratePolicyButton.style.display = 'none';
      document.getElementById('regenerateProposalButton').style.display = 'none';
      document.getElementById('policy-container').style.display = 'none';
      document.getElementById('proposal-container').style.display = 'none';
      document.getElementById('applyChangesButton').style.display = 'none';
      document.getElementById('apply-result-container').style.display = 'none';
      document.getElementById('fixApplyErrorsButton').style.display = 'none';
      document.getElementById('proposed-files-display').innerHTML = '';
      document.getElementById('ai-policy').innerHTML = '';
      document.getElementById('html-validation-warnings').style.display = 'none'; 
      document.getElementById('html-validation-warnings').innerHTML = ''; 
      document.getElementById('version-result-container').style.display = 'none';
      document.getElementById('policyEditor').style.display = 'none';
      document.getElementById('togglePolicyEditButton').textContent = 'Edit Policy';
      isPolicyEditing = false;

      const formData = { scriptId: scriptId, prompt: promptText };

      const requestId = Date.now();
      activeRequestId = requestId;

      if (submitterId === 'generatePolicyButton') {
        console.log('Generating policy...');
        google.script.run
          .withSuccessHandler(function(response) {
            if (activeRequestId !== requestId) {
              console.log('Ignoring stale success response for generateProposalPolicy.');
              return;
            }
            activeRequestId = null;
            policyLoadingSpinner.style.display = 'none';
            generatePolicyButton.disabled = false;
            cancelAiOperationButton.style.display = 'none';

            if (response.status === 'policy') {
              currentPolicyData = response; 
              document.getElementById('ai-policy').innerHTML = marked.parse(response.policy);
              document.getElementById('policy-container').style.display = 'block';
              document.getElementById('acceptPolicyButton').style.display = 'inline-block';
              regeneratePolicyButton.style.display = 'inline-block';
              generatePolicyButton.style.display = 'none';
              promptInput.readOnly = false;
            } else if (response.status === 'error') {
              document.getElementById('ai-policy').textContent = 'Error: ' + response.message;
              document.getElementById('policy-container').style.display = 'block';
              promptInput.readOnly = false;
            }
          })
          .withFailureHandler(function(error) {
            if (activeRequestId !== requestId) {
              console.log('Ignoring stale failure response for generateProposalPolicy.');
              return;
            }
            activeRequestId = null;
            policyLoadingSpinner.style.display = 'none';
            generatePolicyButton.disabled = false;
            promptInput.readOnly = false;
            cancelAiOperationButton.style.display = 'none';
            document.getElementById('ai-policy').textContent = 'Error generating policy: ' + error.message;
            document.getElementById('policy-container').style.display = 'block';
          })
          .generateProposalPolicy(formData);
      }
    });

    document.getElementById('togglePolicyEditButton').addEventListener('click', function() {
      const aiPolicyDiv = document.getElementById('ai-policy');
      const policyEditorTextarea = document.getElementById('policyEditor');
      const toggleButton = this;
      const promptInput = document.getElementById('prompt');

      if (isPolicyEditing) {
        currentPolicyData.policy = policyEditorTextarea.value;
        aiPolicyDiv.innerHTML = marked.parse(currentPolicyData.policy);
        aiPolicyDiv.style.display = 'block';
        policyEditorTextarea.style.display = 'none';
        toggleButton.textContent = 'Edit Policy';
        promptInput.readOnly = false;
      } else {
        if (!currentPolicyData || !currentPolicyData.policy) {
          alert('No policy to edit. Please generate a policy first.');
          return;
        }
        policyEditorTextarea.value = currentPolicyData.policy;
        aiPolicyDiv.style.display = 'none';
        policyEditorTextarea.style.display = 'block';
        toggleButton.textContent = 'Finish Editing';
        promptInput.readOnly = false;
        policyEditorTextarea.focus();
      }
      isPolicyEditing = !isPolicyEditing;
    });

    document.getElementById('acceptPolicyButton').addEventListener('click', function() {
      if (!currentPolicyData) {
        alert('No policy to accept. Please generate a policy first.');
        return;
      }

      const acceptPolicyButton = this;
      const generatePolicyButton = document.getElementById('generatePolicyButton');
      const cancelAiOperationButton = document.getElementById('cancelAiOperationButton');
      const proposalLoadingSpinner = document.getElementById('proposal-loading-spinner');
      const regeneratePolicyButton = document.getElementById('regeneratePolicyButton');
      const regenerateProposalButton = document.getElementById('regenerateProposalButton');
      const promptInput = document.getElementById('prompt');

      proposalLoadingSpinner.style.display = 'block';
      acceptPolicyButton.disabled = true;
      acceptPolicyButton.style.display = 'none';
      regeneratePolicyButton.style.display = 'none';
      regenerateProposalButton.style.display = 'none';
      cancelAiOperationButton.style.display = 'inline-block';
      promptInput.readOnly = true;
      
      document.getElementById('policyEditor').style.display = 'none';
      document.getElementById('togglePolicyEditButton').textContent = 'Edit Policy';
      isPolicyEditing = false;

      const formData = { scriptId: currentPolicyData.scriptId, prompt: currentPolicyData.userPrompt, policy: currentPolicyData.policy };

      const requestId = Date.now();
      activeRequestId = requestId;

      console.log('Generating code proposal...');
      google.script.run
        .withSuccessHandler(function(response) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale success response for processPrompt (after policy).');
            return;
          }
          activeRequestId = null;
          proposalLoadingSpinner.style.display = 'none';
          acceptPolicyButton.disabled = false;
          generatePolicyButton.style.display = 'inline-block';
          promptInput.readOnly = false;
          cancelAiOperationButton.style.display = 'none';

          if (response.status === 'proposal') {
            currentProposal = response; 
            document.getElementById('proposal-purpose').textContent = response.purpose || 'No description provided.';
            
            const htmlWarningsDiv = document.getElementById('html-validation-warnings');
            htmlWarningsDiv.innerHTML = ''; 
            let hasHtmlErrors = false;

            response.proposedFiles.forEach(file => {
                if (file.type === 'HTML') {
                    const validationResult = validateHtml(file.source, file.name);
                    if (!validationResult.isValid) {
                        hasHtmlErrors = true;
                        const warningP = document.createElement('p');
                        warningP.textContent = validationResult.message;
                        htmlWarningsDiv.appendChild(warningP);
                    }
                }
            });

            if (hasHtmlErrors) {
                htmlWarningsDiv.style.display = 'block';
            } else {
                htmlWarningsDiv.style.display = 'none';
            }

            displayFileComparison(response.originalFiles, response.proposedFiles);
            document.getElementById('proposal-container').style.display = 'block';
            document.getElementById('applyChangesButton').style.display = 'block'; 
            regenerateProposalButton.style.display = 'inline-block'; 
          } else if (response.status === 'error') {
            document.getElementById('apply-result').textContent = 'Error: ' + response.message;
            document.getElementById('apply-result-container').style.display = 'block';
            document.getElementById('proposal-container').style.display = 'block'; 
          } else {
            document.getElementById('apply-result').textContent = 'Unexpected response status: ' + JSON.stringify(response);
            document.getElementById('apply-result-container').style.display = 'block';
            document.getElementById('proposal-container').style.display = 'block'; 
          }
        })
        .withFailureHandler(function(error) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale failure response for processPrompt (after policy).');
            return;
          }
          activeRequestId = null;
          proposalLoadingSpinner.style.display = 'none';
          acceptPolicyButton.disabled = false;
          generatePolicyButton.style.display = 'inline-block';
          promptInput.readOnly = false;
          cancelAiOperationButton.style.display = 'none';

          document.getElementById('apply-result').textContent = 'Error calling AI: ' + error.message;
          document.getElementById('apply-result-container').style.display = 'block';
          document.getElementById('proposal-container').style.display = 'block'; 
        })
        .processPrompt(formData);
    });

    document.getElementById('cancelAiOperationButton').addEventListener('click', function() {
      activeRequestId = null; 

      const generatePolicyButton = document.getElementById('generatePolicyButton');
      const cancelAiOperationButton = document.getElementById('cancelAiOperationButton');
      const policyLoadingSpinner = document.getElementById('policy-loading-spinner');
      const proposalLoadingSpinner = document.getElementById('proposal-loading-spinner');
      const policyContainer = document.getElementById('policy-container');
      const proposalContainer = document.getElementById('proposal-container');
      const acceptPolicyButton = document.getElementById('acceptPolicyButton');
      const regeneratePolicyButton = document.getElementById('regeneratePolicyButton');
      const regenerateProposalButton = document.getElementById('regenerateProposalButton');
      const applyChangesButton = document.getElementById('applyChangesButton');
      const applyResultContainer = document.getElementById('apply-result-container');
      const fixApplyErrorsButton = document.getElementById('fixApplyErrorsButton');
      const htmlWarningsDiv = document.getElementById('html-validation-warnings'); 
      const promptInput = document.getElementById('prompt');
      const policyEditorTextarea = document.getElementById('policyEditor');
      const togglePolicyEditButton = document.getElementById('togglePolicyEditButton');

      policyLoadingSpinner.style.display = 'none';
      proposalLoadingSpinner.style.display = 'none';
      generatePolicyButton.disabled = false;
      promptInput.readOnly = false;
      cancelAiOperationButton.style.display = 'none';

      currentPolicyData = null;
      currentProposal = null;
      document.getElementById('ai-policy').innerHTML = '';
      document.getElementById('proposal-purpose').textContent = '';
      document.getElementById('proposed-files-display').innerHTML = '';
      document.getElementById('apply-result').textContent = '';
      htmlWarningsDiv.style.display = 'none'; 
      htmlWarningsDiv.innerHTML = ''; 

      policyContainer.style.display = 'none';
      proposalContainer.style.display = 'none';
      acceptPolicyButton.style.display = 'none';
      regeneratePolicyButton.style.display = 'none';
      regenerateProposalButton.style.display = 'none';
      applyChangesButton.style.display = 'none';
      applyResultContainer.style.display = 'none';
      fixApplyErrorsButton.style.display = 'none';

      generatePolicyButton.style.display = 'inline-block'; 

      policyEditorTextarea.style.display = 'none';
      togglePolicyEditButton.textContent = 'Edit Policy';
      isPolicyEditing = false;

      alert('AI operation canceled by user.');
    });

    document.getElementById('regeneratePolicyButton').addEventListener('click', function() {
      const scriptId = getEffectiveScriptId();
      const promptText = document.getElementById('prompt').value;

      if (!scriptId) {
        alert('Please select or enter a Script ID.');
        return;
      }
      if (!promptText.trim()) {
        alert('Prompt cannot be empty.');
        return;
      }

      saveScriptIdToLocalStorage(scriptId);

      const policyLoadingSpinner = document.getElementById('policy-loading-spinner');
      const generatePolicyButton = document.getElementById('generatePolicyButton');
      const acceptPolicyButton = document.getElementById('acceptPolicyButton');
      const regeneratePolicyButton = this; 
      const cancelAiOperationButton = document.getElementById('cancelAiOperationButton');
      const policyContainer = document.getElementById('policy-container');
      const proposalContainer = document.getElementById('proposal-container');
      const applyChangesButton = document.getElementById('applyChangesButton');
      const regenerateProposalButton = document.getElementById('regenerateProposalButton');
      const applyResultContainer = document.getElementById('apply-result-container');
      const fixApplyErrorsButton = document.getElementById('fixApplyErrorsButton');
      const htmlWarningsDiv = document.getElementById('html-validation-warnings'); 
      const promptInput = document.getElementById('prompt');
      const policyEditorTextarea = document.getElementById('policyEditor');
      const togglePolicyEditButton = document.getElementById('togglePolicyEditButton');

      policyLoadingSpinner.style.display = 'block';
      generatePolicyButton.disabled = true; 
      acceptPolicyButton.disabled = true; 
      regeneratePolicyButton.disabled = true; 
      promptInput.readOnly = true; 
      cancelAiOperationButton.style.display = 'inline-block';

      policyContainer.style.display = 'none';
      proposalContainer.style.display = 'none';
      applyChangesButton.style.display = 'none';
      regenerateProposalButton.style.display = 'none';
      applyResultContainer.style.display = 'none';
      fixApplyErrorsButton.style.display = 'none';
      document.getElementById('proposed-files-display').innerHTML = '';
      document.getElementById('ai-policy').innerHTML = '';
      document.getElementById('proposal-purpose').textContent = '';
      htmlWarningsDiv.style.display = 'none'; 
      htmlWarningsDiv.innerHTML = ''; 
      policyEditorTextarea.style.display = 'none';
      togglePolicyEditButton.textContent = 'Edit Policy';
      isPolicyEditing = false;

      currentPolicyData = null;
      currentProposal = null;

      const formData = { scriptId: scriptId, prompt: promptText };

      const requestId = Date.now();
      activeRequestId = requestId;

      console.log('Regenerating policy...');
      google.script.run
        .withSuccessHandler(function(response) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale success response for regeneratePolicy.');
            return;
          }
          activeRequestId = null;
          policyLoadingSpinner.style.display = 'none';
          generatePolicyButton.disabled = false;
          acceptPolicyButton.disabled = false;
          regeneratePolicyButton.disabled = false;
          promptInput.readOnly = false;
          cancelAiOperationButton.style.display = 'none';

          if (response.status === 'policy') {
            currentPolicyData = response;
            document.getElementById('ai-policy').innerHTML = marked.parse(response.policy);
            policyContainer.style.display = 'block';
            acceptPolicyButton.style.display = 'inline-block';
            regeneratePolicyButton.style.display = 'inline-block'; 
            generatePolicyButton.style.display = 'none'; 
          } else if (response.status === 'error') {
            document.getElementById('ai-policy').textContent = 'Error: ' + response.message;
            policyContainer.style.display = 'block';
            generatePolicyButton.style.display = 'inline-block'; 
          }
        })
        .withFailureHandler(function(error) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale failure response for regeneratePolicy.');
            return;
          }
          activeRequestId = null;
          policyLoadingSpinner.style.display = 'none';
          generatePolicyButton.disabled = false;
          acceptPolicyButton.disabled = false;
          regeneratePolicyButton.disabled = false;
          promptInput.readOnly = false;
          cancelAiOperationButton.style.display = 'none';

          document.getElementById('ai-policy').textContent = 'Error regenerating policy: ' + error.message;
          policyContainer.style.display = 'block';
          generatePolicyButton.style.display = 'inline-block'; 
        })
        .generateProposalPolicy(formData);
    });

    document.getElementById('applyChangesButton').addEventListener('click', function() {
      if (!currentProposal) {
        document.getElementById('apply-result').textContent = 'Error: No proposal to apply.';
        document.getElementById('apply-result-container').style.display = 'block';
        return;
      }

      saveScriptIdToLocalStorage(currentProposal.scriptId);

      const applyButton = this;
      const applySpinner = document.getElementById('apply-loading-spinner');
      const applyResultText = document.getElementById('apply-result');
      const fixApplyErrorsButton = document.getElementById('fixApplyErrorsButton');
      const regenerateProposalButton = document.getElementById('regenerateProposalButton');
      const autoDeployChecked = document.getElementById('autoDeployAfterApply').checked;

      applyButton.disabled = true;
      fixApplyErrorsButton.style.display = 'none';
      regenerateProposalButton.disabled = true;
      applySpinner.style.display = 'block';
      applyResultText.textContent = 'Applying changes...';
      if (autoDeployChecked) {
          applyResultText.textContent += '\nAuto-deploying...';
      }
      document.getElementById('apply-result-container').style.display = 'block'; 

      google.script.run
        .withSuccessHandler(function(response) {
          applySpinner.style.display = 'none';
          applyButton.disabled = false;
          regenerateProposalButton.disabled = false;
          
          if (response.status === 'success') {
            let message = response.message;
            if (response.deploymentStatus) { 
              message += `<br><br><strong>Auto-deploy Result:</strong><br>`;
              if (response.deploymentStatus === 'success') {
                message += `Status: Success<br>Message: ${response.deploymentMessage}`;
                if (response.deploymentId) message += `<br>Deployment ID: ${response.deploymentId}`;
                if (response.webappUrl && response.webappUrl !== 'URL not found in response') {
                  message += `<br>Web App URL: <a href="${response.webappUrl}" target="_blank">${response.webappUrl}</a>`;
                } else if (response.webappUrl === 'URL not found in response') {
                  message += `<br>Web App URL: ${response.webappUrl}`;
                }
              }
            } else if (response.deploymentStatus === 'error') {
              message += `Status: Error<br>Message: ${response.deploymentMessage}`; 
            } else { 
              message += `Status: Not Executed<br>Message: ${response.deploymentMessage}`; 
            }
            applyResultText.innerHTML = message; 
            currentProposal = null; 
            document.getElementById('applyChangesButton').style.display = 'none';
            regenerateProposalButton.style.display = 'none'; 
            document.getElementById('proposed-files-display').innerHTML = '<p>Changes applied successfully. You can propose new changes or check logs.</p>';
            document.getElementById('html-validation-warnings').style.display = 'none'; 
            document.getElementById('html-validation-warnings').innerHTML = ''; 
            fixApplyErrorsButton.style.display = 'none';
          } else { 
            let errorMessage = response.message;
            if (response.fullErrorText) {
                errorMessage += '\nAPI Response: ' + response.fullErrorText;
            }
            else if (response.apiErrorDetails) {
                errorMessage += '\nAPI Details: ' + JSON.stringify(response.apiErrorDetails, null, 2);
            }
            applyResultText.textContent = errorMessage;
            fixApplyErrorsButton.style.display = 'block';
          }
        })
        .withFailureHandler(function(error) {
          applySpinner.style.display = 'none';
          applyButton.disabled = false;
          regenerateProposalButton.disabled = false;
          applyResultText.textContent = 'Error applying changes (Uncaught): ' + error.message;
          fixApplyErrorsButton.style.display = 'block';
        })
        .applyProposedChanges(currentProposal.scriptId, currentProposal.proposedFiles, autoDeployChecked, currentProposal.purpose);
    });

    document.getElementById('fixApplyErrorsButton').addEventListener('click', function() {
      const scriptId = getEffectiveScriptId();
      if (!scriptId) {
        document.getElementById('apply-result').textContent = 'Error: Script ID is required to fix errors.';
        document.getElementById('apply-result-container').style.display = 'block';
        return;
      }

      const fixButton = this; 
      const proposalLoadingSpinner = document.getElementById('proposal-loading-spinner'); 
      const proposalContainer = document.getElementById('proposal-container');
      const applyButton = document.getElementById('applyChangesButton');
      const applyResultContainer = document.getElementById('apply-result-container');
      const generatePolicyButton = document.getElementById('generatePolicyButton'); 
      const cancelFixErrorsButton = document.getElementById('cancelFixErrorsButton');
      const regenerateProposalButton = document.getElementById('regenerateProposalButton');
      const promptInput = document.getElementById('prompt');
      const htmlWarningsDiv = document.getElementById('html-validation-warnings'); 

      const requestId = Date.now();
      activeRequestId = requestId;

      fixButton.disabled = true;
      generatePolicyButton.disabled = true;
      promptInput.readOnly = true;
      cancelFixErrorsButton.style.display = 'inline-block';
      regenerateProposalButton.style.display = 'none'; 
      proposalLoadingSpinner.style.display = 'block';
      proposalContainer.style.display = 'none';
      applyButton.style.display = 'none';
      applyResultContainer.style.display = 'none';
      document.getElementById('proposed-files-display').innerHTML = '';
      htmlWarningsDiv.style.display = 'none'; 
      htmlWarningsDiv.innerHTML = ''; 

      saveScriptIdToLocalStorage(scriptId);

      google.script.run
        .withSuccessHandler(function(response) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale success response for fixErrorsFromLogs.');
            return; 
          }
          activeRequestId = null;
          proposalLoadingSpinner.style.display = 'none';
          fixButton.disabled = false;
          generatePolicyButton.disabled = false; 
          promptInput.readOnly = false; 
          cancelFixErrorsButton.style.display = 'none';

          if (response.status === 'proposal') {
            currentProposal = response;
            document.getElementById('proposal-purpose').textContent = response.purpose || 'No description provided.';
            
            htmlWarningsDiv.innerHTML = ''; 
            let hasHtmlErrors = false;

            response.proposedFiles.forEach(file => {
                if (file.type === 'HTML') {
                    const validationResult = validateHtml(file.source, file.name);
                    if (!validationResult.isValid) {
                        hasHtmlErrors = true;
                        const warningP = document.createElement('p');
                        warningP.textContent = validationResult.message;
                        htmlWarningsDiv.appendChild(warningP);
                    }
                }
            });

            if (hasHtmlErrors) {
                htmlWarningsDiv.style.display = 'block';
            } else {
                htmlWarningsDiv.style.display = 'none';
            }

            displayFileComparison(response.originalFiles, response.proposedFiles);
            proposalContainer.style.display = 'block';
            applyButton.style.display = 'block';
            regenerateProposalButton.style.display = 'inline-block'; 
            fixButton.style.display = 'none'; 
          } else if (response.status === 'error') {
            document.getElementById('apply-result').textContent = 'Error: ' + response.message;
            applyResultContainer.style.display = 'block';
            proposalContainer.style.display = 'block';
          } else {
            document.getElementById('apply-result').textContent = 'Unexpected response status: ' + JSON.stringify(response);
            applyResultContainer.style.display = 'block';
            proposalContainer.style.display = 'block';
          }
        })
        .withFailureHandler(function(error) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale failure response for fixErrorsFromLogs.');
            return; 
          }
          activeRequestId = null;
          proposalLoadingSpinner.style.display = 'none';
          fixButton.disabled = false;
          generatePolicyButton.disabled = false; 
          promptInput.readOnly = false; 
          cancelFixErrorsButton.style.display = 'none';

          document.getElementById('apply-result').textContent = 'Error calling AI for fix: ' + error.message;
          document.getElementById('apply-result-container').style.display = 'block';
          document.getElementById('proposal-container').style.display = 'block';
        })
        .fixErrorsFromLogs(scriptId);
    });

    document.getElementById('fix-errors-form').addEventListener('submit', function(e) {
      e.preventDefault();

      const scriptId = getEffectiveScriptId();
      if (!scriptId) {
        document.getElementById('apply-result').textContent = 'Error: Script ID is required to fix errors.';
        document.getElementById('apply-result-container').style.display = 'block';
        return;
      }

      const fixErrorsButton = document.getElementById('fixErrorsButton');
      const cancelFixErrorsButton = document.getElementById('cancelFixErrorsButton');
      const proposalLoadingSpinner = document.getElementById('proposal-loading-spinner');
      const proposalContainer = document.getElementById('proposal-container');
      const applyButton = document.getElementById('applyChangesButton');
      const applyResultContainer = document.getElementById('apply-result-container');
      const fixApplyErrorsButton = document.getElementById('fixApplyErrorsButton');
      const generatePolicyButton = document.getElementById('generatePolicyButton');
      const regenerateProposalButton = document.getElementById('regenerateProposalButton');
      const promptInput = document.getElementById('prompt');
      const htmlWarningsDiv = document.getElementById('html-validation-warnings');

      const requestId = Date.now();
      activeRequestId = requestId;

      fixErrorsButton.disabled = true;
      generatePolicyButton.disabled = true;
      promptInput.readOnly = true; 
      cancelFixErrorsButton.style.display = 'inline-block';
      regenerateProposalButton.style.display = 'none'; 
      proposalLoadingSpinner.style.display = 'block';
      proposalContainer.style.display = 'none';
      applyButton.style.display = 'none';
      applyResultContainer.style.display = 'none';
      fixApplyErrorsButton.style.display = 'none';
      document.getElementById('proposed-files-display').innerHTML = '';
      document.getElementById('proposal-purpose').textContent = '';
      document.getElementById('apply-result').textContent = '';
      htmlWarningsDiv.style.display = 'none';
      htmlWarningsDiv.innerHTML = '';

      saveScriptIdToLocalStorage(scriptId);

      google.script.run
        .withSuccessHandler(function(response) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale success response for fixErrorsFromLogs (via form submit).');
            return; 
          }
          activeRequestId = null;
          proposalLoadingSpinner.style.display = 'none';
          fixErrorsButton.disabled = false;
          generatePolicyButton.disabled = false; 
          promptInput.readOnly = false; 
          cancelFixErrorsButton.style.display = 'none';

          if (response.status === 'proposal') {
            currentProposal = response;
            document.getElementById('proposal-purpose').textContent = response.purpose || 'No description provided.';
            
            htmlWarningsDiv.innerHTML = '';
            let hasHtmlErrors = false;

            response.proposedFiles.forEach(file => {
                if (file.type === 'HTML') {
                    const validationResult = validateHtml(file.source, file.name);
                    if (!validationResult.isValid) {
                        hasHtmlErrors = true;
                        const warningP = document.createElement('p');
                        warningP.textContent = validationResult.message;
                        htmlWarningsDiv.appendChild(warningP);
                    }
                }
            });

            if (hasHtmlErrors) {
                htmlWarningsDiv.style.display = 'block';
            } else {
                htmlWarningsDiv.style.display = 'none';
            }

            displayFileComparison(response.originalFiles, response.proposedFiles);
            proposalContainer.style.display = 'block';
            applyButton.style.display = 'block';
            regenerateProposalButton.style.display = 'inline-block'; 
            fixApplyErrorsButton.style.display = 'none'; 
          } else if (response.status === 'error') {
            document.getElementById('apply-result').textContent = 'Error: ' + response.message;
            applyResultContainer.style.display = 'block';
            proposalContainer.style.display = 'block';
          } else {
            document.getElementById('apply-result').textContent = 'Unexpected response status: ' + JSON.stringify(response);
            applyResultContainer.style.display = 'block';
            proposalContainer.style.display = 'block';
          }
        })
        .withFailureHandler(function(error) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale failure response for fixErrorsFromLogs (via form submit).');
            return; 
          }
          activeRequestId = null;
          proposalLoadingSpinner.style.display = 'none';
          fixErrorsButton.disabled = false;
          generatePolicyButton.disabled = false; 
          promptInput.readOnly = false; 
          cancelFixErrorsButton.style.display = 'none';

          document.getElementById('apply-result').textContent = 'Error calling AI for fix: ' + error.message;
          document.getElementById('apply-result-container').style.display = 'block';
          document.getElementById('proposal-container').style.display = 'block';
        })
        .fixErrorsFromLogs(scriptId);
    });

    document.getElementById('cancelFixErrorsButton').addEventListener('click', function() {
      activeRequestId = null; 

      const fixErrorsButton = document.getElementById('fixErrorsButton');
      const cancelFixErrorsButton = document.getElementById('cancelFixErrorsButton');
      const proposalLoadingSpinner = document.getElementById('proposal-loading-spinner');
      const proposalContainer = document.getElementById('proposal-container');
      const applyButton = document.getElementById('applyChangesButton');
      const applyResultContainer = document.getElementById('apply-result-container');
      const fixApplyErrorsButton = document.getElementById('fixApplyErrorsButton');
      const generatePolicyButton = document.getElementById('generatePolicyButton'); 
      const regenerateProposalButton = document.getElementById('regenerateProposalButton');
      const promptInput = document.getElementById('prompt');
      const htmlWarningsDiv = document.getElementById('html-validation-warnings'); 

      proposalLoadingSpinner.style.display = 'none';
      fixErrorsButton.disabled = false;
      generatePolicyButton.disabled = false; 
      promptInput.readOnly = false; 
      cancelFixErrorsButton.style.display = 'none';
      regenerateProposalButton.style.display = 'none'; 
      
      currentProposal = null; 
      document.getElementById('proposal-purpose').textContent = '';
      document.getElementById('proposed-files-display').innerHTML = '<p>AI error fix canceled by user.</p>';
      htmlWarningsDiv.style.display = 'none'; 
      htmlWarningsDiv.innerHTML = ''; 
      proposalContainer.style.display = 'block'; 
      applyButton.style.display = 'none';
      applyResultContainer.style.display = 'none';
      fixApplyErrorsButton.style.display = 'none';
    });

    document.getElementById('regenerateProposalButton').addEventListener('click', function() {
      if (!currentPolicyData || !currentPolicyData.scriptId || !currentPolicyData.userPrompt || !currentPolicyData.policy) {
        alert('Cannot regenerate proposal. Policy data is missing.');
        return;
      }

      const scriptId = currentPolicyData.scriptId;
      const promptText = currentPolicyData.userPrompt;
      const policyText = currentPolicyData.policy;

      const regenerateButton = this;
      const proposalLoadingSpinner = document.getElementById('proposal-loading-spinner'); 
      const cancelAiOperationButton = document.getElementById('cancelAiOperationButton');
      const proposalContainer = document.getElementById('proposal-container');
      const applyChangesButton = document.getElementById('applyChangesButton');
      const applyResultContainer = document.getElementById('apply-result-container');
      const fixApplyErrorsButton = document.getElementById('fixApplyErrorsButton');
      const htmlWarningsDiv = document.getElementById('html-validation-warnings'); 
      const promptInput = document.getElementById('prompt');

      proposalLoadingSpinner.style.display = 'block';
      regenerateButton.disabled = true; 
      applyChangesButton.disabled = true; 
      promptInput.readOnly = true; 
      cancelAiOperationButton.style.display = 'inline-block';

      proposalContainer.style.display = 'none';
      applyChangesButton.style.display = 'none';
      applyResultContainer.style.display = 'none';
      fixApplyErrorsButton.style.display = 'none';
      document.getElementById('proposed-files-display').innerHTML = '';
      document.getElementById('proposal-purpose').textContent = '';
      document.getElementById('apply-result').textContent = '';
      htmlWarningsDiv.style.display = 'none'; 
      htmlWarningsDiv.innerHTML = ''; 

      currentProposal = null; 

      const formData = { scriptId: scriptId, prompt: promptText, policy: policyText };

      const requestId = Date.now();
      activeRequestId = requestId;

      console.log('Regenerating AI proposed changes...');
      google.script.run
        .withSuccessHandler(function(response) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale success response for regenerateProposal.');
            return;
          }
          activeRequestId = null;
          proposalLoadingSpinner.style.display = 'none';
          regenerateButton.disabled = false;
          applyChangesButton.disabled = false;
          promptInput.readOnly = false; 
          cancelAiOperationButton.style.display = 'none';

          if (response.status === 'proposal') {
            currentProposal = response;
            document.getElementById('proposal-purpose').textContent = response.purpose || 'No description provided.';
            
            htmlWarningsDiv.innerHTML = ''; 
            let hasHtmlErrors = false;

            response.proposedFiles.forEach(file => {
                if (file.type === 'HTML') {
                    const validationResult = validateHtml(file.source, file.name);
                    if (!validationResult.isValid) {
                        hasHtmlErrors = true;
                        const warningP = document.createElement('p');
                        warningP.textContent = validationResult.message;
                        htmlWarningsDiv.appendChild(warningP);
                    }
                }
            });

            if (hasHtmlErrors) {
                htmlWarningsDiv.style.display = 'block';
            }
            else {
                htmlWarningsDiv.style.display = 'none';
            }

            displayFileComparison(response.originalFiles, response.proposedFiles);
            proposalContainer.style.display = 'block';
            applyChangesButton.style.display = 'block';
            regenerateButton.style.display = 'inline-block'; 
          } else if (response.status === 'error') {
            document.getElementById('apply-result').textContent = 'Error: ' + response.message;
            applyResultContainer.style.display = 'block';
            proposalContainer.style.display = 'block'; 
            regenerateButton.style.display = 'inline-block'; 
          } else {
            document.getElementById('apply-result').textContent = 'Unexpected response status: ' + JSON.stringify(response);
            applyResultContainer.style.display = 'block';
            proposalContainer.style.display = 'block'; 
            regenerateButton.style.display = 'inline-block'; 
          }
        })
        .withFailureHandler(function(error) {
          if (activeRequestId !== requestId) {
            console.log('Ignoring stale failure response for regenerateProposal.');
            return;
          }
          activeRequestId = null;
          proposalLoadingSpinner.style.display = 'none';
          regenerateButton.disabled = false;
          applyChangesButton.disabled = false;
          promptInput.readOnly = false; 
          cancelAiOperationButton.style.display = 'none';

          document.getElementById('apply-result').textContent = 'Error regenerating proposal: ' + error.message;
          applyResultContainer.style.display = 'block';
          proposalContainer.style.display = 'block'; 
          regenerateButton.style.display = 'inline-block'; 
        })
        .processPrompt(formData);
    });

    document.getElementById('saveGcpProjectIdButton').addEventListener('click', function() {
      const gcpProjectIdInput = document.getElementById('gcpProjectId');
      const gcpProjectId = gcpProjectIdInput.value.trim();
      const saveResultContainer = document.getElementById('gcp-save-result-container');
      const saveResultText = document.getElementById('gcp-save-result');

      saveResultContainer.style.display = 'block';
      saveResultText.textContent = 'Saving...';

      if (!gcpProjectId) {
        saveResultText.textContent = 'Error: GCP Project ID cannot be empty.';
        return;
      }

      google.script.run
        .withSuccessHandler(function(response) {
          saveResultText.textContent = response.message;
          if (response.status === 'success') {
            saveGcpProjectIdToLocalStorage(gcpProjectId);
          }
        })
        .withFailureHandler(function(error) {
          saveResultText.textContent = 'Error saving GCP Project ID: ' + error.message;
        })
        .setGcpProjectId(gcpProjectId);
    });

    document.getElementById('log-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = this;
      const submitButton = form.querySelector('#getLogsButton');
      const spinner = document.getElementById('log-loading-spinner');

      submitButton.disabled = true;
      spinner.style.display = 'block';

      const scriptId = getEffectiveScriptId();

      saveScriptIdToLocalStorage(scriptId);

      google.script.run
        .withSuccessHandler(function(response) {
          document.getElementById('log-result').textContent = response;
          document.getElementById('log-result-container').style.display = 'block';
          submitButton.disabled = false;
          spinner.style.display = 'none';
        })
        .withFailureHandler(function(error) {
          document.getElementById('log-result').textContent = 'Error: ' + error.message;
          document.getElementById('log-result-container').style.display = 'block';
          submitButton.disabled = false;
          spinner.style.display = 'none';
        })
        .getScriptLogs(scriptId);
    });

    document.getElementById('deploy-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = this;
      const submitButton = form.querySelector('#deployButton');
      const spinner = document.getElementById('deploy-loading-spinner');
      const resultContainer = document.getElementById('deploy-result-container');
      const resultText = document.getElementById('deploy-result');

      submitButton.disabled = true;
      spinner.style.display = 'block';
      resultContainer.style.display = 'none';
      resultText.textContent = '';

      const scriptId = getEffectiveScriptId();
      const description = document.getElementById('deploymentDescription').value;

      saveScriptIdToLocalStorage(scriptId);

      google.script.run
        .withSuccessHandler(function(response) {
          spinner.style.display = 'none';
          submitButton.disabled = false;
          resultContainer.style.display = 'block';
          if (response.status === 'success') {
            let webappUrlHtml = `Web App URL: ${response.webappUrl}`;
            if (response.webappUrl && response.webappUrl !== 'URL not found in response') {
              webappUrlHtml = `Web App URL: <a href="${response.webappUrl}" target="_blank">${response.webappUrl}</a>`;
            }
            resultText.innerHTML = `${response.message}<br>Deployment ID: ${response.deploymentId}<br>${webappUrlHtml}`;
          } else {
            resultText.textContent = `Error: ${response.message}`;
          }
        })
        .withFailureHandler(function(error) {
          spinner.style.display = 'none';
          submitButton.disabled = false;
          resultContainer.style.display = 'block';
          resultText.textContent = `Error deploying script: ${error.message}`;
        })
        .deployScript(scriptId, description);
    });

    document.getElementById('add-library-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = this;
      const submitButton = form.querySelector('#addLibraryButton');
      const spinner = document.getElementById('add-library-loading-spinner');
      const resultContainer = document.getElementById('add-library-result-container');
      const resultText = document.getElementById('add-library-result');

      submitButton.disabled = true;
      spinner.style.display = 'block';
      resultContainer.style.display = 'none';
      resultText.textContent = '';

      const targetScriptId = getEffectiveScriptId();
      const libraryScriptId = document.getElementById('libraryScriptId').value.trim();
      const libraryVersion = document.getElementById('libraryVersion').value.trim(); 

      if (!targetScriptId) {
        resultText.textContent = 'Error: Please select or enter a Target Script ID.';
        resultContainer.style.display = 'block';
        submitButton.disabled = false;
        spinner.style.display = 'none';
        return;
      }
      if (!libraryScriptId) {
        resultText.textContent = 'Error: Library Script ID cannot be empty.';
        resultContainer.style.display = 'block';
        submitButton.disabled = false;
        spinner.style.display = 'none';
        return;
      }

      saveScriptIdToLocalStorage(targetScriptId);

      google.script.run
        .withSuccessHandler(function(response) {
          spinner.style.display = 'none';
          submitButton.disabled = false;
          resultContainer.style.display = 'block';
          if (response.status === 'success') {
            resultText.textContent = response.message;
            document.getElementById('libraryScriptId').value = '';
            document.getElementById('libraryVersion').value = '';
          } else {
            resultText.textContent = `Error: ${response.message}`;
          }
        })
        .withFailureHandler(function(error) {
          spinner.style.display = 'none';
          submitButton.disabled = false;
          resultContainer.style.display = 'block';
          resultText.textContent = `Error adding library: ${error.message}`;
        })
        .addLibraryToProject(targetScriptId, libraryScriptId, effectiveVersion);
    });

    document.getElementById('getVersionsButton').addEventListener('click', function() {
      const scriptId = getEffectiveScriptId();
      const versionsSelect = document.getElementById('versionSelect');
      const getVersionsButton = this;
      const revertVersionButton = document.getElementById('revertVersionButton');
      const versionLoadingSpinner = document.getElementById('version-loading-spinner');
      const versionResultContainer = document.getElementById('version-result-container');
      const versionResultText = document.getElementById('version-result');

      versionsSelect.innerHTML = '<option value="">-- Loading versions --</option>'; 
      versionsSelect.disabled = true;
      getVersionsButton.disabled = true;
      revertVersionButton.disabled = true;
      versionLoadingSpinner.style.display = 'block';
      versionResultContainer.style.display = 'none'; 

      if (!scriptId) {
        versionsSelect.innerHTML = '<option value="">-- Select a Script ID first --</option>';
        versionResultText.textContent = 'Error: Please select or enter a Script ID to get versions.';
        versionResultContainer.style.display = 'block';
        versionsSelect.disabled = false;
        getVersionsButton.disabled = false;
        versionLoadingSpinner.style.display = 'none';
        return;
      }

      saveScriptIdToLocalStorage(scriptId); 

      google.script.run
        .withSuccessHandler(function(response) {
          versionLoadingSpinner.style.display = 'none';
          getVersionsButton.disabled = false;
          versionsSelect.disabled = false;
          revertVersionButton.disabled = false; 

          if (response.status === 'success') {
            versionsSelect.innerHTML = '<option value="">-- Select a version --</option>'; 
            if (response.versions && response.versions.length > 0) {
              response.versions.forEach(version => {
                const option = document.createElement('option');
                option.value = version.versionNumber;
                option.textContent = `Version ${version.versionNumber} (Created: ${new Date(version.createTime).toLocaleString()}) - ${version.description}`;
                versionsSelect.appendChild(option);
              });
              versionResultText.textContent = `Versions found: ${response.versions.length} items`;
            } else {
              versionsSelect.innerHTML = '<option value="">-- No versions found --</option>';
              versionResultText.textContent = response.message;
              revertVersionButton.disabled = true; 
            }
          } else {
            versionsSelect.innerHTML = '<option value="">-- Error loading versions --</option>';
            versionResultText.textContent = `Error: ${response.message}`;
            revertVersionButton.disabled = true; 
          }
          versionResultContainer.style.display = 'block';
        })
        .withFailureHandler(function(error) {
          versionLoadingSpinner.style.display = 'none';
          getVersionsButton.disabled = false;
          versionsSelect.disabled = false;
          revertVersionButton.disabled = true;
          versionsSelect.innerHTML = '<option value="">-- Error loading versions --</option>';
          versionResultText.textContent = `Error getting versions: ${error.message}`;
          versionResultContainer.style.display = 'block';
        })
        .listScriptVersions(scriptId);
    });

    document.getElementById('revertVersionButton').addEventListener('click', function() {
      const scriptId = getEffectiveScriptId();
      const versionSelect = document.getElementById('versionSelect');
      const selectedVersion = versionSelect.value;
      const revertButton = this;
      const getVersionsButton = document.getElementById('getVersionsButton');
      const versionLoadingSpinner = document.getElementById('version-loading-spinner');
      const versionResultContainer = document.getElementById('version-result-container');
      const versionResultText = document.getElementById('version-result');

      if (!scriptId) {
        versionResultText.textContent = 'Error: Please select or enter a Script ID.';
        versionResultContainer.style.display = 'block';
        return;
      }
      if (!selectedVersion) {
        versionResultText.textContent = 'Error: Please select a version to revert to.';
        versionResultContainer.style.display = 'block';
        return;
      }

      if (!confirm(`Reverting script ID ${scriptId} to version ${selectedVersion}. This cannot be undone. Do you wish to continue?`)) {
        return;
      }

      revertButton.disabled = true;
      getVersionsButton.disabled = true;
      versionSelect.disabled = true;
      versionLoadingSpinner.style.display = 'block';
      versionResultContainer.style.display = 'block'; 
      versionResultText.textContent = `Reverting script to version ${selectedVersion}...`;

      saveScriptIdToLocalStorage(scriptId); 

      google.script.run
        .withSuccessHandler(function(response) {
          versionLoadingSpinner.style.display = 'none';
          revertButton.disabled = false;
          getVersionsButton.disabled = false;
          versionSelect.disabled = false;

          if (response.status === 'success') {
            versionResultText.textContent = response.message;
            versionSelect.innerHTML = '<option value="">-- Select a version --</option>';
            revertButton.disabled = true;
          }

          else {
            versionResultText.textContent = `Error: ${response.message}`;
          }
        })
        .withFailureHandler(function(error) {
          versionLoadingSpinner.style.display = 'none';
          revertButton.disabled = false;
          getVersionsButton.disabled = false;
          versionSelect.disabled = false;
          versionResultText.textContent = `Error reverting to version: ${error.message}`;
        })
        .revertToVersion(scriptId, parseInt(selectedVersion));
    });
  </script>
</body>
</html>