<script>
    // 2. UI Helper Functions
    const UI = {
        /**
         * Get and cache a DOM element by ID.
         * @param {string} id - The ID of the element.
         * @returns {HTMLElement} The DOM element.
         */
        get: (id) => {
            if (!AppState.domElements[id]) {
                AppState.domElements[id] = document.getElementById(id);
                // Optionally log if element is not found during initial get
                if (!AppState.domElements[id]) {
                    console.warn(`UI.get: Element with ID "${id}" not found.`);
                }
            }
            return AppState.domElements[id];
        },

        /**
         * Show a DOM element.
         * @param {string|HTMLElement} elementOrId - The ID of the element or the element itself.
         */
        show: (elementOrId) => {
            const element = typeof elementOrId === 'string' ? UI.get(elementOrId) : elementOrId;
            if (element) {
                element.style.display = 'block';
            }
        },

        /**
         * Hide a DOM element.
         * @param {string|HTMLElement} elementOrId - The ID of the element or the element itself.
         */
        hide: (elementOrId) => {
            const element = typeof elementOrId === 'string' ? UI.get(elementOrId) : elementOrId;
            if (element) {
                element.style.display = 'none';
            }
        },

        /**
         * Enable a DOM element.
         * @param {string|HTMLElement} elementOrId - The ID of the element or the element itself.
         */
        enable: (elementOrId) => {
            const element = typeof elementOrId === 'string' ? UI.get(elementOrId) : elementOrId;
            if (element) {
                element.disabled = false;
            }
        },

        /**
         * Disable a DOM element.
         * @param {string|HTMLElement} elementOrId - The ID of the element or the element itself.
         */
        disable: (elementOrId) => {
            const element = typeof elementOrId === 'string' ? UI.get(elementOrId) : elementOrId;
            if (element) {
                element.disabled = true;
            }
        },

        /**
         * Shows a loading spinner directly within the button.
         * Stores the button's original content and disables it.
         * @param {HTMLElement} buttonElement - The button element to modify.
         * @param {string} [loadingText="Loading..."] - Optional text to display next to the spinner.
         */
        showSpinnerInButton: (buttonElement, loadingText = "Loading...") => {
            if (!buttonElement) return;
            AppState.originalButtonContents.set(buttonElement.id, buttonElement.innerHTML);
            buttonElement.innerHTML = `<span class="spinner button-spinner"></span> ${loadingText}`;
            buttonElement.disabled = true;
            buttonElement.classList.add('is-loading-button');
        },

        /**
         * Hides the loading spinner and restores the button's original content and state.
         * @param {HTMLElement} buttonElement - The button element to restore.
         */
        hideSpinnerInButton: (buttonElement) => {
            if (!buttonElement || !AppState.originalButtonContents.has(buttonElement.id)) return;
            buttonElement.innerHTML = AppState.originalButtonContents.get(buttonElement.id);
            buttonElement.disabled = false;
            buttonElement.classList.remove('is-loading-button');
            AppState.originalButtonContents.delete(buttonElement.id);
        },

        /**
         * Set innerHTML of a DOM element.
         * @param {string|HTMLElement} elementOrId - The ID of the element or the element itself.
         * @param {string} content - The HTML content.
         */
        setHtml: (elementOrId, content) => {
            const element = typeof elementOrId === 'string' ? UI.get(elementOrId) : elementOrId;
            if (element) {
                element.innerHTML = content;
            }
        },

        /**
         * Set textContent of a DOM element.
         * @param {string|HTMLElement} elementOrId - The ID of the element or the element itself.
         * @param {string} content - The text content.
         */
        setText: (elementOrId, content) => {
            const element = typeof elementOrId === 'string' ? UI.get(elementOrId) : elementOrId;
            if (element) {
                element.textContent = content;
            }
        },

        /**
         * Clear the value of a textarea or input.
         * @param {string|HTMLElement} elementOrId - The ID of the textarea/input or the element itself.
         */
        clearValue: (elementOrId) => {
            const element = typeof elementOrId === 'string' ? UI.get(elementOrId) : elementOrId;
            if (element) {
                element.value = '';
            }
        },

        /**
         * Append a notification message to a container.
         * @param {string|HTMLElement} containerOrId - The ID of the container or the container element itself to append to.
         * @param {string} type - The type of notification (e.g., 'is-danger', 'is-success', 'is-info', 'is-warning').
         * @param {string} message - The message to display.
         * @param {object} [details=null] - Optional detailed error object.
         */
        appendNotification: (containerOrId, type, message, details = null) => {
            const container = typeof containerOrId === 'string' ? UI.get(containerOrId) : containerOrId;
            if (!container) {
                console.warn(`UI.appendNotification: Container with ID or Element "${containerOrId}" not found. Cannot append notification.`);
                return;
            }
            const notificationDiv = document.createElement('div');
            notificationDiv.className = `notification ${type}`;
            let contentHtml = `<p><strong>${Utils.escapeHtml(message)}</strong></p>`;

            if (details) {
                let detailsString;
                try {
                    detailsString = JSON.stringify(details, Object.getOwnPropertyNames(details), 2);
                } catch (e) {
                    detailsString = String(details);
                }
                contentHtml += `<h4 class="mt-2">Details:</h4><pre class="has-text-danger-dark is-size-7 mt-1">${Utils.escapeHtml(detailsString)}</pre>`;
            }
            notificationDiv.innerHTML = contentHtml;
            container.appendChild(notificationDiv);
            UI.show(container);
        },

        /**
         * Clear all notifications from a container.
         * @param {string|HTMLElement} containerOrId - The ID of the container or the container element itself to clear.
         */
        clearNotifications: (containerOrId) => {
            const element = typeof containerOrId === 'string' ? UI.get(containerOrId) : containerOrId;
            if (element) {
                element.innerHTML = '';
            }
            UI.hide(element);
        }
    };
</script>
